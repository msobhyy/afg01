<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap');
	body {
    	font-family: 'Cairo', 'Droid Arabic Kufi', 'Arabic Typesetting', sans-serif;
	}        
	/* Ensure the app takes full height */
        #root {
            min-height: 100vh;
        }
        /* Custom styles for pagination buttons */
        .pagination-button {
            @apply px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md;
        }
        .pagination-button.active {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .pagination-button.inactive {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .pagination-button:disabled {
            @apply opacity-50 cursor-not-allowed;
        }
        /* Styles for larger payment method icons */
        .payment-method-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        /* Approved Flash Animation */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-30px);
            }
            60% {
                transform: translateY(-15px);
            }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .darkgreen-700 {
            color: #15803d; /* A darker shade of green */
        }
        .darkgreen-800 {
            color: #166534; /* Even darker green */
        }

        /* Supervisor Dashboard specific styles from original wo_4.html cloning */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 15px;
            padding: 10px;
            background-color: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .selection-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s, filter 0.3s ease;
        }
        .selection-card:hover {
            transform: translateY(-3px);
            border-color: #a3d9ff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .selection-card.selected {
            border: 3px solid #007bff;
            box-shadow: 0 0 12px rgba(0, 123, 255, 0.4);
            background-color: #e6f2ff;
            transform: scale(1.05); /* Slightly enlarged when selected */
            z-index: 10;
        }
        .selection-card img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid #ddd;
        }
        .selection-card p {
            margin: 0;
            font-size: 0.85em;
            font-weight: 600;
            color: #444;
            word-wrap: break-word;
        }
        .selection-card.payment-method-card { /* Renamed to avoid conflict with general .payment-method */
            padding: 20px 12px;
            font-size: 0.95em;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .selection-card.payment-method-card .payment-method-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            border: none;
        }

        /* Calculator Styles */
        .calculator-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .calculator {
            background-color: #283a4c; /* Modern dark blue-gray */
            border-radius: 20px; /* More rounded */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6); /* More prominent shadow */
            width: 90%;
            max-width: 320px;
            padding: 25px; /* Slightly more padding */
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 2px solid #3d566e; /* Darker border */
        }
        .calculator-display {
            background-color: #20bbd2; /* Light gray-blue */
            color: #283a4c; /* Match calculator background */
            font-size: 2.5em; /* Larger font */
            padding: 15px 20px;
            border-radius: 12px; /* More rounded */
            text-align: right;
            margin-bottom: 10px;
            overflow: hidden;
            white-space: nowrap;
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.3); /* Deeper inset shadow */
            height: 60px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-weight: bold;
        }
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Changed to 3 columns for numpad */
            gap: 12px; /* Slightly larger gap */
        }
        .calc-button {
            background-color: hsl(32, 100%, 50%); /* Slightly lighter blue-gray */
            color: rgb(16, 46, 180);
            padding: 22px;
            font-size: 1.6em; /* Slightly larger font */
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Softer shadow */
        }
        .calc-button:active {
            transform: translateY(2px); /* More pronounced press effect */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .calc-button:hover {
            background-color: #55728a; /* Lighter hover effect */
        }
        .calc-button.action {
            background-color: #ff7f50; /* Coral/Orange for clear/back */
        }
        .calc-button.action:hover {
            background-color: #ff6347; /* Darker coral on hover */
        }
        /* Styles for bottom action buttons */
        .calc-bottom-actions {
            display: flex;
            gap: 12px; /* Match other gaps */
            justify-content: space-between;
            margin-top: 10px;
        }
        .calc-bottom-actions .calc-button {
            flex-grow: 1;
            padding: 18px; /* Adjust padding for these buttons */
            font-size: 1.4em; /* Adjust font size */
        }
        .calc-bottom-actions .calc-button.cancel {
            background-color: #f44336; /* Medium Red for cancel */
        }
        .calc-bottom-actions .calc-button.cancel:hover {
            background-color: #d32f2f; /* Darker red on hover */
        }
        .calc-bottom-actions .calc-button.done {
            background-color: #4CAF50; /* Medium Green for done */
        }
        .calc-bottom-actions .calc-button.done:hover {
            background-color: #388E3C; /* Darker green on hover */
        }

        /* New flash effect for amount input */
        @keyframes flashEffect {
            0% { background-color: #d4edda; } /* Success green */
            50% { background-color: #e6f2ff; } /* Light blue, subtle flash */
            100% { background-color: #d4edda; }
        }

        .flash-success {
            animation: flashEffect 0.5s ease-in-out 2; /* Flash twice over 1 second total, original behavior */
        }

        /* New flash border effect for steps */
        @keyframes flashBorderGreen {
            0%, 100% { box-shadow: 0 0 0 0px rgba(0, 128, 0, 0); border-color: transparent; }
            50% { box-shadow: 0 0 0 6px rgba(0, 128, 0, 0.6); border-color: #008000; } /* More prominent flash */
        }

        .flash-border-green {
            animation: flashBorderGreen 2.5s ease-in-out 2; /* Flash twice over 5 seconds */
        }

        /* Employee Details Section */
        .employee-details-section {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .employee-details-section h3 {
            margin-top: 0;
            color: #007bff;
            text-align: center;
            font-size: 1.2em;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .employee-details-section .detail-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            color: #555;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e9ecef;
        }
        .employee-details-section .detail-item:last-child {
             border-bottom: none;
        }
        .employee-details-section .detail-item strong {
            color: #333;
        }
        .employee-details-section .detail-item.total {
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
            margin-top: 10px;
            border-top: 2px solid #28a745;
            padding-top: 10px;
        }
        .employee-details-section .recent-payments-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
            padding: 0;
        }
        .employee-details-section .recent-payments-list table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }
        .employee-details-section .recent-payments-list th,
        .employee-details-section .recent-payments-list td {
            padding: 8px;
            font-size: 0.8em;
            border: 1px solid #e9ecef;
        }
        .employee-details-section .recent-payments-list th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }
        .employee-details-section .recent-payments-list tr:nth-child(even) {
            background-color: #fcfdfe;
        }
        .employee-details-section .recent-payments-list .no-data {
            padding: 10px;
            text-align: center;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .selection-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            .selection-card img {
                width: 60px;
                height: 60px;
            }
            .selection-card p {
                font-size: 0.8em;
            }
            .selection-card.payment-method-card {
                padding: 15px 8px;
                font-size: 0.85em;
            }
            .calculator-display {
                font-size: 2em;
                padding: 10px 15px;
                height: 50px;
            }
            .calc-button {
                padding: 18px;
                font-size: 1.4em;
            }
            .calc-bottom-actions .calc-button {
                padding: 15px;
                font-size: 1.2em;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Corrected: deleteField is from firestore, not auth
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, getDocs, where, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            updatePassword,
            deleteField, // Expose deleteField for removing simulatedPassword
            getFirestore,
            collection,
            query,
            onSnapshot,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            getDocs,
            where
        };
        // Expose PDF libraries globally
        window.html2canvas = html2canvas;
        window.jspdf = jspdf;
    </script>

    <script type="text/babel">
        // Destructure React hooks and components from the global React object
        const { useState, useEffect, createContext, useContext, useRef } = React;

        // Create a context for App data and simulated auth
        const AppContext = createContext(null);

        // Custom hook to use the AppContext
        const useAppContext = () => useContext(AppContext);

        // Translations Object
        const translations = {
          en: {
            appName: 'Shop App',
            welcome: 'Welcome,',
            userId: 'User ID:',
            logout: 'Logout',
            loginWelcome: 'Welcome! Please Log In',
            emailPlaceholder: 'Email or Employee ID',
            passwordPlaceholder: 'Password',
            loginButton: 'Login',
            loginError: 'Invalid email/employee ID or password.',
            admin: 'Admin',
            supervisor: 'Supervisor',
            employeeRole: 'Employee',
            manager: 'Manager',
            partner: 'Partner',
            branch: 'Branch',
            mainBranch: 'Main Branch',
            downtownStore: 'Downtown Store',
            allEmployees: 'All Employees',
            duplicateEntrySkipped: 'Skipping duplicate entry.',
            dailyBranchesSummary: 'Daily Branches Summary',
            monthlyBranchesIncome: 'Monthly Branches Income',
            organizationExpenses: 'Organization Expenses',
            totalOrganizationIncome: 'Total Organization Income',
            totalOrganizationExpenses: 'Total Organization Expenses',
            netOrganizationResult: 'Net Organization Result',
            managementTeamSalary: 'Management Team Salary',
            tools: 'Tools',
            equipment: 'Equipment',
            insurance: 'Insurance',
            violations: 'Violations',
            bankLoans: 'Bank Loans',
            internet: 'Internet',
            maintenance: 'Maintenance',
            newInstallations: 'New Installations',
            financing: 'Financing',
            date: 'Date',
            employee: 'Employee',
            branchName: 'Branch Name',
            totalEarned: 'Total Earned',
            cash: 'Cash',
            mada: 'Mada Pay',
            methods: 'Methods',
            total: 'Total',
            monthlyPaymentsSummary: 'Monthly Payments Summary',
            month: 'Month',
            year: 'Year',
            noDailyPaymentData: 'No daily payment data available.',
            noMonthlyPaymentData: 'No monthly payment data available.',
            branchManagement: 'Branch Management',
            addBranch: 'Add New Branch',
            name: 'Name',
            location: 'Location',
            actions: 'Actions',
            edit: 'Edit',
            delete: 'Delete',
            userManagement: 'User Management',
            addUser: 'Add New User',
            role: 'Role',
            target: 'Target',
            employeeNo: 'Employee No.',
            realtimePayments: 'Real-time Payments',
            serialNo: 'Serial No.',
            amount: 'Amount',
            method: 'Method',
            timestamp: 'Timestamp',
            addedBy: 'Added By',
            addBranchModalTitle: 'Add New Branch',
            branchNamePlaceholder: 'e.g., Downtown Store',
            branchLocationPlaceholder: 'e.g., 123 Main St, City',
            cancel: 'Cancel',
            saveChanges: 'Save Changes',
            editBranchModalTitle: 'Edit Branch',
            addUserModalTitle: 'Add New User',
            userNamePlaceholder: 'e.g., Jane Doe',
            userNameArPlaceholder: 'e.g., جنى محمد',
            userEmailPlaceholder: 'e.g., jane.doe@example.com',
            selectRole: 'Select Role',
            selectBranch: 'Select Branch',
            targetAmountSar: 'Target Amount (SAR)',
            employeeNumber: 'Employee Number',
            imageUrl: 'Image URL',
            editUserModalTitle: 'Edit User',
            editPaymentModalTitle: 'Edit Payment (Serial No:',
            paymentAmountSar: 'Amount (SAR)',
            paymentMethod: 'Payment Method',
            cash: 'Cash',
            visa: 'Visa',
            bankTransfer: 'Bank Transfer',
            masterCard: 'MasterCard',
            applePay: 'Apple Pay',
            madaPay: 'Mada Pay',
            supervisorDashboard: 'Supervisor Dashboard',
            addEmployeePayment: 'Add Employee Payment',
            selectEmployee: '1. Select Employee',
            noEmployeesInBranch: 'No employees in this branch.',
            selectPaymentMethod: '2. Select Payment Method for',
            enterAmount: '3. Enter Amount for',
            enterAmountPlaceholder: 'Enter amount',
            add: 'Add',
            recentPaymentsInBranch: 'Recent Payments in Your Branch',
            time: 'Time',
            employeeDashboard: 'Employee Dashboard',
            yourBranch: 'Your Branch',
            yourTarget: 'Your Target',
            remainingToTarget: 'Remaining to Target',
            yourPaymentsHistory: 'Your Payments History',
            yourExpensesHistory: 'Your Expenses History',
            yourBonusesHistory: 'Your Bonuses History',
            pleaseEnterBranchNameAndLocation: 'Please enter branch name and location.',
            branchAddedSuccessfully: 'Branch added successfully!',
            branchUpdatedSuccessfully: 'Branch updated successfully!',
            confirmDeleteBranch: 'Are you sure you want to delete this branch and all associated data?',
            branchDeletedSuccessfully: 'Branch deleted successfully!',
            pleaseFillAllUserFields: 'Please fill all user fields.',
            pleaseSelectBranchForSupervisorEmployee: 'Please select a branch for supervisor/employee.',
            userAddedSuccessfully: 'User added successfully!',
            userUpdatedSuccessfully: 'User updated successfully!',
            confirmDeleteUser: 'Are you sure you want to delete this user and all associated payments?',
            userDeletedSuccessfully: 'User deleted successfully!',
            pleaseFillAllPaymentFields: 'Please fill all payment fields correctly.',
            paymentUpdatedSuccessfully: 'Payment updated successfully!',
            noPaymentsToDownload: 'No payments to download.',
            paymentsDataDownloadedSuccessfully: 'Payments data downloaded successfully!',
            allDataBackedUpSuccessfully: 'All data backed up as JSON successfully!',
            pleaseEnterValidAmount: 'Please enter a valid amount.',
            amountEntryCancelled: 'Amount entry cancelled.',
            paymentAddedSuccessfully: 'Payment added successfully!',
            errorEmployeeOrPaymentMethodMissing: 'Error: Employee or payment method missing. Please restart the process.',
            downloadPaymentsXLSX: 'Download Payments (XLSX)',
            downloadAllDataXLSX: 'Download All Data (JSON Backup)',
            last5PaymentsFor: 'Last 5 Payments for',
            via: 'via',
            search: 'Search',
            sort: 'Sort by',
            newestToOldest: 'Newest to Oldest',
            oldestToNewest: 'Oldest to Newest',
            itemsPerPage: 'Items per page:',
            previous: 'Previous',
            next: 'Next',
            downloadFilteredXLSX: 'Download Filtered (XLSX)',
            all: 'All',
            selectBranchFilter: 'Select Branch',
            selectEmployeeFilter: 'Select Employee',
            selectPaymentMethodFilter: 'Select Payment Method',
            filter: 'Filter',
            clearFilters: 'Clear Filters',
            backToDashboard: 'Back to Dashboard',
            paymentMethodsManagement: 'Payment Methods Management',
            addPaymentMethod: 'Add New Payment Method',
            icon: 'Icon',
            color: 'Color',
            addPaymentMethodModalTitle: 'Add New Payment Method',
            editPaymentMethodModalTitle: 'Edit Payment Method',
            methodNamePlaceholder: 'e.g., Cash',
            methodNameArPlaceholder: 'e.g., نقدًا',
            methodIconPlaceholder: 'e.g., 💰',
            methodColorPlaceholder: 'e.g., #FF6F61',
            confirmDeletePaymentMethod: 'Are you sure you want to delete this payment method?',
            paymentMethodAddedSuccessfully: 'Payment method added successfully!',
            paymentMethodUpdatedSuccessfully: 'Payment method updated successfully!',
            paymentMethodDeletedSuccessfully: 'Payment method deleted successfully!',
            pleaseEnterMethodName: 'Please enter method name.',
            fromDate: 'From Date',
            toDate: 'To Date',
            filterByYear: 'Filter by Year',
            filterByMonth: 'Filter by Month',
            filterByDay: 'Filter by Day',
            selectYear: 'Select Year',
            selectMonth: 'Select Month',
            selectDay: 'Select Day',
            jan: 'January', feb: 'February', mar: 'March', apr: 'April', may: 'May', jun: 'June',
            jul: 'July', aug: 'August', sep: 'September', oct: 'October', nov: 'November', dec: 'December',
            changePassword: 'Change Password',
            enterNewPassword: 'Enter New Password',
            confirmNewPassword: 'Confirm New Password',
            passwordMismatch: 'Passwords do not match.',
            passwordChangedSuccessfully: 'Password changed successfully.',
            passwordChangeError: 'Error changing password.',
            employeeFinancials: 'Employee Financials',
            addExpense: 'Add Expense',
            editExpense: 'Edit Expense',
            deleteExpense: 'Delete Expense',
            addBonus: 'Add Bonus',
            editBonus: 'Edit Bonus',
            deleteBonus: 'Delete Bonus',
            selectEmployeeForFinancials: 'Select Employee',
            expenseType: 'Expense Type',
            expenseAmount: 'Expense Amount (SAR)',
            description: 'Description',
            bonusAmount: 'Bonus Amount (SAR)',
            rental: 'Rental',
            electricity: 'Electricity',
            bill: 'Bill',
            tickets: 'Tickets',
            internet: 'Internet',
            consumables: 'Consumables',
            penalties: 'Penalties',
            loans: 'Loans',
            totalExpenses: 'Total Expenses',
            totalBonuses: 'Total Bonuses',
            netIncome: 'Net Income',
            noExpenses: 'No expenses for this employee.',
            noBonuses: 'No bonuses for this employee.',
            pleaseSelectEmployee: 'Please select an employee.',
            pleaseEnterAllFields: 'Please fill all fields.',
            expenseAddedSuccessfully: 'Expense added successfully!',
            expenseUpdatedSuccessfully: 'Expense updated successfully!',
            expenseDeletedSuccessfully: 'Expense deleted successfully!',
            bonusAddedSuccessfully: 'Bonus added successfully!',
            bonusUpdatedSuccessfully: 'Bonus updated successfully!',
            bonusDeletedSuccessfully: 'Bonus deleted successfully!',
            downloadSampleExcel: 'Download Sample Excel',
            uploadExcel: 'Upload Excel',
            chooseExcelFile: 'Choose Excel File',
            excelUploadSuccess: 'Excel file uploaded and data processed successfully!',
            excelUploadError: 'Error processing Excel file.',
            invalidExcelFormat: 'Invalid Excel format. Please ensure correct columns: employeeNumber, type, amount, description, month, year.',
            selectMonthYear: 'Select Month/Year',
            noDataForSelectedPeriod: 'No data available for the selected month and year.',
            currentBalance: 'Current Balance',
            register: 'Register',
            forgotPassword: 'Forgot Password?',
            registerAdminTask: 'Registration request sent to admin. Please contact them for account activation.',
            forgotPasswordAdminTask: 'Password reset request sent to admin. Please contact them for assistance.',
            analyticsOverview: 'Analytics Overview',
            dailyEmployeeSummary: 'Daily Employee Summary',
            confirmDeleteExpense: 'Are you sure you want to delete this expense?',
            confirmDeleteBonus: 'Are you sure you want to delete this bonus?',
            selectTheme: 'Select Table Theme',
            defaultTheme: 'Default',
            stripedTheme: 'Striped',
            borderedTheme: 'Bordered',
            compactTheme: 'Compact',
            recordsPerPage: 'Records per page:',
            deleteSelected: 'Delete Selected',
            applyPaymentMethod: 'Apply Payment Method',
            selectPaymentMethodForSelected: 'Select payment method for selected payments',
            approved: 'Approved',
            passwordRequiredForNewUser: 'Password is required for new users.',
            passwordTooShort: 'Password must be at least 6 characters long.',
            invalidExcelFile: 'Please upload a valid Excel file (.xlsx or .xls).',
            processingUpload: 'Processing upload...',
            emptyExcelFile: 'The uploaded Excel file is empty or contains only headers.',
            nameRequired: 'Name is required.',
            employeeNoRequired: 'Employee number is required.',
            emailRequired: 'Email is required.',
            invalidEmailFormat: 'Invalid email format.',
            emailAlreadyExists: 'Email already exists.',
            employeeNoAlreadyExists: 'Employee number already exists.',
            invalidRole: 'Invalid role. Valid roles are:',
            invalidBranchName: 'Invalid branch name.',
            invalidTargetAmount: 'Invalid target amount.',
            importingUsers: 'Importing users...',
            usersImportedSuccessfully: 'Users imported successfully!',
            newUsersAdded: 'new users added',
            noNewUsersProcessed: 'No new users were processed from the file. It might contain only existing data.',
            uploadCompletedWithErrors: 'Upload completed with errors.',
            errorDeletingUsers: 'Error deleting users. Please try again.',
            errorReadingExcelFile: 'Error reading Excel file. Please ensure it\'s valid.',
            generalError: 'General Error',
            userTemplate: 'User Import Template',
            userTemplateFileName: 'user_import_template.xlsx',
            userTemplateDownloaded: 'User import template downloaded successfully!',
            confirmDeleteSelectedUsers: 'Are you sure you want to delete the selected users?',
            errorDownloadingTemplate: 'Error downloading user template.',
            filteredPaymentsExport: 'Filtered Payments Export',
            allDataBackup: 'ShopApp_All_Data_Backup',
            // NEW: PDF Report related translations
            employeeReportPdf: 'Employee_Monthly_Report',
            allEmployeesReportPdf: 'All_Employees_Monthly_Calculations',
            downloadEmployeeReport: 'Download My Monthly Report (PDF)',
            downloadAllEmployeesCalculations: 'Download All Employees Calculations (PDF)',
            reportFor: 'Report for',
            generatedOn: 'Generated On',
            employeeDetails: 'Employee Details',
            totalPayments: 'Total Payments',
            totalExpensesSummary: 'Total Expenses',
            totalBonusesSummary: 'Total Bonuses',
            netIncomeSummary: 'Net Income',
            reportTitle: 'Monthly Financial Report',
            employeeName: 'Employee Name',
            employeeNumber: 'Employee Number',
            branch: 'Branch',
            target: 'Target',
            paymentsSummary: 'Payments Summary',
            expensesSummary: 'Expenses Summary',
            bonusesSummary: 'Bonuses Summary',
            noDataForReport: 'No data available for this report for the selected period.',
          },
          ar: {
            appName: 'تطبيق المتجر',
            welcome: 'أهلاً بك،',
            userId: 'معرف المستخدم:',
            logout: 'تسجيل الخروج',
            loginWelcome: 'أهلاً بك! الرجاء تسجيل الدخول',
            emailPlaceholder: 'البريد الإلكتروني أو رقم الموظف',
            passwordPlaceholder: 'كلمة المرور',
            loginButton: 'تسجيل الدخول',
            loginError: 'بريد إلكتروني/رقم موظف أو كلمة مرور غير صحيحة.',
            admin: 'المشرف',
            supervisor: 'المشرف الفرعي',
            employeeRole: 'الموظف',
            manager: 'المدير', // NEW: Manager Role
            partner: 'الشريك', // NEW: Partner Role
            branch: 'الفرع',
            mainBranch: 'الفرع الرئيسي',
            downtownStore: 'متجر وسط المدينة',
            allEmployees: 'جميع الموظفين',
            duplicateEntrySkipped: 'تم تخطي الإدخال المكرر.',
            dailyBranchesSummary: 'ملخص الفروع اليومي',
            monthlyBranchesIncome: 'إيرادات الفروع الشهرية',
            organizationExpenses: 'مصروفات المنظمة',
            totalOrganizationIncome: 'إجمالي إيرادات المنظمة',
            totalOrganizationExpenses: 'إجمالي مصروفات المنظمة',
            netOrganizationResult: 'صافي نتيجة المنظمة',
            managementTeamSalary: 'رواتب فريق الإدارة',
            tools: 'أدوات',
            equipment: 'معدات',
            insurance: 'تأمين',
            violations: 'مخالفات',
            bankLoans: 'قروض بنكية',
            internet: 'إنترنت',
            maintenance: 'صيانة',
            newInstallations: 'تجهيزات جديدة',
            financing: 'تمويل',
            date: 'التاريخ',
            employee: 'الموظف',
            branchName: 'اسم الفرع',
            totalEarned: 'إجمالي المكتسب',
            cash: 'نقداً',
            mada: 'مدى باي',
            methods: 'الطرق',
            total: 'الإجمالي',
            monthlyPaymentsSummary: 'ملخص المدفوعات الشهرية',
            month: 'الشهر',
            year: 'السنة',
            noDailyPaymentData: 'لا توجد بيانات دفع يومية متاحة.',
            noMonthlyPaymentData: 'لا توجد بيانات دفع شهرية متاحة.',
            branchManagement: 'إدارة الفروع',
            addBranch: 'إضافة فرع جديد',
            name: 'الاسم',
            location: 'الموقع',
            actions: 'الإجراءات',
            edit: 'تعديل',
            delete: 'حذف',
            userManagement: 'إدارة المستخدمين',
            addUser: 'إضافة مستخدم جديد',
            role: 'الدور',
            target: 'الهدف',
            employeeNo: 'رقم الموظف',
            realtimePayments: 'المدفوعات في الوقت الفعلي',
            serialNo: 'الرقم التسلسلي',
            amount: 'المبلغ',
            method: 'طريقة الدفع',
            timestamp: 'التاريخ والوقت',
            addedBy: 'أضيفت بواسطة',
            addBranchModalTitle: 'إضافة فرع جديد',
            branchNamePlaceholder: 'مثال: متجر وسط المدينة',
            branchLocationPlaceholder: 'مثال: شارع الملك فهد، الرياض',
            cancel: 'إلغاء',
            saveChanges: 'حفظ التغييرات',
            editBranchModalTitle: 'تعديل الفرع',
            addUserModalTitle: 'إضافة مستخدم جديد',
            userNamePlaceholder: 'مثال: سارة محمد',
            userNameArPlaceholder: 'مثال: سارة محمد',
            userEmailPlaceholder: 'مثال: sara.mohamed@example.com',
            selectRole: 'اختر الدور',
            selectBranch: 'اختر الفرع',
            targetAmountSar: 'المبلغ المستهدف (ريال سعودي)',
            employeeNumber: 'رقم الموظف',
            imageUrl: 'رابط الصورة',
            editUserModalTitle: 'تعديل المستخدم',
            editPaymentModalTitle: 'تعديل الدفع (الرقم التسلسلي:',
            paymentAmountSar: 'المبلغ (ريال سعودي)',
            paymentMethod: 'طريقة الدفع',
            cash: 'نقداً',
            visa: 'فيزا',
            bankTransfer: 'تحويل بنكي',
            masterCard: 'ماستركارد',
            applePay: 'آبل باي',
            madaPay: 'مدى باي',
            supervisorDashboard: 'لوحة تحكم المشرف',
            addEmployeePayment: 'إضافة دفعة للموظف',
            selectEmployee: '1. اختر الموظف',
            noEmployeesInBranch: 'لا يوجد موظفون في هذا الفرع.',
            selectPaymentMethod: '2. اختر طريقة الدفع لـ',
            enterAmount: '3. أدخل المبلغ لـ',
            enterAmountPlaceholder: 'أدخل المبلغ',
            add: 'إضافة',
            recentPaymentsInBranch: 'المدفوعات الأخيرة في فرعك',
            time: 'الوقت',
            employeeDashboard: 'لوحة تحكم الموظف',
            yourBranch: 'فرعك',
            yourTarget: 'هدفك',
            remainingToTarget: 'المتبقي للهدف',
            yourPaymentsHistory: 'سجل مدفوعاتك',
            yourExpensesHistory: 'سجل مصروفاتك',
            yourBonusesHistory: 'سجل مكافآتك',
            pleaseEnterBranchNameAndLocation: 'الرجاء إدخال اسم الفرع والموقع.',
            branchAddedSuccessfully: 'تمت إضافة الفرع بنجاح!',
            branchUpdatedSuccessfully: 'تم تحديث الفرع بنجاح!',
            confirmDeleteBranch: 'هل أنت متأكد من رغبتك في حذف هذا الفرع وجميع البيانات المرتبطة به؟',
            branchDeletedSuccessfully: 'تم حذف الفرع بنجاح!',
            pleaseFillAllUserFields: 'الرجاء ملء جميع حقول المستخدم.',
            pleaseSelectBranchForSupervisorEmployee: 'الرجاء اختيار فرع للمشرف/الموظف.',
            userAddedSuccessfully: 'تمت إضافة المستخدم بنجاح!',
            userUpdatedSuccessfully: 'تم تحديث المستخدم بنجاح!',
            confirmDeleteUser: 'هل أنت متأكد من رغبتك في حذف هذا المستخدم وجميع المدفوعات المرتبطة به؟',
            userDeletedSuccessfully: 'تم حذف المستخدم بنجاح!',
            pleaseFillAllPaymentFields: 'الرجاء ملء جميع حقول الدفع بشكل صحيح.',
            paymentUpdatedSuccessfully: 'تم تحديث الدفع بنجاح!',
            noPaymentsToDownload: 'لا توجد مدفوعات لتنزيلها.',
            paymentsDataDownloadedSuccessfully: 'تم تنزيل بيانات المدفوعات بنجاح!',
            allDataBackedUpSuccessfully: 'تم عمل نسخة احتياطية لجميع البيانات بتنسيق JSON بنجاح!',
            pleaseEnterValidAmount: 'الرجاء إدخال مبلغ صالح.',
            amountEntryCancelled: 'تم إلغاء إدخال المبلغ.',
            paymentAddedSuccessfully: 'تمت إضافة الدفع بنجاح!',
            errorEmployeeOrPaymentMethodMissing: 'خطأ: الموظف أو طريقة الدفع مفقودة. الرجاء إعادة العملية.',
            downloadPaymentsXLSX: 'تنزيل المدفوعات (XLSX)',
            downloadAllDataXLSX: 'تنزيل جميع البيانات (نسخة احتياطية JSON)',
            last5PaymentsFor: 'آخر 5 مدفوعات لـ',
            via: 'عبر',
            search: 'بحث',
            sort: 'ترتيب حسب',
            newestToOldest: 'الأحدث للأقدم',
            oldestToNewest: 'الأقدم للأحدث',
            itemsPerPage: 'العناصر لكل صفحة:',
            previous: 'السابق',
            next: 'التالي',
            downloadFilteredXLSX: 'تنزيل المصفاة (XLSX)',
            all: 'الكل',
            selectBranchFilter: 'اختر الفرع',
            selectEmployeeFilter: 'اختر الموظف',
            selectPaymentMethodFilter: 'اختر طريقة الدفع',
            filter: 'تصفية',
            clearFilters: 'مسح الفلاتر',
            backToDashboard: 'العودة للوحة التحكم',
            paymentMethodsManagement: 'إدارة طرق الدفع',
            addPaymentMethod: 'إضافة طريقة دفع جديدة',
            icon: 'أيقونة',
            color: 'اللون',
            addPaymentMethodModalTitle: 'إضافة طريقة دفع جديدة',
            editPaymentMethodModalTitle: 'تعديل طريقة الدفع',
            methodNamePlaceholder: 'مثال: نقداً',
            methodNameArPlaceholder: 'مثال: نقدًا',
            methodIconPlaceholder: 'مثال: 💰',
            methodColorPlaceholder: 'مثال: #FF6F61',
            confirmDeletePaymentMethod: 'هل أنت متأكد من رغبتك في حذف طريقة الدفع هذه؟',
            paymentMethodAddedSuccessfully: 'تمت إضافة طريقة الدفع بنجاح!',
            paymentMethodUpdatedSuccessfully: 'تم تحديث طريقة الدفع بنجاح!',
            paymentMethodDeletedSuccessfully: 'تم حذف طريقة الدفع بنجاح!',
            pleaseEnterMethodName: 'الرجاء إدخال اسم طريقة الدفع.',
            fromDate: 'من تاريخ',
            toDate: 'إلى تاريخ',
            filterByYear: 'تصفية حسب السنة',
            filterByMonth: 'تصفية حسب الشهر',
            filterByDay: 'تصفية حسب اليوم',
            selectYear: 'اختر السنة',
            selectMonth: 'اختر الشهر',
            selectDay: 'اختر اليوم',
            jan: 'يناير', feb: 'فبراير', mar: 'مارس', apr: 'أبريل', may: 'مايو', jun: 'يونيو',
            jul: 'يوليو', aug: 'أغسطس', sep: 'سبتمبر', oct: 'أكتوبر', nov: 'نوفمبر', dec: 'ديسمبر',
            changePassword: 'تغيير كلمة المرور',
            enterNewPassword: 'أدخل كلمة مرور جديدة',
            confirmNewPassword: 'تأكيد كلمة المرور الجديدة',
            passwordMismatch: 'كلمتا المرور غير متطابقتين.',
            passwordChangedSuccessfully: 'تم تغيير كلمة المرور بنجاح.',
            passwordChangeError: 'خطأ في تغيير كلمة المرور.',
            employeeFinancials: 'الماليات للموظفين',
            addExpense: 'إضافة مصروف',
            editExpense: 'تعديل مصروف',
            deleteExpense: 'حذف مصروف',
            addBonus: 'إضافة مكافأة',
            editBonus: 'تعديل مكافأة',
            deleteBonus: 'حذف مكافأة',
            selectEmployeeForFinancials: 'اختر الموظف',
            expenseType: 'نوع المصروف',
            expenseAmount: 'مبلغ المصروف (ريال سعودي)',
            description: 'الوصف',
            bonusAmount: 'مبلغ المكافأة (ريال سعودي)',
            rental: 'إيجار',
            electricity: 'كهرباء',
            bill: 'فواتير',
            tickets: 'تذاكر',
            internet: 'إنترنت',
            consumables: 'مواد استهلاكية',
            penalties: 'غرامات',
            loans: 'قروض',
            totalExpenses: 'إجمالي المصروفات',
            totalBonuses: 'إجمالي المكافآت',
            netIncome: 'صافي الدخل',
            noExpenses: 'لا توجد مصروفات لهذا الموظف.',
            noBonuses: 'لا توجد مكافآت لهذا الموظف.',
            pleaseSelectEmployee: 'الرجاء اختيار موظف.',
            pleaseEnterAllFields: 'الرجاء ملء جميع الحقول.',
            expenseAddedSuccessfully: 'تمت إضافة المصروف بنجاح!',
            expenseUpdatedSuccessfully: 'تم تحديث المصروف بنجاح!',
            expenseDeletedSuccessfully: 'تم حذف المصروف بنجاح!',
            bonusAddedSuccessfully: 'تمت إضافة المكافأة بنجاح!',
            bonusUpdatedSuccessfully: 'تم تحديث المكافأة بنجاح!',
            bonusDeletedSuccessfully: 'تم حذف المكافأة بنجاح!',
            downloadSampleExcel: 'تنزيل ملف إكسل (نموذج)',
            uploadExcel: 'رفع ملف إكسل',
            chooseExcelFile: 'اختر ملف إكسل',
            excelUploadSuccess: 'تم تحميل ملف إكسل ومعالجة البيانات بنجاح!',
            excelUploadError: 'حدث خطأ أثناء معالجة ملف إكسل.',
            invalidExcelFormat: 'تنسيق إكسل غير صالح. يرجى التأكد من الأعمدة الصحيحة: employeeNumber, type, amount, description, month, year.',
            selectMonthYear: 'اختر الشهر/السنة',
            noDataForSelectedPeriod: 'لا توجد بيانات للفترة المحددة.',
            currentBalance: 'الرصيد الحالي',
            register: 'تسجيل',
            forgotPassword: 'هل نسيت كلمة المرور؟',
            registerAdminTask: 'تم إرسال طلب التسجيل إلى المشرف. يرجى الاتصال بهم لتفعيل الحساب.',
            forgotPasswordAdminTask: 'تم إرسال طلب إعادة تعيين كلمة المرور إلى المشرف. يرجى الاتصال بهم للمساعدة.',
            analyticsOverview: 'نظرة عامة على التحليلات',
            dailyEmployeeSummary: 'ملخص الموظفين اليومي',
            confirmDeleteExpense: 'هل أنت متأكد من رغبتك في حذف هذا المصروف؟',
            confirmDeleteBonus: 'هل أنت متأكد من رغبتك في حذف هذه المكافأة؟',
            selectTheme: 'اختر مظهر الجدول',
            defaultTheme: 'افتراضي',
            stripedTheme: 'مخطط',
            borderedTheme: 'بحدود',
            compactTheme: 'مضغوط',
            recordsPerPage: 'السجلات لكل صفحة:',
            deleteSelected: 'حذف المحدد',
            applyPaymentMethod: 'تطبيق طريقة الدفع',
            selectPaymentMethodForSelected: 'اختر طريقة الدفع للمدفوعات المحددة',
            approved: 'تمت الموافقة',
            passwordRequiredForNewUser: 'كلمة المرور مطلوبة للمستخدمين الجدد.',
            passwordTooShort: 'يجب أن تتكون كلمة المرور من 6 أحرف على الأقل.',
            invalidExcelFile: 'الرجاء تحميل ملف إكسل صالح (.xlsx أو .xls).',
            processingUpload: 'جاري معالجة التحميل...',
            emptyExcelFile: 'ملف الإكسل الذي تم تحميله فارغ أو يحتوي على رؤوس فقط.',
            nameRequired: 'الاسم مطلوب.',
            employeeNoRequired: 'رقم الموظف مطلوب.',
            emailRequired: 'البريد الإلكتروني مطلوب.',
            invalidEmailFormat: 'صيغة البريد الإلكتروني غير صالحة.',
            emailAlreadyExists: 'البريد الإلكتروني موجود بالفعل.',
            employeeNoAlreadyExists: 'رقم الموظف موجود بالفعل.',
            invalidRole: 'دور غير صالح. الأدوار الصالحة هي:',
            invalidBranchName: 'اسم الفرع غير صالح.',
            invalidTargetAmount: 'المبلغ المستهدف غير صالح.',
            importingUsers: 'جاري استيراد المستخدمين...',
            usersImportedSuccessfully: 'تم استيراد المستخدمين بنجاح!',
            newUsersAdded: 'تمت إضافة مستخدمين جدد',
            noNewUsersProcessed: 'لم يتم معالجة أي مستخدمين جدد من الملف. قد يحتوي على بيانات موجودة فقط.',
            uploadCompletedWithErrors: 'اكتمل التحميل مع وجود أخطاء.',
            errorDeletingUsers: 'خطأ في حذف المستخدمين. الرجاء المحاولة مرة أخرى.',
            errorReadingExcelFile: 'خطأ في قراءة ملف الإكسل. الرجاء التأكد من أنه صالح.',
            generalError: 'خطأ عام',
            userTemplate: 'نموذج استيراد المستخدمين',
            userTemplateFileName: 'user_import_template.xlsx',
            userTemplateDownloaded: 'تم تنزيل نموذج استيراد المستخدمين بنجاح!',
            confirmDeleteSelectedUsers: 'هل أنت متأكد من رغبتك في حذف المستخدمين المحددين؟',
            errorDownloadingTemplate: 'خطأ في تنزيل النموذج.',
            filteredPaymentsExport: 'تصدير المدفوعات المصفاة',
            allDataBackup: 'نسخة_احتياطية_كاملة_لتطبيق_المتجر',
            // NEW: PDF Report related translations
            employeeReportPdf: 'Employee_Monthly_Report',
            allEmployeesReportPdf: 'All_Employees_Monthly_Calculations',
            downloadEmployeeReport: 'تنزيل تقريري الشهري (PDF)',
            downloadAllEmployeesCalculations: 'تنزيل حسابات جميع الموظفين (PDF)',
            reportFor: 'تقرير لـ',
            generatedOn: 'تم الإنشاء في',
            employeeDetails: 'تفاصيل الموظف',
            totalPayments: 'إجمالي المدفوعات',
            totalExpensesSummary: 'إجمالي المصروفات',
            totalBonusesSummary: 'إجمالي المكافآت',
            netIncomeSummary: 'صافي الدخل',
            reportTitle: 'التقرير المالي الشهري',
            employeeName: 'اسم الموظف',
            employeeNumber: 'رقم الموظف',
            branch: 'الفرع',
            target: 'الهدف',
            paymentsSummary: 'ملخص المدفوعات',
            expensesSummary: 'ملخص المصروفات',
            bonusesSummary: 'ملخص المكافآت',
            noDataForReport: 'لا توجد بيانات متاحة لهذا التقرير للفترة المحددة.',
          },
        };


        // Main App component
        const App = () => {
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [currentUser, setCurrentUser] = useState(null);
          const [users, setUsers] = useState([]);
          const [branches, setBranches] = useState([]);
          const [payments, setPayments] = useState([]);
          const [paymentMethods, setPaymentMethods] = useState([]);
          const [expenses, setExpenses] = useState([]); // New state for expenses
          const [bonuses, setBonuses] = useState([]); // New state for bonuses
          const [organizationExpenses, setOrganizationExpenses] = useState([]); // New state for organization expenses
          const [loginError, setLoginError] = useState('');
          const [language, setLanguage] = useState('ar');
          const [loading, setLoading] = useState(true);
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [appId, setAppId] = useState('');
          const [userId, setUserId] = useState(null);
          const [message, setMessage] = useState('');

          useEffect(() => {
            const initFirebase = async () => {
                let configToUse = null;
                try {
                    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                        configToUse = JSON.parse(__firebase_config);
                        console.log("Using Firebase config from Canvas environment.");
                    }
                } catch (parseError) {
                    console.warn("Could not parse __firebase_config from Canvas environment. Falling back to hardcoded config.", parseError);
                }

                if (!configToUse) {
                    configToUse = {
                        apiKey: "AIzaSyDazyxOVaF0gJPw9z3KOctXOr8hernzfCg",
                        authDomain: "afg-3006-01.firebaseapp.com",
                        projectId: "afg-3006-01",
                        storageBucket: "afg-3006-01.firebasestorage.app",
                        messagingSenderId: "734860701348",
                        appId: "1:734860701348:web:b68312f0748d3970c00031",
                        measurementId: "G-CJ95TXTD9D"
                    };
                    console.log("Using hardcoded Firebase config.");
                }

                try {
                    const currentAppId = typeof __app_id !== 'undefined' ? __app_id : configToUse.projectId;
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    if (!configToUse) {
                        console.error("Firebase config is still null after all attempts. Cannot initialize.");
                        setLoading(false);
                        return;
                    }

                    const app = firebase.initializeApp(configToUse);
                    const firestoreDb = firebase.getFirestore(app);
                    const firebaseAuth = firebase.getAuth(app);

                    setDb(firestoreDb);
                    setAuth(firebaseAuth);
                    setAppId(currentAppId);

                    console.log("Firebase initialized successfully!");

                    // Authenticate anonymously first to get a userId for Firestore rules
                    await firebase.signInAnonymously(firebaseAuth);

                    firebase.onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("User authenticated:", user.uid);
                        } else {
                            // If for some reason user logs out or token expires, re-authenticate anonymously
                            firebase.signInAnonymously(firebaseAuth).then(anonUser => {
                                setUserId(anonUser.user.uid);
                                console.log("Signed in anonymously:", anonUser.user.uid);
                            }).catch(anonError => {
                                console.error("Error signing in anonymously:", anonError);
                            });
                        }
                        setLoading(false);
                    });

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setLoginError("Failed to initialize app. Please try again later. Check console for details.");
                    setLoading(false);
                }
            };

            initFirebase();
          }, []);

          useEffect(() => {
            if (!db || !userId || !appId) return; // Wait for db, userId, and appId to be ready

            const publicDataPath = `artifacts/${appId}/public/data`;
            console.log("Listening to Firestore path:", publicDataPath);

            const unsubscribeBranches = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/branches`)), (snapshot) => {
                const fetchedBranches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setBranches(fetchedBranches);
            }, (error) => console.error("Error fetching branches:", error));

            const unsubscribeUsers = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/users`)), (snapshot) => {
                const fetchedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setUsers(fetchedUsers);
                // If currentUser is set, ensure it's updated with the latest data from Firestore
                if (currentUser && fetchedUsers.some(u => u.id === currentUser.id)) {
                    setCurrentUser(fetchedUsers.find(u => u.id === currentUser.id));
                }
            }, (error) => console.error("Error fetching users:", error));

            const unsubscribePayments = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/payments`)), (snapshot) => {
                const fetchedPayments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // If month/year are stored as separate fields, parse them too if needed for logic
                    month: doc.data().month,
                    year: doc.data().year,
                }));
                fetchedPayments.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                setPayments(fetchedPayments);
            }, (error) => console.error("Error fetching payments:", error));

            const unsubscribePaymentMethods = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/paymentMethods`)), (snapshot) => {
                const fetchedPaymentMethods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setPaymentMethods(fetchedPaymentMethods);
            }, (error) => console.error("Error fetching payment methods:", error));

            // Listen for expenses
            const unsubscribeExpenses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/expenses`)), (snapshot) => {
                const fetchedExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // Ensure month/year are properly parsed as numbers
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setExpenses(fetchedExpenses);
            }, (error) => console.error("Error fetching expenses:", error));

            // Listen for bonuses
            const unsubscribeBonuses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/bonuses`)), (snapshot) => {
                const fetchedBonuses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // Ensure month/year are properly parsed as numbers
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setBonuses(fetchedBonuses);
            }, (error) => console.error("Error fetching bonuses:", error));

            // Listen for organization expenses
            const unsubscribeOrganizationExpenses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/organizationExpenses`)), (snapshot) => {
                const fetchedOrgExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setOrganizationExpenses(fetchedOrgExpenses);
            }, (error) => console.error("Error fetching organization expenses:", error));


            return () => {
                unsubscribeBranches();
                unsubscribeUsers();
                unsubscribePayments();
                unsubscribePaymentMethods();
                unsubscribeExpenses();
                unsubscribeBonuses();
                unsubscribeOrganizationExpenses();
            };
          }, [db, userId, appId, currentUser]);

          // MODIFIED: handleLogin function to use role-based passwords
          const handleLogin = (identifier, password) => {
            let user = users.find(u => u.email === identifier);

            if (!user) {
                user = users.find(u => u.employeeNumber === identifier);
            }

            if (user) {
                let expectedPassword = '';
                switch (user.role) {
                    case 'admin':
                        expectedPassword = 'Admin';
                        break;
                    case 'employee':
                        expectedPassword = 'Employee';
                        break;
                    case 'supervisor':
                        expectedPassword = 'Supervisor';
                        break;
                    case 'manager': // NEW role
                        expectedPassword = 'Manager';
                        break;
                    case 'partner': // NEW role
                        expectedPassword = 'Partner';
                        break;
                    default:
                        expectedPassword = ''; // No default password
                }

                // Check against the hardcoded password first
                if (password === expectedPassword) {
                    setIsLoggedIn(true);
                    setCurrentUser(user);
                    setLoginError('');
                }
                // If a simulatedPassword exists (from admin reset), allow login with it
                else if (user.simulatedPassword && password === user.simulatedPassword) {
                    setIsLoggedIn(true);
                    setCurrentUser(user);
                    setLoginError('');
                    setMessage(translations[language].passwordChangeRequired || "Please change your temporary password.");
                }
                else {
                    setLoginError(translations[language].loginError);
                }
            } else {
              setLoginError(translations[language].loginError);
            }
          };

          const handleLogout = async () => {
            if (auth) {
                try {
                    await auth.signOut();
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    // After logout, sign in anonymously to maintain Firestore access for public data
                    await firebase.signInAnonymously(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
          };

          // NEW FUNCTION: For a user to change their OWN password
          const changeCurrentUserPassword = async (newPassword) => {
              if (!auth.currentUser) {
                  setMessage(translations[language].passwordChangeError + ": No authenticated user.");
                  return false;
              }
              try {
                  // Firebase Auth's updatePassword function
                  await firebase.updatePassword(auth.currentUser, newPassword);

                  // If a simulated password was used for login, clear it after successful change
                  if (currentUser.simulatedPassword) {
                      const userDocRef = firebase.doc(db, `artifacts/${appId}/public/data/users`, currentUser.id);
                      await firebase.updateDoc(userDocRef, {
                          simulatedPassword: firebase.deleteField(), // Remove the field
                          updatedAt: firebase.serverTimestamp(),
                      });
                  }
                  setMessage(translations[language].passwordChangedSuccessfully);
                  return true;
              }
              catch (error) {
                  console.error("Error changing password:", error);
                  // Handle specific Firebase Auth errors if needed
                  let errorMessage = translations[language].passwordChangeError;
                  if (error.code === 'auth/requires-recent-login') {
                      errorMessage += " Please re-authenticate before changing your password.";
                  }
                  setMessage(errorMessage);
                  return false;
              }
          };

          // NEW FUNCTION: For Admin to "reset" a user's password (simulated for client-side)
          const adminResetUserPassword = async (userIdToReset, newPassword) => {
              // IMPORTANT: In a real application, admin password resets for Firebase Authentication
              // should be done via Firebase Admin SDK on a secure backend server, not directly from the client.
              // This client-side simulation updates a 'simulatedPassword' field in Firestore.
              // The user will then log in with this 'simulatedPassword' and be prompted to change it.
              try {
                  const userDocRef = firebase.doc(db, `artifacts/${appId}/public/data/users`, userIdToReset);
                  await firebase.updateDoc(userDocRef, {
                      simulatedPassword: newPassword, // Store a "simulated" password field
                      updatedAt: firebase.serverTimestamp(),
                  });
                  setMessage(translations[language].passwordChangedSuccessfully + " (Admin reset simulated)");
                  return true;
              } catch (error) {
                  console.error("Error changing simulated password:", error);
                  setMessage(translations[language].passwordChangeError);
                  return false;
              }
          };

          const addBranch = async (name, location) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/branches`), {
                name,
                location,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].branchAddedSuccessfully);
            }
            catch (e) {
              console.error("Error adding document: ", e);
              setMessage("Error adding branch.");
            }
          };

          const deleteBranch = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/branches`, id));
              const usersToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/users`), firebase.where("branchId", "==", id));
              const usersSnapshot = await firebase.getDocs(usersToDeleteQuery);
              usersSnapshot.forEach(async (userDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, userDoc.id));
              });
              const paymentsToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("branchId", "==", id));
              const paymentsSnapshot = await firebase.getDocs(paymentsToDeleteQuery);
              paymentsSnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              setMessage(translations[language].branchDeletedSuccessfully);
            } catch (e) {
              console.error("Error removing document: ", e);
              setMessage("Error deleting branch.");
            }
          };

          const editBranch = async (id, updatedName, updatedLocation) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/branches`, id), {
                name: updatedName,
                location: updatedLocation,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].branchUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating document: ", e);
              setMessage("Error updating branch.");
            }
          };

          const addUser = async (name, email, role, branchId, targetAmount, employeeNumber, nameAr, imageUrl) => {
            try {
              const newEmployeeNumber = employeeNumber || (
                role === 'admin' ? `ADM${String(users.length + 1).padStart(3, '0')}` :
                role === 'supervisor' ? `SUP${String(users.length + 1).padStart(3, '0')}` :
                `EMP${String(users.length + 1).padStart(3, '0')}`
              );

              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/users`), {
                name,
                nameAr: nameAr || name,
                email,
                role,
                branchId: branchId || '',
                targetAmount: role === 'employee' ? parseFloat(targetAmount) : 0,
                employeeNumber: newEmployeeNumber,
                imageUrl: imageUrl || `https://placehold.co/100x100/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${name.substring(0,2).toUpperCase()}`,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].userAddedSuccessfully);
            } catch (e) {
              console.error("Error adding user: ", e);
              setMessage("Error adding user.");
            }
          };

          const deleteUser = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, id));
              const paymentsToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("employeeId", "==", id));
              const paymentsSnapshot = await firebase.getDocs(paymentsToDeleteQuery);
              paymentsSnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              const paymentsAddedByQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("addedBy", "==", id));
              const paymentsAddedBySnapshot = await firebase.getDocs(paymentsAddedByQuery);
              paymentsAddedBySnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              // Delete associated expenses and bonuses
              const expensesToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/expenses`), firebase.where("employeeId", "==", id));
              const expensesSnapshot = await firebase.getDocs(expensesToDeleteQuery);
              expensesSnapshot.forEach(async (doc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, doc.id));
              });
              const bonusesToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/bonuses`), firebase.where("employeeId", "==", id));
              const bonusesSnapshot = await firebase.getDocs(bonusesToDeleteQuery);
              bonusesSnapshot.forEach(async (doc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, doc.id));
              });

              setMessage(translations[language].userDeletedSuccessfully);
            } catch (e) {
              console.error("Error removing user: ", e);
              setMessage("Error deleting user.");
            }
          };

          const editUser = async (id, updatedUser) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, id), {
                ...updatedUser,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].userUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating user: ", e);
              setMessage("Error updating user.");
            }
          };

          const addPayment = async (branchId, employeeId, amount, paymentMethod, addedBy) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/payments`), {
                paymentNumber: payments.length + 1,
                branchId,
                employeeId,
                amount: parseFloat(amount),
                paymentMethod,
                timestamp: firebase.serverTimestamp(),
                addedBy,
              });
              setMessage(translations[language].paymentAddedSuccessfully);
            } catch (e) {
              console.error("Error adding payment: ", e);
              setMessage("Error adding payment.");
            }
          };

          const editPayment = async (id, updatedPayment) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, id), {
                ...updatedPayment,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].paymentUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating payment: ", e);
              setMessage("Error updating payment.");
            }
          };

          const addPaymentMethod = async (name, nameAr, icon, color) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/paymentMethods`), {
                name,
                nameAr: nameAr || name,
                icon,
                color,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].paymentMethodAddedSuccessfully);
            } catch (e) {
              console.error("Error adding payment method: ", e);
              setMessage("Error adding payment method.");
            }
          };

          const editPaymentMethod = async (id, updatedMethod) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/paymentMethods`, id), {
                ...updatedMethod,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].paymentMethodUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating payment method: ", e);
              setMessage("Error updating payment method.");
            }
          };

          const deletePaymentMethod = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/paymentMethods`, id));
              setMessage(translations[language].paymentMethodDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting payment method: ", e);
              setMessage("Error deleting payment method.");
            }
          };

          // Firestore operations for Expenses
          const addExpense = async (employeeId, type, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/expenses`), {
                employeeId,
                type,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1), // Use specific date for month/year filtering
                month: month, // Store month (0-indexed)
                year: year, // Store full year
              });
              setMessage(translations[language].expenseAddedSuccessfully);
            } catch (e) {
              console.error("Error adding expense: ", e);
              setMessage("Error adding expense.");
            }
          };

          const editExpense = async (id, updatedExpense) => {
            try {
              // Ensure timestamp is updated correctly if month/year changes
              const updatedTimestamp = new Date(updatedExpense.year, updatedExpense.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, id), {
                ...updatedExpense,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].expenseUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating expense: ", e);
              setMessage("Error updating expense.");
            }
          };

          const deleteExpense = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, id));
              setMessage(translations[language].expenseDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting expense: ", e);
              setMessage("Error deleting expense.");
            }
          };

          // Firestore operations for Bonuses
          const addBonus = async (employeeId, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/bonuses`), {
                employeeId,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1), // Use specific date for month/year filtering
                month: month, // Store month (0-indexed)
                year: year, // Store full year
              });
              setMessage(translations[language].bonusAddedSuccessfully);
            } catch (e) {
              console.error("Error adding bonus: ", e);
              setMessage("Error adding bonus.");
            }
          };

          const editBonus = async (id, updatedBonus) => {
            try {
                // Ensure timestamp is updated correctly if month/year changes
                const updatedTimestamp = new Date(updatedBonus.year, updatedBonus.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, id), {
                ...updatedBonus,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].bonusUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating bonus: ", e);
              setMessage("Error updating bonus.");
            }
          };

          const deleteBonus = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, id));
              setMessage(translations[language].bonusDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting bonus: ", e);
              setMessage("Error deleting bonus.");
            }
          };

          // Firestore operations for Organization Expenses
          const addOrganizationExpense = async (type, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/organizationExpenses`), {
                type,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1),
                month: month,
                year: year,
              });
              setMessage(translations[language].expenseAddedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error adding organization expense: ", e);
              setMessage("Error adding organization expense."); // Re-using translation
            }
          };

          const editOrganizationExpense = async (id, updatedExpense) => {
            try {
                const updatedTimestamp = new Date(updatedExpense.year, updatedExpense.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/organizationExpenses`, id), {
                ...updatedExpense,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations[language].expenseUpdatedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error updating organization expense: ", e);
              setMessage("Error updating organization expense."); // Re-using translation
            }
          };

          const deleteOrganizationExpense = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/organizationExpenses`, id));
              setMessage(translations[language].expenseDeletedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error deleting organization expense: ", e);
              setMessage("Error deleting organization expense.");
            }
          };


          if (loading) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white text-2xl">
                Loading Application...
              </div>
            );
          }

          return (
            <AppContext.Provider value={{
              isLoggedIn,
              currentUser,
              users,
              branches,
              payments,
              paymentMethods,
              expenses,
              bonuses,
              organizationExpenses, // Provide organization expenses
              handleLogin,
              handleLogout,
              changeCurrentUserPassword, // User changes own password
              adminResetUserPassword, // Admin resets other user's password
              addBranch,
              deleteBranch,
              editBranch,
              addUser,
              deleteUser,
              editUser,
              addPayment,
              editPayment,
              addPaymentMethod,
              editPaymentMethod,
              deletePaymentMethod,
              addExpense,
              editExpense,
              deleteExpense,
              addBonus,
              editBonus,
              deleteBonus,
              addOrganizationExpense, // New org expense functions
              editOrganizationExpense,
              deleteOrganizationExpense,
              setLoginError,
              loginError,
              setUsers,
              setCurrentUser,
              language,
              setLanguage,
              translations: translations[language],
              appId,
              userId,
              message,
              setMessage,
              getBranchName: (id) => {
                const branch = branches.find(b => b.id === id);
                return branch ? branch.name : 'N/A';
              },
              getPaymentMethodDetails: (methodName) => {
                const method = paymentMethods.find(pm => pm.name === methodName);
                return method ? (translations[language].language === 'ar' && method.nameAr ? method.nameAr : method.name) : methodName;
              },
              getUserDetails: (id) => {
                const user = users.find(u => u.id === id);
                return user ? `${user.name} (${user.employeeNumber})` : 'N/A';
              },
              getEmployeeName: (id) => {
                const user = users.find(u => u.id === id);
                return user ? (translations[language].language === 'ar' && user.nameAr ? user.nameAr : user.name) : 'N/A';
              },
              db, // Pass db for Excel upload Firestore operations
            }}>
              <div className="min-h-screen bg-gray-100 font-inter" dir={language === 'ar' ? 'rtl' : 'ltr'}>
                {isLoggedIn ? <MainLayout /> : <Login />}
              </div>
            </AppContext.Provider>
          );
        };

        // Login Component
        const Login = () => {
          const { handleLogin, loginError, translations, setMessage } = useAppContext();
          const [identifier, setIdentifier] = useState('');
          const [password, setPassword] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            handleLogin(identifier, password);
          };

          const handleRegisterClick = () => {
              setMessage(translations.registerAdminTask);
          };

          const handleForgotPasswordClick = () => {
              setMessage(translations.forgotPasswordAdminTask);
          };

          return (
            <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 p-4">
              <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <h2 className="text-3xl font-bold mb-6 text-gray-800">{translations.loginWelcome}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div>
                    <input
                      type="text"
                      placeholder={translations.emailPlaceholder}
                      value={identifier}
                      onChange={(e) => setIdentifier(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                      required
                    />
                  </div>
                  <div>
                    <input
                      type="password"
                      placeholder={translations.passwordPlaceholder}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                      required
                    />
                  </div>
                  {loginError && (
                    <div className="text-red-600 text-sm mt-2">{loginError}</div>
                  )}
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg"
                  >
                    {translations.loginButton}
                  </button>
                </form>
                <div className="mt-4 flex justify-between text-sm">
                    <button
                        onClick={handleRegisterClick}
                        className="text-blue-600 hover:underline font-semibold"
                        type="button"
                    >
                        {translations.register}
                    </button>
                    <button
                        onClick={handleForgotPasswordClick}
                        className="text-blue-600 hover:underline font-semibold"
                        type="button"
                    >
                        {translations.forgotPassword}
                    </button>
                </div>
              </div>
            </div>
          );
        };

        // Main Layout component that routes based on user role
        const MainLayout = () => {
          const { currentUser, handleLogout, language, setLanguage, translations, userId, message } = useAppContext();
          const [adminPage, setAdminPage] = useState('analytics');

          if (!currentUser) {
            return <Login />;
          }

          const renderDashboard = () => {
            switch (currentUser.role) {
              case 'admin':
                return <AdminDashboard adminPage={adminPage} setAdminPage={setAdminPage} />;
              case 'supervisor':
                return <SupervisorDashboard />;
              case 'employee':
                return <EmployeeDashboard />;
              case 'manager':
                return <ManagerDashboard />;
              case 'partner':
                return <PartnerDashboard />;
              default:
                return <Login />;
            }
          };

          return (
            <div className="flex flex-col min-h-screen bg-gray-100">
              <header className="bg-white shadow-md p-4 flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">{translations.appName}</h1>
                <div className="flex items-center space-x-4">
                  <span className="text-gray-600">
                    {translations.welcome} <span className="font-semibold">{currentUser.name}</span> ({currentUser.role === 'admin' ? translations.admin : currentUser.role === 'supervisor' ? translations.supervisor : currentUser.role === 'employee' ? translations.employeeRole : currentUser.role === 'manager' ? translations.manager : currentUser.role === 'partner' ? translations.partner : currentUser.role})
                  </span>
                  <span className="text-sm text-gray-500">{userId}</span>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => setLanguage('en')}
                      className={`px-3 py-1 rounded-md text-sm font-semibold ${language === 'en' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                      EN
                    </button>
                    <button
                      onClick={() => setLanguage('ar')}
                      className={`px-3 py-1 rounded-md text-sm font-semibold ${language === 'ar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                      AR
                    </button>
                  </div>
                  <button
                    onClick={handleLogout}
                    className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-300 shadow-md"
                  >
                    {translations.logout}
                  </button>
                </div>
              </header>
              <main className="flex-grow p-6">
                {message && (
                  <div className={`mb-4 p-3 rounded-lg text-center ${message.includes('successfully') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                  </div>
                )}
                {renderDashboard()}
              </main>
            </div>
          );
        };

        // Utility function to export data to XLSX (tab-separated for Excel compatibility)
        const exportToXLSX = (data, columns, fileNamePrefix, translations, getUserDetails, getBranchName, getPaymentMethodDetails, users) => {
          if (data.length === 0) {
            // Replaced alert with a more user-friendly message display
            const messageDiv = document.createElement('div');
            messageDiv.textContent = translations.noPaymentsToDownload;
            messageDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-lg z-50';
            document.body.appendChild(messageDiv);
            setTimeout(() => document.body.removeChild(messageDiv), 3000);
            return;
          }

          const headers = columns.map(col => col.header);
          const xlsxRows = [];
          xlsxRows.push(headers.join('\t')); // Use tab for separation

          data.forEach(item => {
            const row = columns.map(col => {
              let value = '';
              if (col.render) {
                // Special handling for rendered columns
                if (col.key === 'employeeId' && getUserDetails) {
                  const user = users.find(u => u.id === item.employeeId);
                  value = user ? `${user.name} (${user.employeeNumber})` : 'N/A';
                } else if (col.key === 'addedBy' && getUserDetails) {
                  const user = users.find(u => u.id === item.addedBy);
                  value = user ? `${user.name} (${user.employeeNumber})` : 'N/A';
                } else if (col.key === 'branchId' && getBranchName) {
                  value = getBranchName(item.branchId);
                } else if (col.key === 'timestamp') {
                  value = item.timestamp?.toLocaleString() || '';
                } else if (['amount', 'totalAmount', 'targetAmount', 'expenseAmount', 'bonusAmount', 'totalExpenses', 'totalBonuses', 'netIncome'].includes(col.key)) {
                  value = item[col.key]?.toFixed(2) || '0.00';
                } else if (col.key === 'name' && item.nameAr) {
                  value = `${item.name} / ${item.nameAr}`;
                } else if (col.key === 'paymentMethod' && getPaymentMethodDetails) {
                  value = getPaymentMethodDetails(item.paymentMethod);
                } else if (col.key === 'methods') {
                    value = Object.entries(item.methods || {})
                        .map(([method, amount]) => `${getPaymentMethodDetails(method)}: ${amount.toFixed(2)}`)
                        .join(', ');
                } else if (col.key === 'imageUrl') {
                    value = item.imageUrl || '';
                } else if (col.key === 'type' && translations[item.type]) { // For expense types
                    value = translations[item.type];
                } else if (col.key === 'role' && translations[item.role]) { // For user roles
                    value = translations[item.role];
                }
                else {
                    // Fallback for other rendered columns if specific logic isn't defined
                    value = col.render(item);
                }
              } else {
                value = item[col.key];
              }
              return String(value); // No double quotes, no escaping
            });
            xlsxRows.push(row.join('\t')); // Use tab for separation
          });

          const xlsxString = "\uFEFF" + xlsxRows.join('\n'); // Add BOM for proper UTF-8 handling in Excel
          const blob = new Blob([xlsxString], { type: 'text/tab-separated-values;charset=utf-8;' }); // Use TSV MIME type
          const now = new Date();
          const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
          const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
          const fileName = `${fileNamePrefix}_${dateStr}_${timeStr}.xls`; // Keep .xls for Excel to open directly

          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Replaced alert with a more user-friendly message display
          const messageDiv = document.createElement('div');
          messageDiv.textContent = translations.paymentsDataDownloadedSuccessfully;
          messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
          document.body.appendChild(messageDiv);
          setTimeout(() => document.body.removeChild(messageDiv), 3000);
        };


        // Table component for reusability
        const PaginatedTable = ({
          data,
          columns,
          itemsPerPageOptions = [5, 10, 15, 20, 50],
          initialItemsPerPage = 15,
          searchPlaceholder,
          downloadXLSX,
          translations,
          getUserDetails,
          getBranchName,
          getPaymentMethodDetails,
          showFilters = false,
          branches = [],
          users = [],
          paymentMethods = [],
          onFilterChange,
          currentFilters,
          clearFilters,
          customSort = null,
          showMultiSelect = false, // New prop for multi-selection
          onMultiSelectChange = () => {}, // Callback for selected items
          selectedItems = [], // Currently selected items
          tableTheme = 'default', // New prop for table theme
          recordsPerPageSetting = 15, // New prop for admin-defined records per page
          onRecordsPerPageChange = () => {}, // Callback for changing records per page
          onDeleteSelected = () => {}, // Callback for deleting selected items
          onApplyPaymentMethodToSelected = () => {}, // Callback for applying payment method to selected
        }) => {
          const [searchTerm, setSearchTerm] = useState('');
          const [sortKey, setSortKey] = useState(null);
          const [sortDirection, setSortDirection] = useState('desc');
          const [currentPage, setCurrentPage] = useState(1);
          const [itemsPerPage, setItemsPerPage] = useState(recordsPerPageSetting); // Use admin setting
          const [showPaymentMethodDropdown, setShowPaymentMethodDropdown] = useState(false);
          const [selectedPaymentMethodForBatch, setSelectedPaymentMethodForBatch] = useState('');


          // Update itemsPerPage when recordsPerPageSetting changes from admin controls
          useEffect(() => {
            setItemsPerPage(recordsPerPageSetting);
            setCurrentPage(1); // Reset page when items per page changes
          }, [recordsPerPageSetting]);


          const filteredData = data.filter(item => {
            const matchesSearch = Object.values(item).some(value =>
              String(value).toLowerCase().includes(searchTerm.toLowerCase())
            );

            const filters = currentFilters || {};

            const matchesBranch = showFilters && filters.branchId ? item.branchId === filters.branchId : true;
            const matchesEmployee = showFilters && filters.employeeId ? item.employeeId === filters.employeeId : true;
            const matchesPaymentMethod = showFilters && filters.paymentMethod ? item.paymentMethod === filters.paymentMethod : true;

            const itemDate = item.timestamp ? new Date(item.timestamp) : null;
            let matchesDateRange = true;
            let matchesYear = true;
            let matchesMonth = true;
            let matchesDay = true;

            if (showFilters && itemDate) {
                if (filters.startDate) {
                    const start = new Date(filters.startDate);
                    start.setHours(0, 0, 0, 0);
                    matchesDateRange = matchesDateRange && (itemDate >= start);
                }
                if (filters.endDate) {
                    const end = new Date(filters.endDate);
                    end.setHours(23, 59, 59, 999);
                    matchesDateRange = matchesDateRange && (itemDate <= end);
                }
                if (filters.filterYear) {
                    matchesYear = itemDate.getFullYear() === parseInt(filters.filterYear);
                }
                if (filters.filterMonth !== undefined && filters.filterMonth !== null && filters.filterMonth !== '') {
                    matchesMonth = itemDate.getMonth() === parseInt(filters.filterMonth);
                }
                if (filters.filterDay) {
                    matchesDay = itemDate.getDate() === parseInt(filters.filterDay);
                }
            }


            return matchesSearch && matchesBranch && matchesEmployee && matchesPaymentMethod && matchesDateRange && matchesYear && matchesMonth && matchesDay;
          });

          const sortedData = [...filteredData].sort((a, b) => {
            if (!sortKey) return 0;

            if (customSort && customSort[sortKey]) {
                return customSort[sortKey](a, b, sortDirection);
            }

            let valA = a[sortKey];
            let valB = b[sortKey];

            if (sortKey === 'timestamp' && a.timestamp && b.timestamp) {
              valA = a.timestamp.getTime();
              valB = b.timestamp.getTime();
            } else if (typeof valA === 'string' && typeof valB === 'string') {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }

            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
          });

          const totalPages = Math.ceil(sortedData.length / itemsPerPage);
          const currentData = sortedData.slice(
            (currentPage - 1) * itemsPerPage,
            currentPage * itemsPerPage
          );

          const handleSort = (key) => {
            if (sortKey === key) {
              setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
            } else {
              setSortKey(key);
              setSortDirection('asc');
            }
          };

          const handlePageChange = (page) => {
            if (page > 0 && page <= totalPages) {
              setCurrentPage(page);
            }
          };

          const getSortIndicator = (key) => {
            if (sortKey === key) {
              return sortDirection === 'asc' ? ' ▲' : ' ▼';
            }
            return '';
          };

          const handleAllCheckboxChange = (e) => {
            if (e.target.checked) {
              onMultiSelectChange(currentData.map(item => item.id));
            } else {
              onMultiSelectChange([]);
            }
          };

          const handleItemCheckboxChange = (e, itemId) => {
            if (e.target.checked) {
              onMultiSelectChange(selectedItems.filter(id => id !== itemId).concat(itemId)); // Ensure no duplicates and order is maintained
            } else {
              onMultiSelectChange(selectedItems.filter(id => id !== itemId));
            }
          };

          const isAllSelected = currentData.length > 0 && currentData.every(item => selectedItems.includes(item.id));

          const getTableClasses = () => {
            let classes = "min-w-full bg-white";
            switch (tableTheme) {
                case 'striped':
                    classes += " [&>tbody>tr:nth-child(odd)]:bg-gray-50";
                    break;
                case 'bordered':
                    classes += " border border-gray-300 [&>th]:border-r [&>td]:border-r";
                    break;
                case 'compact':
                    classes += " [&>th]:py-2 [&>td]:py-2 text-sm";
                    break;
                default:
                    // default styling
                    break;
            }
            return classes;
          };


          const renderFilterControls = () => {
              if (!showFilters) return null;

              const getYears = () => {
                const years = new Set();
                data.forEach(item => {
                    if (item.timestamp) {
                        years.add(new Date(item.timestamp).getFullYear());
                    }
                });
                return [...years].sort((a, b) => b - a);
              };

              const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
              ];
              const days = Array.from({length: 31}, (_, i) => i + 1);

              return (
                  <div className="flex flex-wrap items-center space-x-2 mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.branchId || ''}
                          onChange={(e) => onFilterChange('branchId', e.target.value)}
                      >
                          <option value="">{translations.selectBranchFilter}</option>
                          {branches.map(branch => (
                              <option key={branch.id} value={branch.id}>{branch.name}</option>
                          ))}
                      </select>

                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.employeeId || ''}
                          onChange={(e) => onFilterChange('employeeId', e.target.value)}
                      >
                          <option value="">{translations.selectEmployeeFilter}</option>
                          {users.filter(u => u.role === 'employee').map(employee => (
                              <option key={employee.id} value={employee.id}>{employee.name}</option>
                          ))}
                      </select>

                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.paymentMethod || ''}
                          onChange={(e) => onFilterChange('paymentMethod', e.target.value)}
                      >
                          <option value="">{translations.selectPaymentMethodFilter}</option>
                          {paymentMethods.map(method => (
                              <option key={method.id} value={method.name}>{translations.language === 'ar' && method.nameAr ? method.nameAr : method.name}</option>
                          ))}
                      </select>

                      <div className="flex flex-wrap space-x-2 mt-2 md:mt-0">
                        <input
                            type="date"
                            className="p-2 border rounded-md"
                            value={currentFilters.startDate || ''}
                            onChange={(e) => onFilterChange('startDate', e.target.value)}
                            title={translations.fromDate}
                        />
                        <input
                            type="date"
                            className="p-2 border rounded-md"
                            value={currentFilters.endDate || ''}
                            onChange={(e) => onFilterChange('endDate', e.target.value)}
                            title={translations.toDate}
                        />
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterYear || ''}
                            onChange={(e) => onFilterChange('filterYear', e.target.value)}
                        >
                            <option value="">{translations.selectYear}</option>
                            {getYears().map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterMonth || ''}
                            onChange={(e) => onFilterChange('filterMonth', e.target.value)}
                        >
                            <option value="">{translations.selectMonth}</option>
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterDay || ''}
                            onChange={(e) => onFilterChange('filterDay', e.target.value)}
                        >
                            <option value="">{translations.selectDay}</option>
                            {days.map(day => (
                                <option key={day} value={day}>{day}</option>
                            ))}
                        </select>
                      </div>

                      <button
                          onClick={clearFilters}
                          className="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-300 shadow-md"
                      >
                          {translations.clearFilters}
                      </button>
                  </div>
              );
          };


          return (
            <div className="bg-white rounded-lg shadow-lg p-6">
              <div className="flex flex-wrap justify-between items-center mb-4">
                <input
                  type="text"
                  placeholder={searchPlaceholder || translations.search + '...'}
                  value={searchTerm}
                  onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                  className="w-full p-2 border border-gray-300 rounded-lg md:w-auto focus:ring-blue-500 focus:border-blue-500 mb-2 md:mb-0"
                />
                <div className="flex items-center space-x-2">
                  <label htmlFor="itemsPerPage" className="text-gray-700">{translations.itemsPerPage}</label>
                  <select
                    id="itemsPerPage"
                    value={itemsPerPage}
                    onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); onRecordsPerPageChange(Number(e.target.value)); }}
                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  >
                    {itemsPerPageOptions.map(option => (
                      <option key={option} value={option}>{option}</option>
                    ))}
                  </select>
                  {downloadXLSX && (
                    <button
                      onClick={downloadXLSX}
                      className="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-300 shadow-md"
                    >
                      {translations.downloadPaymentsXLSX}
                    </button>
                  )}
                </div>
              </div>

              {renderFilterControls()}

              {showMultiSelect && (
                <div className="mb-4 flex items-center space-x-4">
                  <button
                    onClick={() => onDeleteSelected(selectedItems)}
                    disabled={selectedItems.length === 0}
                    className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {translations.deleteSelected} ({selectedItems.length})
                  </button>
                  <button
                    onClick={() => setShowPaymentMethodDropdown(!showPaymentMethodDropdown)}
                    disabled={selectedItems.length === 0}
                    className="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {translations.applyPaymentMethod}
                  </button>
                  {showPaymentMethodDropdown && (
                    <select
                      value={selectedPaymentMethodForBatch}
                      onChange={(e) => {
                        setSelectedPaymentMethodForBatch(e.target.value);
                        onApplyPaymentMethodToSelected(selectedItems, e.target.value);
                        setShowPaymentMethodDropdown(false); // Hide after selection
                        onMultiSelectChange([]); // Clear selection
                      }}
                      className="p-2 border rounded-md"
                    >
                      <option value="">{translations.selectPaymentMethodForSelected}</option>
                      {paymentMethods.map(method => (
                        <option key={method.id} value={method.name}>{getPaymentMethodDetails(method.name)}</option>
                      ))}
                    </select>
                  )}
                </div>
              )}

              <div className="text-gray-700 text-sm mb-2">
                {translations.total}: {filteredData.length} {translations.recordsPerPage}
              </div>

              <div className="overflow-x-auto">
                <table className={getTableClasses()}>
                  <thead>
                    <tr>
                      {showMultiSelect && (
                        <th className="px-6 py-3 border-b-2 border-gray-300 bg-gray-200 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                          <input
                            type="checkbox"
                            checked={isAllSelected}
                            onChange={handleAllCheckboxChange}
                            className="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out"
                          />
                        </th>
                      )}
                      {columns.map(col => (
                        <th
                          key={col.key}
                          onClick={col.sortable !== false ? () => handleSort(col.key) : undefined}
                          className={`px-6 py-3 border-b-2 border-gray-300 bg-gray-200 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider ${col.sortable !== false ? 'cursor-pointer hover:bg-gray-300' : ''}`}
                        >
                          {col.header} {getSortIndicator(col.key)}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {currentData.length > 0 ? (
                      currentData.map((item, rowIndex) => (
                        <tr key={item.id || rowIndex} className="hover:bg-gray-50 border-b border-gray-200">
                          {showMultiSelect && (
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                              <input
                                type="checkbox"
                                checked={selectedItems.includes(item.id)}
                                onChange={(e) => handleItemCheckboxChange(e, item.id)}
                                className="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out"
                              />
                            </td>
                          )}
                          {columns.map(col => (
                            <td key={col.key} className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                              {col.key === 'serialNo' ? (
                                (currentPage - 1) * itemsPerPage + rowIndex + 1
                              ) : col.render ? (
                                col.render(item)
                              ) : (
                                item[col.key]
                              )}
                            </td>
                          ))}
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan={columns.length + (showMultiSelect ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                          {translations.noDailyPaymentData}
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              {/* Pagination Controls */}
              <div className="flex justify-between items-center mt-4">
                <button
                  onClick={() => handlePageChange(currentPage - 1)}
                  disabled={currentPage === 1}
                  className={`pagination-button ${currentPage === 1 ? 'inactive' : 'active'}`}
                >
                  {translations.previous}
                </button>
                <span className="text-gray-700">
                  Page {currentPage} of {totalPages}
                </span>
                <button
                  onClick={() => handlePageChange(currentPage + 1)}
                  disabled={currentPage === totalPages}
                  className={`pagination-button ${currentPage === totalPages ? 'inactive' : 'active'}`}
                >
                  {translations.next}
                </button>
              </div>
            </div>
          );
        };

        // Modals for Add/Edit Branch, User, Payment Method
        const Modal = ({ title, isOpen, onClose, children }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className="relative p-8 bg-white rounded-lg shadow-xl max-w-md w-full m-4">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800">{title}</h3>
                        {children}
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl"
                        >
                            &times;
                        </button>
                    </div>
                </div>
            );
        };

        const BranchForm = ({ branch, onSave, onCancel, translations }) => {
          const [name, setName] = useState(branch?.name || '');
          const [location, setLocation] = useState(branch?.location || '');
          const { setMessage } = useAppContext();

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!name.trim() || !location.trim()) {
              setMessage(translations.pleaseEnterBranchNameAndLocation);
              return;
            }
            onSave(name, location);
          };

          return (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="branchName" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name}:
                </label>
                <input
                  type="text"
                  id="branchName"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder={translations.branchNamePlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="branchLocation" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.location}:
                </label>
                <input
                  type="text"
                  id="branchLocation"
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                  placeholder={translations.branchLocationPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={onCancel}
                  className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                  {translations.cancel}
                </button>
                <button
                  type="submit"
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                >
                  {translations.saveChanges}
                </button>
              </div>
            </form>
          );
        };

        // UserForm Component
        const UserForm = ({ user, onSave, onCancel, branches, translations, setMessage, adminResetUserPassword }) => {
          const [name, setName] = useState(user?.name || '');
          const [nameAr, setNameAr] = useState(user?.nameAr || '');
          const [email, setEmail] = useState(user?.email || '');
          const [role, setRole] = useState(user?.role || '');
          const [branchId, setBranchId] = useState(user?.branchId || '');
          const [targetAmount, setTargetAmount] = useState(user?.targetAmount || '');
          const [employeeNumber, setEmployeeNumber] = useState(user?.employeeNumber || '');
          const [imageUrl, setImageUrl] = useState(user?.imageUrl || '');
          const [newPassword, setNewPassword] = useState(''); // For admin to set temporary password
          const [confirmPassword, setConfirmPassword] = useState(''); // For admin to confirm temporary password

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!name.trim() || !email.trim() || !role.trim()) {
              setMessage(translations.pleaseFillAllUserFields);
              return;
            }
            if ((role === 'supervisor' || role === 'employee' || role === 'manager' || role === 'partner') && !branchId) { // Added new roles
              setMessage(translations.pleaseSelectBranchForSupervisorEmployee);
              return;
            }

            onSave({
              name,
              nameAr,
              email,
              role,
              branchId: (role === 'admin' ? '' : branchId), // Admin doesn't need a branchId
              targetAmount: (role === 'employee' ? parseFloat(targetAmount) : 0),
              employeeNumber,
              imageUrl,
            });
          };

          // Handle Admin Password Reset
          const handlePasswordReset = async () => {
              if (!newPassword || !confirmPassword) {
                  setMessage(translations.pleaseFillAllFields);
                  return;
              }
              if (newPassword !== confirmPassword) {
                  setMessage(translations.passwordMismatch);
                  return;
              }
              if (user && user.id) {
                  // Call the adminResetUserPassword function from AppContext
                  const success = await adminResetUserPassword(user.id, newPassword);
                  if (success) {
                      setNewPassword('');
                      setConfirmPassword('');
                  }
              }
          };


          return (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="userName" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name} ({translations.en}):
                </label>
                <input
                  type="text"
                  id="userName"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder={translations.userNamePlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="userNameAr" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name} ({translations.ar}):
                </label>
                <input
                  type="text"
                  id="userNameAr"
                  value={nameAr}
                  onChange={(e) => setNameAr(e.target.value)}
                  placeholder={translations.userNameArPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label htmlFor="userEmail" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.emailPlaceholder}:
                </label>
                <input
                  type="email"
                  id="userEmail"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder={translations.userEmailPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="employeeNumber" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.employeeNumber}:
                </label>
                <input
                  type="text"
                  id="employeeNumber"
                  value={employeeNumber}
                  onChange={(e) => setEmployeeNumber(e.target.value)}
                  placeholder={translations.employeeNo}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label htmlFor="userRole" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.role}:
                </label>
                <select
                  id="userRole"
                  value={role}
                  onChange={(e) => {
                    setRole(e.target.value);
                    if (e.target.value === 'admin') {
                      setBranchId('');
                      setTargetAmount('');
                    } else if (e.target.value === 'supervisor' || e.target.value === 'manager' || e.target.value === 'partner') { // Added new roles
                      setTargetAmount('');
                    }
                  }}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                >
                  <option value="">{translations.selectRole}</option>
                  <option value="admin">{translations.admin}</option>
                  <option value="supervisor">{translations.supervisor}</option>
                  <option value="employee">{translations.employeeRole}</option>
                  <option value="manager">{translations.manager}</option>
                  <option value="partner">{translations.partner}</option>
                </select>
              </div>
              {(role === 'supervisor' || role === 'employee' || role === 'manager' || role === 'partner') && ( // Added new roles
                <div>
                  <label htmlFor="userBranch" className="block text-gray-700 text-sm font-bold mb-2">
                    {translations.branch}:
                  </label>
                  <select
                    id="userBranch"
                    value={branchId}
                    onChange={(e) => setBranchId(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    required
                  >
                    <option value="">{translations.selectBranch}</option>
                    {branches.map(branch => (
                      <option key={branch.id} value={branch.id}>{branch.name}</option>
                    ))}
                  </select>
                </div>
              )}
              {role === 'employee' && (
                <div>
                  <label htmlFor="targetAmount" className="block text-gray-700 text-sm font-bold mb-2">
                    {translations.targetAmountSar}:
                  </label>
                  <input
                    type="number"
                    id="targetAmount"
                    value={targetAmount}
                    onChange={(e) => setTargetAmount(e.target.value)}
                    placeholder="0.00"
                    step="0.01"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              )}
              <div>
                <label htmlFor="imageUrl" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.imageUrl}:
                </label>
                <input
                  type="text"
                  id="imageUrl"
                  value={imageUrl}
                  onChange={(e) => setImageUrl(e.target.value)}
                  placeholder="https://example.com/image.jpg"
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={onCancel}
                  className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                  {translations.cancel}
                </button>
                <button
                  type="submit"
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                >
                  {translations.saveChanges}
                </button>
              </div>

              {/* Admin Password Reset Section (visible only when editing an existing user) */}
              {user && (
                  <div className="border-t border-gray-200 mt-6 pt-4 space-y-3">
                      <h4 className="text-xl font-semibold text-gray-800">{translations.changePassword}</h4>
                      <div>
                          <label htmlFor="newPassword" className="block text-gray-700 text-sm font-bold mb-2">
                              {translations.enterNewPassword}:
                          </label>
                          <input
                              type="password"
                              id="newPassword"
                              value={newPassword}
                              onChange={(e) => setNewPassword(e.target.value)}
                              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Set temporary password"
                          />
                      </div>
                      <div>
                          <label htmlFor="confirmNewPassword" className="block text-gray-700 text-sm font-bold mb-2">
                              {translations.confirmNewPassword}:
                          </label>
                          <input
                              type="password"
                              id="confirmNewPassword"
                              value={confirmPassword}
                              onChange={(e) => setConfirmPassword(e.target.value)}
                              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Confirm temporary password"
                          />
                      </div>
                      <button
                          type="button"
                          onClick={handlePasswordReset}
                          className="w-full bg-orange-500 text-white py-2 rounded-lg font-semibold hover:bg-orange-600 transition duration-300"
                      >
                          {translations.changePassword}
                      </button>
                  </div>
              )}
            </form>
          );
        };

        const EditPaymentForm = ({ payment, onSave, onCancel, users, branches, paymentMethods, translations, getUserDetails, getPaymentMethodDetails }) => {
            const [amount, setAmount] = useState(payment?.amount || '');
            const [paymentMethod, setPaymentMethod] = useState(payment?.paymentMethod || '');
            const [employeeId, setEmployeeId] = useState(payment?.employeeId || '');
            const [branchId, setBranchId] = useState(payment?.branchId || '');
            const { setMessage } = useAppContext();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0 || !paymentMethod || !employeeId || !branchId) {
                    setMessage(translations.pleaseFillAllPaymentFields);
                    return;
                }
                onSave({
                    amount: parseFloat(amount),
                    paymentMethod,
                    employeeId,
                    branchId,
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="paymentAmount" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.paymentAmountSar}:
                        </label>
                        <input
                            type="number"
                            id="paymentAmount"
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            placeholder="0.00"
                            step="0.01"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="paymentMethod" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.paymentMethod}:
                        </label>
                        <select
                            id="paymentMethod"
                            value={paymentMethod}
                            onChange={(e) => setPaymentMethod(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectPaymentMethod}</option>
                            {paymentMethods.map(method => (
                                <option key={method.id} value={method.name}>{getPaymentMethodDetails(method.name)}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label htmlFor="paymentEmployee" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.employee}:
                        </label>
                        <select
                            id="paymentEmployee"
                            value={employeeId}
                            onChange={(e) => setEmployeeId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectEmployee}</option>
                            {users.filter(u => u.role === 'employee').map(user => (
                                <option key={user.id} value={user.id}>{getUserDetails(user.id)}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label htmlFor="paymentBranch" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.branch}:
                        </label>
                        <select
                            id="paymentBranch"
                            value={branchId}
                            onChange={(e) => setBranchId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectBranch}</option>
                            {branches.map(branch => (
                                <option key={branch.id} value={branch.id}>{branch.name}</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                        >
                            {translations.cancel}
                        </button>
                        <button
                            type="submit"
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                        >
                            {translations.saveChanges}
                        </button>
                    </div>
                </form>
            );
        };

        const PaymentMethodForm = ({ method, onSave, onCancel, translations, setMessage }) => {
            const [name, setName] = useState(method?.name || '');
            const [nameAr, setNameAr] = useState(method?.nameAr || '');
            const [icon, setIcon] = useState(method?.icon || '');
            const [color, setColor] = useState(method?.color || '#000000');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) {
                    setMessage(translations.pleaseEnterMethodName);
                    return;
                }
                onSave(name, nameAr, icon, color);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="methodName" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.name} ({translations.en}):
                        </label>
                        <input
                            type="text"
                            id="methodName"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder={translations.methodNamePlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="methodNameAr" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.name} ({translations.ar}):
                        </label>
                        <input
                            type="text"
                            id="methodNameAr"
                            value={nameAr}
                            onChange={(e) => setNameAr(e.target.value)}
                            placeholder={translations.methodNameArPlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label htmlFor="methodIcon" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.icon}: (e.g., 💰, 💳, 🏦)
                        </label>
                        <input
                            type="text"
                            id="methodIcon"
                            value={icon}
                            onChange={(e) => setIcon(e.target.value)}
                            placeholder={translations.methodIconPlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label htmlFor="methodColor" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.color}:
                        </label>
                        <input
                            type="color"
                            id="methodColor"
                            value={color}
                            onChange={(e) => setColor(e.target.value)}
                            className="w-full h-10 p-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                        >
                            {translations.cancel}
                        </button>
                        <button
                            type="submit"
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                        >
                            {translations.saveChanges}
                        </button>
                    </div>
                </form>
            );
        };


        // Supervisor Dashboard Component - ENHANCED (copied as is)
        const SupervisorDashboard = () => {
          const { currentUser, users, payments, paymentMethods, addPayment, translations, setMessage, getPaymentMethodDetails, getEmployeeName } = useAppContext();
          const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
          const [selectedPaymentMethod, setSelectedPaymentMethod] = useState('');
          const [last5Payments, setLast5Payments] = useState([]);
          const [approvedFlash, setApprovedFlash] = useState(false);
          const [isNumpadOpen, setIsNumpadOpen] = useState(false);
          const [currentNumpadValue, setCurrentNumpadValue] = useState('');
          const [flashEmployeeSelection, setFlashEmployeeSelection] = useState(false);
          const [flashPaymentMethodSelection, setFlashPaymentMethodSelection] = useState(false);
          const [flashAmountInput, setFlashAmountInput] = useState(false);

          const employeesInBranch = users.filter(user => user.branchId === currentUser.branchId && user.role === 'employee');

          useEffect(() => {
              if (selectedEmployeeId) {
                  const employeePayments = payments
                      .filter(p => p.employeeId === selectedEmployeeId)
                      .sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0))
                      .slice(0, 5);
                  setLast5Payments(employeePayments);
              } else {
                  setLast5Payments([]);
              }
          }, [selectedEmployeeId, payments]);

          const handleEmployeeSelect = (employeeId) => {
              setSelectedEmployeeId(employeeId);
              setSelectedPaymentMethod('');
              setCurrentNumpadValue('');
              setIsNumpadOpen(false);
              setFlashEmployeeSelection(false);
              setFlashPaymentMethodSelection(true);
              setFlashAmountInput(false);
          };

          const handlePaymentMethodClick = (methodName) => {
              setSelectedPaymentMethod(methodName);
              setCurrentNumpadValue('');
              setIsNumpadOpen(true);
              setFlashPaymentMethodSelection(false);
              setFlashAmountInput(true);
          };

          const handleNumpadConfirm = async () => {
              const amount = parseFloat(currentNumpadValue);
              if (isNaN(amount) || amount <= 0) {
                  setMessage(translations.pleaseEnterValidAmount);
                  return;
              }
              await addPayment(currentUser.branchId, selectedEmployeeId, amount, selectedPaymentMethod, currentUser.id);
              setMessage(translations.paymentAddedSuccessfully);
              setApprovedFlash(true);
              setTimeout(() => setApprovedFlash(false), 1500);

              setSelectedEmployeeId('');
              setSelectedPaymentMethod('');
              setCurrentNumpadValue('');
              setIsNumpadOpen(false);
              setFlashAmountInput(false);
              setFlashEmployeeSelection(true);
          };

          const handleNumpadCancel = () => {
              setCurrentNumpadValue('');
              setIsNumpadOpen(false);
              setMessage(translations.amountEntryCancelled);
              setFlashAmountInput(false);
              setFlashPaymentMethodSelection(true);
          };

          const handleNumpadInput = (value) => {
              setCurrentNumpadValue(prev => {
                  if (value === '.' && prev.includes('.')) return prev;
                  if (prev === '0' && value !== '.') return value;
                  if (prev.includes('.') && prev.split('.')[1].length >= 2) return prev;
                  return prev + value;
              });
          };

          const handleNumpadDelete = () => {
              setCurrentNumpadValue(prev => prev.slice(0, -1));
          };

          useEffect(() => {
            setFlashEmployeeSelection(true);
          }, []);


          return (
            <div className="supervisor-dashboard space-y-6 flex flex-col md:flex-row gap-6">
              {/* Left Column: Employee Selection & Payment Entry */}
              <div className="flex-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 className="text-3xl font-bold text-gray-800 mb-4">{translations.supervisorDashboard}</h2>
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.addEmployeePayment}</h3>

                {/* Employee Selection */}
                <div className={`space-y-4 p-4 rounded-lg border-2 ${flashEmployeeSelection ? 'flash-border-green' : 'border-transparent'}`}>
                  <label htmlFor="selectEmployee" className="block text-gray-700 text-lg font-bold mb-2">
                    {translations.selectEmployee}
                  </label>
                  <div className="selection-grid">
                      {employeesInBranch.length > 0 ? (
                          employeesInBranch.map(employee => (
                              <div
                                  key={employee.id}
                                  onClick={() => handleEmployeeSelect(employee.id)}
                                  className={`selection-card ${selectedEmployeeId === employee.id ? 'selected' : ''} ${flashEmployeeSelection && selectedEmployeeId !== employee.id ? 'dimmed' : ''}`}
                              >
                                  <img
                                      src={employee.imageUrl || `https://placehold.co/100x100/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${employee.name.substring(0,2).toUpperCase()}`}
                                      alt={employee.name}
                                      className="h-16 w-16 rounded-full object-cover mb-2"
                                      onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/cccccc/000000?text=${employee.name.substring(0,2).toUpperCase()}`; }}
                                  />
                                  <p className="text-sm font-semibold text-gray-800 text-center">{getEmployeeName(employee.id)}</p>
                              </div>
                          ))
                      ) : (
                          <p className="col-span-full text-center text-gray-500">{translations.noEmployeesInBranch}</p>
                      )}
                  </div>
                </div>

                {selectedEmployeeId && (
                  <>
                  {/* Payment Method Selection */}
                  <div className={`mt-6 space-y-4 p-4 rounded-lg border-2 ${flashPaymentMethodSelection ? 'flash-border-green' : 'border-transparent'}`}>
                    <label className="block text-gray-700 text-lg font-bold mb-2">
                      {translations.selectPaymentMethod} {getEmployeeName(selectedEmployeeId)}
                    </label>
                    <div className="flex flex-wrap gap-3">
                        {paymentMethods.map(method => (
                            <button
                                key={method.id}
                                type="button"
                                onClick={() => handlePaymentMethodClick(method.name)}
                                className={`selection-card payment-method-card
                                    ${selectedPaymentMethod === method.name ? 'selected' : ''}
                                    ${flashPaymentMethodSelection && selectedPaymentMethod !== method.name ? 'dimmed' : ''}
                                `}
                                style={{ backgroundColor: selectedPaymentMethod === method.name ? method.color : '' }}
                            >
                                <span className="payment-method-icon" style={{ color: selectedPaymentMethod === method.name ? 'white' : method.color }}>{method.icon}</span>
                                <span className={`text-lg font-semibold ${selectedPaymentMethod === method.name ? 'text-white' : 'text-gray-800'}`}>
                                    {translations.language === 'ar' && method.nameAr ? method.nameAr : method.name}
                                </span>
                            </button>
                        ))}
                    </div>
                  </div>
                  </>
                )}

                {selectedPaymentMethod && isNumpadOpen && (
                    <div className={`mt-6 bg-gray-50 p-6 rounded-lg shadow-inner border-2 ${flashAmountInput ? 'flash-border-green' : 'border-transparent'}`}>
                        <h4 className="text-xl font-semibold text-gray-800 mb-4">{translations.enterAmount}</h4>
                        <input
                            type="text"
                            value={`ريال ${currentNumpadValue}`}
                            readOnly
                            className="w-full p-3 border border-gray-300 rounded-lg text-2xl font-bold text-center mb-4 bg-white calculator-display"
                        />
                        <div className="grid grid-cols-3 gap-2 calculator-buttons">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                <button key={num} onClick={() => handleNumpadInput(String(num))} className="bg-gray-200 hover:bg-gray-300 p-4 rounded-lg text-xl font-bold transition duration-200 shadow-md calc-button">
                                    {num}
                                </button>
                            ))}
                            <button onClick={() => handleNumpadInput('0')} className="bg-olive-200 hover:bg-olive-300 p-4 rounded-lg text-xl font-bold transition duration-200 shadow-md calc-button">0</button>
				{/*<button onClick={() => handleNumpadInput('.')} className="bg-cyan-200 hover:bg-cyan-300 p-4 rounded-lg text-xl font-bold transition duration-200 shadow-md calc-button">.</button>*/}
                            <button onClick={handleNumpadDelete} className="bg-orange-400 hover:bg-orange-500 text-white p-4 rounded-lg text-xl font-bold transition duration-200 shadow-md calc-button action">DEL</button>
                        </div>
                        <div className="flex justify-between mt-4 space-x-2 calc-bottom-actions">
                            <button onClick={handleNumpadCancel} className="bg-red-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-600 flex-grow transition duration-200 shadow-md calc-button cancel">
                                {translations.cancel}
                            </button>
                            <button onClick={handleNumpadConfirm} className="bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 flex-grow transition duration-200 shadow-md calc-button done">
                                {translations.add}
                            </button>
                        </div>
                    </div>
                )}

                {approvedFlash && (
                    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                        <div className="bg-white p-8 rounded-lg shadow-2xl flex flex-col items-center">
                            <i className="fas fa-check-circle text-darkgreen-700 text-6xl mb-4 animate-bounce"></i>
                            <p className="text-3xl font-bold text-darkgreen-800">{translations.approved}</p>
                        </div>
                    </div>
                )}
              </div>

              {/* Right Column: Employee Details Section */}
              {selectedEmployeeId && (
                <div className="flex-1 employee-details-section">
                    <h3>{getEmployeeName(selectedEmployeeId)}'s Activity</h3>
			{/*<div className="detail-item">
                        <span>{translations.totalEarned} ({translations.today}):</span> <strong id="employee-daily-orders">
                            SAR {payments.filter(p => p.employeeId === selectedEmployeeId && p.timestamp?.toDateString() === new Date().toDateString()).reduce((acc, p) => acc + p.amount, 0).toFixed(2)}
                        </strong>
                    </div>*/}
                    <h4 className="text-lg font-semibold text-gray-800 mb-2">{translations.last5PaymentsFor} {getEmployeeName(selectedEmployeeId)}:</h4>
                    <div className="recent-payments-list">
                        <table className="min-w-full">
                            <thead>
                                <tr>
                                    <th>{translations.time}</th>
                                    <th>{translations.amount}</th>
                                    <th>{translations.method}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {last5Payments.length > 0 ? (
                                    last5Payments.map(p => (
                                        <tr key={p.id}>
                                            <td>{p.timestamp?.toLocaleTimeString()}</td>
                                            <td>SAR {p.amount?.toFixed(2)}</td>
                                            <td>{getPaymentMethodDetails(p.paymentMethod)}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr>
                                        <td colSpan="3" className="text-center text-gray-500 text-sm">{translations.noDailyPaymentData}</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
              )}
            </div>
          );
        };

        //
        // Employee Dashboard Component
        const EmployeeDashboard = () => {
          const { currentUser, users, payments, expenses, bonuses, translations, getPaymentMethodDetails, getBranchName, changeCurrentUserPassword, setMessage } = useAppContext();

          const currentLocalDate = new Date();
          const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
          const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());
          const [isChangePasswordModalOpen, setIsChangePasswordModalOpen] = useState(false);


          // Filter payments for the current employee for the selected month/year
          const employeePayments = payments.filter(p =>
            p.employeeId === currentUser.id &&
            p.timestamp &&
            p.timestamp.getMonth() === selectedMonth &&
            p.timestamp.getFullYear() === selectedYear
          );

          // Filter expenses for the current employee for the selected month/year
          const employeeExpenses = expenses.filter(e =>
            e.employeeId === currentUser.id &&
            e.timestamp &&
            e.timestamp.getMonth() === selectedMonth &&
            e.timestamp.getFullYear() === selectedYear
          );

          // Filter bonuses for the current employee for the selected month/year
          const employeeBonuses = bonuses.filter(b =>
            b.employeeId === currentUser.id &&
            b.timestamp &&
            b.timestamp.getMonth() === selectedMonth &&
            b.timestamp.getFullYear() === selectedYear
          );

          // Calculate total earned for the month
          const totalEarned = employeePayments.reduce((acc, p) => acc + p.amount, 0);

          // Calculate total expenses for the month
          const totalExpenses = employeeExpenses.reduce((acc, e) => acc + e.amount, 0);

          // Calculate total bonuses for the month
          const totalBonuses = employeeBonuses.reduce((acc, b) => acc + b.amount, 0);

          // Calculate net income
          const netIncome = totalEarned + totalBonuses - totalExpenses;

          // Columns for employee payments history table (no timestamp)
          const employeePaymentColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.method, key: 'method', render: (item) => getPaymentMethodDetails(item.paymentMethod) },
          ];

          // Columns for employee expenses history table
          const employeeExpenseColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
            { header: translations.expenseAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.description, key: 'description' },
          ];

           // Columns for employee bonuses history table
           const employeeBonusColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.bonusAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.description, key: 'description' },
          ];


          const months = [
            translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
            translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
          ];
          const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

          // NEW FUNCTION: Generate Employee Monthly Report PDF
          const generateEmployeeReportPdf = async () => {
            const doc = new jspdf.jsPDF();
            const monthName = months[selectedMonth];
            const fileName = `${translations.employeeReportPdf}_${currentUser.name.replace(/\s/g, '_')}_${monthName}_${selectedYear}.pdf`;

            // Report Title
            doc.setFontSize(22);
            doc.text(translations.reportTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.text(`${translations.reportFor}: ${monthName}, ${selectedYear}`, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
            doc.text(`${translations.generatedOn}: ${new Date().toLocaleString()}`, doc.internal.pageSize.getWidth() / 2, 37, { align: 'center' });

            let y = 50;

            // Employee Details
            doc.setFontSize(16);
            doc.text(translations.employeeDetails, 14, y);
            y += 7;
            doc.setFontSize(12);
            doc.text(`${translations.employeeName}: ${currentUser.name}`, 14, y); y += 7;
            doc.text(`${translations.employeeNumber}: ${currentUser.employeeNumber}`, 14, y); y += 7;
            doc.text(`${translations.branch}: ${getBranchName(currentUser.branchId)}`, 14, y); y += 7;
            doc.text(`${translations.target}: SAR ${currentUser.targetAmount?.toFixed(2) || '0.00'}`, 14, y); y += 15;

            // Summary Section
            doc.setFontSize(16);
            doc.text("Summary", 14, y);
            y += 7;
            doc.setFontSize(12);
            doc.text(`${translations.totalPayments}: SAR ${totalEarned.toFixed(2)}`, 14, y); y += 7;
            doc.text(`${translations.totalExpensesSummary}: SAR ${totalExpenses.toFixed(2)}`, 14, y); y += 7;
            doc.text(`${translations.totalBonusesSummary}: SAR ${totalBonuses.toFixed(2)}`, 14, y); y += 7;
            doc.text(`${translations.netIncomeSummary}: SAR ${netIncome.toFixed(2)}`, 14, y); y += 15;

            // Payments Summary Table
            doc.autoTable({
                startY: y,
                head: [[translations.serialNo, translations.timestamp, translations.method, translations.amount]],
                body: employeePayments.map((p, index) => [
                    index + 1,
                    p.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }),
                    getPaymentMethodDetails(p.paymentMethod),
                    `SAR ${p.amount?.toFixed(2)}`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [48, 113, 169], textColor: 255, fontStyle: 'bold' },
                styles: { font: 'Inter', fontSize: 10, cellPadding: 3 },
                margin: { left: 14, right: 14 },
                didDrawPage: function (data) {
                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            y = doc.autoTable.previous.finalY + 15;

            // Expenses Summary Table
            doc.setFontSize(16);
            doc.text(translations.expensesSummary, 14, y);
            y += 5;
            doc.autoTable({
                startY: y,
                head: [[translations.serialNo, translations.timestamp, translations.expenseType, translations.description, translations.amount]],
                body: employeeExpenses.map((e, index) => [
                    index + 1,
                    e.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }),
                    translations[e.type] || e.type,
                    e.description,
                    `SAR ${e.amount?.toFixed(2)}`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [220, 38, 38], textColor: 255, fontStyle: 'bold' }, // Red theme
                styles: { font: 'Inter', fontSize: 10, cellPadding: 3 },
                margin: { left: 14, right: 14 },
                didDrawPage: function (data) {
                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            y = doc.autoTable.previous.finalY + 15;

            // Bonuses Summary Table
            doc.setFontSize(16);
            doc.text(translations.bonusesSummary, 14, y);
            y += 5;
            doc.autoTable({
                startY: y,
                head: [[translations.serialNo, translations.timestamp, translations.description, translations.amount]],
                body: employeeBonuses.map((b, index) => [
                    index + 1,
                    b.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }),
                    b.description,
                    `SAR ${b.amount?.toFixed(2)}`
                ]),
                theme: 'striped',
                headStyles: { fillColor: [22, 163, 74], textColor: 255, fontStyle: 'bold' }, // Green theme
                styles: { font: 'Inter', fontSize: 10, cellPadding: 3 },
                margin: { left: 14, right: 14 },
                didDrawPage: function (data) {
                    // Footer
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            if (employeePayments.length === 0 && employeeExpenses.length === 0 && employeeBonuses.length === 0) {
                doc.addPage(); // Add a new page if no data, to ensure message is visible
                doc.setFontSize(14);
                doc.text(translations.noDataForReport, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, { align: 'center' });
            }

            doc.save(fileName);
            setMessage(`${translations.employeeReportPdf} generated successfully!`);
          };


          return (
            <div className="employee-dashboard space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">{translations.employeeDashboard}</h2>

              {/* Month/Year Selection */}
              <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center justify-center">
                  <h3 className="text-xl font-semibold text-gray-800">{translations.selectMonthYear}:</h3>
                  <select
                      value={selectedMonth}
                      onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                      className="p-2 border rounded-md"
                  >
                      {months.map((monthName, index) => (
                          <option key={index} value={index}>{monthName}</option>
                      ))}
                  </select>
                  <select
                      value={selectedYear}
                      onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                      className="p-2 border rounded-md"
                  >
                      {years.map(year => (
                          <option key={year} value={year}>{year}</option>
                      ))}
                  </select>
                  {/* NEW: Download PDF Report Button */}
                  <button
                      onClick={generateEmployeeReportPdf}
                      className="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 shadow-md"
                  >
                      {translations.downloadEmployeeReport}
                  </button>
              </div>

              {/* Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-lg shadow-md text-center">
                  <h3 className="text-xl font-semibold text-gray-800 mb-2">{translations.yourBranch}</h3>
                  <p className="text-2xl font-bold text-blue-600">{getBranchName(currentUser.branchId) || translations.mainBranch}</p>
                </div>
                <div className="bg-purple-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-purple-800 mb-2">{translations.yourTarget}</h3>
                  <p className="text-3xl font-bold text-purple-700">SAR {currentUser.targetAmount?.toFixed(2) || '0.00'}</p>
                </div>
                <div className="bg-green-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-green-800 mb-2">{translations.totalEarned}</h3>
                  <p className="text-3xl font-bold text-green-700">SAR {totalEarned.toFixed(2)}</p>
                </div>
                <div className="bg-blue-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-blue-800 mb-2">{translations.remainingToTarget}</h3>
                  <p className="text-3xl font-bold text-blue-700">SAR {(currentUser.targetAmount - totalEarned).toFixed(2)}</p>
                </div>
                <div className="bg-red-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-red-800 mb-2">{translations.totalExpenses}</h3>
                  <p className="text-3xl font-bold text-red-700">SAR {totalExpenses.toFixed(2)}</p>
                </div>
                <div className="bg-yellow-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-yellow-800 mb-2">{translations.totalBonuses}</h3>
                  <p className="text-3xl font-bold text-yellow-700">SAR {totalBonuses.toFixed(2)}</p>
                </div>
                <div className="bg-indigo-50 p-6 rounded-lg shadow-inner text-center col-span-full md:col-span-2">
                    <h3 className="text-xl font-semibold text-indigo-800 mb-2">{translations.netIncome}</h3>
                    <p className="text-4xl font-bold text-indigo-700">SAR {netIncome.toFixed(2)}</p>
                </div>
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourPaymentsHistory}</h3>
                <PaginatedTable
                  data={employeePayments}
                  columns={employeePaymentColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  getPaymentMethodDetails={getPaymentMethodDetails}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourExpensesHistory}</h3>
                <PaginatedTable
                  data={employeeExpenses}
                  columns={employeeExpenseColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourBonusesHistory}</h3>
                <PaginatedTable
                  data={employeeBonuses}
                  columns={employeeBonusColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>

              {/* Change Password Button for User */}
              <div className="p-6 bg-white rounded-lg shadow-lg text-center">
                  <button
                      onClick={() => setIsChangePasswordModalOpen(true)}
                      className="bg-orange-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-600 transition duration-300 shadow-md"
                  >
                      {translations.changePassword}
                  </button>
              </div>

              <ChangePasswordModal
                  isOpen={isChangePasswordModalOpen}
                  onClose={() => setIsChangePasswordModalOpen(false)}
                  onSave={changeCurrentUserPassword}
                  translations={translations}
                  setMessage={setMessage}
              />
            </div>
          );
        };

        // ChangePasswordModal Component
        const ChangePasswordModal = ({ isOpen, onClose, onSave, translations, setMessage }) => {
            const [newPassword, setNewPassword] = useState('');
            const [confirmNewPassword, setConfirmNewPassword] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newPassword || !confirmNewPassword) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    setMessage(translations.passwordMismatch);
                    return;
                }
                const success = await onSave(newPassword);
                if (success) {
                    setNewPassword('');
                    setConfirmNewPassword('');
                    onClose();
                }
            };

            return (
                <Modal
                    title={translations.changePassword}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="newPassword" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.enterNewPassword}:
                            </label>
                            <input
                                type="password"
                                id="newPassword"
                                value={newPassword}
                                onChange={(e) => setNewPassword(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="confirmNewPassword" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.confirmNewPassword}:
                            </label>
                            <input
                                type="password"
                                id="confirmNewPassword"
                                value={confirmNewPassword}
                                onChange={(e) => setConfirmNewPassword(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        // Expose components globally
        window.App = window.App || {};
        window.App.Modal = Modal;
        window.App.PaginatedTable = PaginatedTable;
        window.App.BranchForm = BranchForm;
        window.App.UserForm = UserForm;
        window.App.EditPaymentForm = EditPaymentForm;
        window.App.PaymentMethodForm = PaymentMethodForm;
        window.App.SupervisorDashboard = SupervisorDashboard;
        window.App.EmployeeDashboard = EmployeeDashboard;
        window.App.ChangePasswordModal = ChangePasswordModal;

        // Render the App component into the root div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
<script type="text/babel">
        // This file continues the React components from the previous part (Piece 1).
        // It's structured this way to adhere to the line limit per immersive block.

        // Expose components globally for AdminDashboard to use (continued from previous part)
        // These are re-exposed here for clarity, assuming this script runs immediately after the previous.
        window.App = window.App || {};
        const { Modal, PaginatedTable, BranchForm, UserForm, EditPaymentForm, PaymentMethodForm, SupervisorDashboard, EmployeeDashboard, ChangePasswordModal } = window.App;


        // NEW COMPONENTS AND FUNCTIONS FOR ADMIN AND EMPLOYEE DASHBOARDS
        // These were previously defined but are now part of this phase's output.

        const DailySummaryTable = ({ payments, users, branches, paymentMethods, translations, getEmployeeName, getBranchName, getPaymentMethodDetails, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const employee = users.find(u => u.id === payment.employeeId);
                const branch = branches.find(b => b.id === payment.branchId);
                const key = `${payment.employeeId}-${payment.branchId}`;

                if (!acc[key]) {
                    acc[key] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const MonthlySummaryTable = ({ payments, users, branches, paymentMethods, translations, getEmployeeName, getBranchName, getPaymentMethodDetails, selectedMonth, selectedYear, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            );

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const employee = users.find(u => u.id === payment.employeeId);
                const branch = branches.find(b => b.id === payment.branchId);
                const key = `${payment.employeeId}-${payment.branchId}`;

                if (!acc[key]) {
                    acc[key] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const DailyEmployeeSummary = ({ payments, users, translations, getEmployeeName, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                if (!acc[payment.employeeId]) {
                    acc[payment.employeeId] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        totalEarned: 0,
                        cash: 0,
                        madaPay: 0,
                    };
                }
                acc[payment.employeeId].totalEarned += payment.amount;
                if (payment.paymentMethod === 'Cash') {
                    acc[payment.employeeId].cash += payment.amount;
                } else if (payment.paymentMethod === 'Mada Pay') {
                    acc[payment.employeeId].madaPay += payment.amount;
                }
                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.totalEarned, key: 'totalEarned', render: (item) => `SAR ${item.totalEarned.toFixed(2)}`, sortable: true },
                { header: translations.cash, key: 'cash', render: (item) => `SAR ${item.cash.toFixed(2)}`, sortable: true },
                { header: translations.mada, key: 'madaPay', render: (item) => `SAR ${item.madaPay.toFixed(2)}`, sortable: true },
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                totalEarned: (a, b, direction) => direction === 'asc' ? a.totalEarned - b.totalEarned : b.totalEarned - a.totalEarned,
                cash: (a, b, direction) => direction === 'asc' ? a.cash - b.cash : b.cash - a.cash,
                madaPay: (a, b, direction) => direction === 'asc' ? a.madaPay - b.madaPay : b.madaPay - a.madaPay,
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const DailyBranchesSummary = ({ payments, branches, paymentMethods, translations, getBranchName, getPaymentMethodDetails, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const branch = branches.find(b => b.id === payment.branchId);
                const key = payment.branchId;

                if (!acc[key]) {
                    acc[key] = {
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.branchName + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const MonthlyBranchesIncome = ({ payments, branches, paymentMethods, translations, getBranchName, getPaymentMethodDetails, selectedMonth, selectedYear, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            );

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const branch = branches.find(b => b.id === payment.branchId);
                const key = payment.branchId;

                if (!acc[key]) {
                    acc[key] = {
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.branchName + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const AddEditExpenseModal = ({ isOpen, onClose, expense, onSave, employeeId, translations, setMessage, selectedMonth, selectedYear }) => {
            const [type, setType] = useState(expense?.type || '');
            const [amount, setAmount] = useState(expense?.amount || '');
            const [description, setDescription] = useState(expense?.description || '');
            const [recordMonth, setRecordMonth] = useState(expense?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(expense?.year || selectedYear);


            useEffect(() => {
                if (expense) {
                    setType(expense.type);
                    setAmount(expense.amount);
                    setDescription(expense.description);
                    setRecordMonth(expense.month);
                    setRecordYear(expense.year);
                } else {
                    setType('');
                    setAmount('');
                    setDescription('');
                    // Pre-fill with current selected month/year from admin financials filter
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [expense, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type || !amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(employeeId, type, parseFloat(amount), description, recordMonth, recordYear);
            };

            const expenseTypes = [
                'rental', 'electricity', 'bill', 'tickets', 'internet', 'consumables', 'penalties', 'loans'
            ];

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


            return (
                <Modal
                    title={expense ? translations.editExpense : translations.addExpense}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="expenseType" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseType}:
                            </label>
                            <select
                                id="expenseType"
                                value={type}
                                onChange={(e) => setType(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">{translations.selectEmployee}</option>
                                {expenseTypes.map(expType => (
                                    <option key={expType} value={expType}>{translations[expType] || expType}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="expenseAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseAmount}:
                            </label>
                            <input
                                type="number"
                                id="expenseAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="expenseDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="expenseDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="expenseMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="expenseMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="expenseYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="expenseYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const AddEditBonusModal = ({ isOpen, onClose, bonus, onSave, employeeId, translations, setMessage, selectedMonth, selectedYear }) => {
            const [amount, setAmount] = useState(bonus?.amount || '');
            const [description, setDescription] = useState(bonus?.description || '');
            const [recordMonth, setRecordMonth] = useState(bonus?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(bonus?.year || selectedYear);

            useEffect(() => {
                if (bonus) {
                    setAmount(bonus.amount);
                    setDescription(bonus.description);
                    setRecordMonth(bonus.month);
                    setRecordYear(bonus.year);
                } else {
                    setAmount('');
                    setDescription('');
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [bonus, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(employeeId, parseFloat(amount), description, recordMonth, recordYear);
            };

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <Modal
                    title={bonus ? translations.editBonus : translations.addBonus}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="bonusAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.bonusAmount}:
                            </label>
                            <input
                                type="number"
                                id="bonusAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="bonusDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="bonusDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="bonusMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="bonusMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="bonusYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="bonusYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const EmployeeFinancials = ({ users, expenses, bonuses, addExpense, editExpense, deleteExpense, addBonus, editBonus, deleteBonus, translations, setMessage, selectedMonth, selectedYear, setFinancialsMonth, setFinancialsYear, appId }) => {
            const { db } = useAppContext();
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [isAddEditExpenseModalOpen, setIsAddEditExpenseModalOpen] = useState(false);
            const [currentExpense, setCurrentExpense] = useState(null);
            const [isAddEditBonusModalOpen, setIsAddEditBonusModalOpen] = useState(false);
            const [currentBonus, setCurrentBonus] = useState(null);
            const fileInputRef = useRef(null);

            const filteredExpenses = expenses.filter(e =>
                (selectedEmployeeId === '' || e.employeeId === selectedEmployeeId) &&
                (e.month === selectedMonth && e.year === selectedYear)
            );
            const filteredBonuses = bonuses.filter(b =>
                (selectedEmployeeId === '' || b.employeeId === selectedEmployeeId) &&
                (b.month === selectedMonth && b.year === selectedYear)
            );

            const expenseColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
                { header: translations.employee, key: 'employeeId', render: (item) => users.find(u => u.id === item.employeeId)?.name || 'N/A', sortable: true },
                { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
                { header: translations.expenseAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (expense) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentExpense(expense); setIsAddEditExpenseModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteExpense)) deleteExpense(expense.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const bonusColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
                { header: translations.employee, key: 'employeeId', render: (item) => users.find(u => u.id === item.employeeId)?.name || 'N/A', sortable: true },
                { header: translations.bonusAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (bonus) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentBonus(bonus); setIsAddEditBonusModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteBonus)) deleteBonus(bonus.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const handleSaveExpense = (employeeId, type, amount, description, recordMonth, recordYear) => {
                if (currentExpense) {
                    editExpense(currentExpense.id, { employeeId, type, amount, description, month: recordMonth, year: recordYear });
                } else {
                    addExpense(employeeId, type, amount, description, recordMonth, recordYear);
                }
                setIsAddEditExpenseModalOpen(false);
                setCurrentExpense(null);
            };

            const handleSaveBonus = (employeeId, amount, description, recordMonth, recordYear) => {
                if (currentBonus) {
                    editBonus(currentBonus.id, { employeeId, amount, description, month: recordMonth, year: recordYear });
                } else {
                    addBonus(employeeId, amount, description, recordMonth, recordYear);
                }
                setIsAddEditBonusModalOpen(false);
                setCurrentBonus(null);
            };

            const handleDownloadSampleExcel = () => {
                const sampleData = [
                    ['employeeNumber', 'type', 'amount', 'description', 'month', 'year'],
                    ['EMP001', 'rental', '1500.00', 'Office rent', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP002', 'electricity', '300.50', 'Monthly electricity bill', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP001', 'bonus', '500.00', 'Performance bonus', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP003', 'loans', '1000.00', 'Salary advance', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP004', 'penalties', '50.00', 'Late submission penalty', new Date().getMonth() + 1, new Date().getFullYear()],
                ];

                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Financials");
                XLSX.writeFile(wb, "EmployeeFinancials_Sample.xlsx");
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (json.length < 2) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            const headers = json[0];
                            const expectedHeaders = ['employeeNumber', 'type', 'amount', 'description', 'month', 'year'];

                            const headerCheck = expectedHeaders.every(h => headers.includes(h));
                            if (!headerCheck) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = row[index];
                                });

                                const { employeeNumber, type, amount, description, month, year } = rowData;

                                if (!employeeNumber || !type || !amount || isNaN(parseFloat(amount)) || month === undefined || year === undefined) {
                                    console.warn(`Skipping row ${i + 1} due to missing or invalid data:`, rowData);
                                    continue;
                                }

                                const employee = users.find(u => u.employeeNumber === String(employeeNumber));
                                if (!employee) {
                                    console.warn(`Skipping row ${i + 1}: Employee with number ${employeeNumber} not found.`);
                                    continue;
                                }

                                const recordMonth = parseInt(month) - 1; // Convert to 0-indexed month
                                const recordYear = parseInt(year);

                                // Check for duplicates before adding
                                const collectionPath = `artifacts/${appId}/public/data/${type === 'bonus' ? 'bonuses' : 'expenses'}`;
                                let q;
                                if (type === 'bonus') {
                                    q = firebase.query(firebase.collection(db, collectionPath),
                                        firebase.where("employeeId", "==", employee.id),
                                        // For bonus, 'type' isn't explicitly stored like expense types
                                        firebase.where("amount", "==", parseFloat(amount)),
                                        firebase.where("description", "==", description || null),
                                        firebase.where("month", "==", recordMonth),
                                        firebase.where("year", "==", recordYear)
                                    );
                                } else { // Expenses including loans and penalties
                                     q = firebase.query(firebase.collection(db, collectionPath),
                                        firebase.where("employeeId", "==", employee.id),
                                        firebase.where("type", "==", type),
                                        firebase.where("amount", "==", parseFloat(amount)),
                                        firebase.where("description", "==", description || null),
                                        firebase.where("month", "==", recordMonth),
                                        firebase.where("year", "==", recordYear)
                                    );
                                }

                                const existingDocs = await firebase.getDocs(q);
                                if (!existingDocs.empty) {
                                    console.warn(translations.duplicateEntrySkipped, rowData);
                                    continue;
                                }


                                if (type === 'bonus') {
                                    await addBonus(employee.id, amount, description, recordMonth, recordYear);
                                } else { // Treat everything else as an expense
                                    await addExpense(employee.id, type, amount, description, recordMonth, recordYear);
                                }
                            }
                            setMessage(translations.excelUploadSuccess);
                            if (fileInputRef.current) {
                                fileInputRef.current.value = ""; // Clear the file input
                            }
                        } catch (error) {
                            console.error("Error parsing Excel file:", error);
                            setMessage(translations.excelUploadError);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };


            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


            return (
                <div className="employee-financials bg-white p-6 rounded-lg shadow-lg">
                    <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.employeeFinancials}</h3>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <label htmlFor="selectEmployeeForFinancials" className="block text-gray-700 text-lg font-bold">
                            {translations.selectEmployeeForFinancials}
                        </label>
                        <select
                            id="selectEmployeeForFinancials"
                            value={selectedEmployeeId}
                            onChange={(e) => setSelectedEmployeeId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        >
                            <option value="">{translations.allEmployees}</option>
                            {users.map(employee => (
                                <option key={employee.id} value={employee.id}>{employee.name}</option>
                            ))}
                        </select>

                        <label htmlFor="financialsMonth" className="block text-gray-700 text-lg font-bold">
                            {translations.month}:
                        </label>
                        <select
                            id="financialsMonth"
                            value={selectedMonth}
                            onChange={(e) => setFinancialsMonth(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <label htmlFor="financialsYear" className="block text-gray-700 text-lg font-bold">
                            {translations.year}:
                        </label>
                        <select
                            id="financialsYear"
                            value={selectedYear}
                            onChange={(e) => setFinancialsYear(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <button
                            onClick={handleDownloadSampleExcel}
                            className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                        >
                            {translations.downloadSampleExcel}
                        </button>
                        <label className="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold cursor-pointer hover:bg-teal-600 transition duration-300 shadow-md">
                            {translations.uploadExcel}
                            <input
                                type="file"
                                accept=".xlsx, .xls"
                                onChange={handleFileUpload}
                                className="hidden"
                                ref={fileInputRef}
                            />
                        </label>
                    </div>

                    {selectedEmployeeId === '' ? (
                        <p className="text-gray-600 text-center text-lg p-8 bg-gray-50 rounded-lg shadow-inner">
                            {translations.pleaseSelectEmployee}
                        </p>
                    ) : (
                        <div className="space-y-6">
                            {/* Expenses Section */}
                            <div className="border-t border-gray-200 pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="text-xl font-semibold text-gray-800">{translations.totalExpenses}</h4>
                                    <button
                                        onClick={() => { setCurrentExpense(null); setIsAddEditExpenseModalOpen(true); }}
                                        className="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300"
                                        disabled={selectedEmployeeId === ''}
                                    >
                                        {translations.addExpense}
                                    </button>
                                </div>
                                {filteredExpenses.length > 0 ? (
                                    <PaginatedTable
                                        data={filteredExpenses}
                                        columns={expenseColumns}
                                        translations={translations}
                                        initialItemsPerPage={5}
                                        searchPlaceholder={translations.search + '...'}
                                    />
                                ) : (
                                    <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noExpenses}</p>
                                )}
                            </div>

                            {/* Bonuses Section */}
                            <div className="border-t border-gray-200 pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="text-xl font-semibold text-gray-800">{translations.totalBonuses}</h4>
                                    <button
                                        onClick={() => { setCurrentBonus(null); setIsAddEditBonusModalOpen(true); }}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300"
                                        disabled={selectedEmployeeId === ''}
                                    >
                                        {translations.addBonus}
                                    </button>
                                </div>
                                {filteredBonuses.length > 0 ? (
                                    <PaginatedTable
                                        data={filteredBonuses}
                                        columns={bonusColumns}
                                        translations={translations}
                                        initialItemsPerPage={5}
                                        searchPlaceholder={translations.search + '...'}
                                    />
                                ) : (
                                    <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noBonuses}</p>
                                )}
                            </div>

                            <AddEditExpenseModal
                                isOpen={isAddEditExpenseModalOpen}
                                onClose={() => { setIsAddEditExpenseModalOpen(false); setCurrentExpense(null); }}
                                expense={currentExpense}
                                onSave={handleSaveExpense}
                                employeeId={selectedEmployeeId}
                                translations={translations}
                                setMessage={setMessage}
                                selectedMonth={selectedMonth}
                                selectedYear={selectedYear}
                            />
                            <AddEditBonusModal
                                isOpen={isAddEditBonusModalOpen}
                                onClose={() => { setIsAddEditBonusModalOpen(false); setCurrentBonus(null); }}
                                bonus={currentBonus}
                                onSave={handleSaveBonus}
                                employeeId={selectedEmployeeId}
                                translations={translations}
                                setMessage={setMessage}
                                selectedMonth={selectedMonth}
                                selectedYear={selectedYear}
                            />
                        </div>
                    )}
                </div>
            );
        };

        const AddEditOrgExpenseModal = ({ isOpen, onClose, expense, onSave, translations, setMessage, selectedMonth, selectedYear }) => {
            const [type, setType] = useState(expense?.type || '');
            const [amount, setAmount] = useState(expense?.amount || '');
            const [description, setDescription] = useState(expense?.description || '');
            const [recordMonth, setRecordMonth] = useState(expense?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(expense?.year || selectedYear);

            useEffect(() => {
                if (expense) {
                    setType(expense.type);
                    setAmount(expense.amount);
                    setDescription(expense.description);
                    setRecordMonth(expense.month);
                    setRecordYear(expense.year);
                } else {
                    setType('');
                    setAmount('');
                    setDescription('');
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [expense, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type || !amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(type, parseFloat(amount), description, recordMonth, recordYear);
            };

            const expenseTypes = [
                'managementTeamSalary', 'tools', 'equipment', 'insurance', 'violations', 'bankLoans',
                'internet', 'maintenance', 'newInstallations', 'financing'
            ];

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <Modal
                    title={expense ? translations.editExpense : translations.addExpense}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="orgExpenseType" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseType}:
                            </label>
                            <select
                                id="orgExpenseType"
                                value={type}
                                onChange={(e) => setType(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">{translations.selectEmployee}</option>
                                {expenseTypes.map(expType => (
                                    <option key={expType} value={expType}>{translations[expType] || expType}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="orgExpenseAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseAmount}:
                            </label>
                            <input
                                type="number"
                                id="orgExpenseAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="orgExpenseDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="orgExpenseDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="orgExpenseMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="orgExpenseMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="orgExpenseYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="orgExpenseYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const OrganizationExpensesDashboard = ({ payments, organizationExpenses, addOrganizationExpense, editOrganizationExpense, deleteOrganizationExpense, translations, setMessage, appId }) => {
            const { db } = useAppContext();
            const [isOrgExpenseModalOpen, setIsOrgExpenseModalOpen] = useState(false);
            const [currentOrgExpense, setCurrentOrgExpense] = useState(null);
            const fileInputRef = useRef(null);

            const currentLocalDate = new Date();
            const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
            const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());

            const filteredOrgExpenses = organizationExpenses.filter(e =>
                e.month === selectedMonth && e.year === selectedYear
            );

            const totalOrganizationExpenses = filteredOrgExpenses.reduce((acc, e) => acc + e.amount, 0);

            const totalOrganizationIncome = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            ).reduce((acc, p) => acc + p.amount, 0);

            const netOrganizationResult = totalOrganizationIncome - totalOrganizationExpenses;

            const orgExpenseColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item, index) => index + 1, sortable: false },
                { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
                { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (expense) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentOrgExpense(expense); setIsOrgExpenseModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteExpense)) deleteOrganizationExpense(expense.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const handleDownloadOrgExpenseSampleExcel = () => {
                const sampleData = [
                    ['type', 'amount', 'description', 'month', 'year'],
                    ['managementTeamSalary', '10000.00', 'Monthly salaries for management', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['tools', '500.00', 'New tools purchase', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['violations', '150.00', 'Parking fine', new Date().getMonth() + 1, new Date().getFullYear()],
                ];

                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "OrgExpenses");
                XLSX.writeFile(wb, "OrgExpenses_Sample.xlsx");
            };

            const handleUploadOrgExpenseExcel = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (json.length < 2) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            const headers = json[0];
                            const expectedHeaders = ['type', 'amount', 'description', 'month', 'year'];

                            const headerCheck = expectedHeaders.every(h => headers.includes(h));
                            if (!headerCheck) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = row[index];
                                });

                                const { type, amount, description, month, year } = rowData;

                                if (!type || !amount || isNaN(parseFloat(amount)) || month === undefined || year === undefined) {
                                    console.warn(`Skipping row ${i + 1} due to missing or invalid data:`, rowData);
                                    continue;
                                }

                                const recordMonth = parseInt(month) - 1;
                                const recordYear = parseInt(year);

                                // Check for duplicates before adding
                                const collectionPath = `artifacts/${appId}/public/data/organizationExpenses`;
                                const q = firebase.query(firebase.collection(db, collectionPath),
                                    firebase.where("type", "==", type),
                                    firebase.where("amount", "==", parseFloat(amount)),
                                    firebase.where("description", "==", description || null),
                                    firebase.where("month", "==", recordMonth),
                                    firebase.where("year", "==", recordYear)
                                );

                                const existingDocs = await firebase.getDocs(q);
                                if (!existingDocs.empty) {
                                    console.warn(translations.duplicateEntrySkipped, rowData);
                                    continue;
                                }

                                await addOrganizationExpense(type, amount, description, recordMonth, recordYear);
                            }
                            setMessage(translations.excelUploadSuccess);
                            if (fileInputRef.current) {
                                fileInputRef.current.value = "";
                            }
                        } catch (error) {
                            console.error("Error parsing Excel file:", error);
                            setMessage(translations.excelUploadError);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <div className="organization-expenses-dashboard bg-white p-6 rounded-lg shadow-lg">
                    <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.organizationExpenses}</h3>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <label htmlFor="orgExpensesMonth" className="block text-gray-700 text-lg font-bold">
                            {translations.month}:
                        </label>
                        <select
                            id="orgExpensesMonth"
                            value={selectedMonth}
                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <label htmlFor="orgExpensesYear" className="block text-gray-700 text-lg font-bold">
                            {translations.year}:
                        </label>
                        <select
                            id="orgExpensesYear"
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div className="bg-green-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-green-800 mb-2">{translations.totalOrganizationIncome}</h3>
                            <p className="text-3xl font-bold text-green-700">SAR {totalOrganizationIncome.toFixed(2)}</p>
                        </div>
                        <div className="bg-red-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-red-800 mb-2">{translations.totalOrganizationExpenses}</h3>
                            <p className="text-3xl font-bold text-red-700">SAR {totalOrganizationExpenses.toFixed(2)}</p>
                        </div>
                        <div className={`p-6 rounded-lg shadow-inner text-center ${netOrganizationResult >= 0 ? 'bg-blue-50 text-blue-800' : 'bg-orange-50 text-orange-800'}`}>
                            <h3 className="text-xl font-semibold mb-2">{translations.netOrganizationResult}</h3>
                            <p className="text-3xl font-bold">SAR {netOrganizationResult.toFixed(2)}</p>
                        </div>
                    </div>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <button
                            onClick={handleDownloadOrgExpenseSampleExcel}
                            className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                        >
                            {translations.downloadSampleExcel}
                        </button>
                        <label className="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold cursor-pointer hover:bg-teal-600 transition duration-300 shadow-md">
                            {translations.uploadExcel}
                            <input
                                type="file"
                                accept=".xlsx, .xls"
                                onChange={handleUploadOrgExpenseExcel}
                                className="hidden"
                                ref={fileInputRef}
                            />
                        </label>
                        <button
                            onClick={() => { setCurrentOrgExpense(null); setIsOrgExpenseModalOpen(true); }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                        >
                            {translations.addExpense}
                        </button>
                    </div>

                    {filteredOrgExpenses.length > 0 ? (
                        <PaginatedTable
                            data={filteredOrgExpenses}
                            columns={orgExpenseColumns}
                            translations={translations}
                            initialItemsPerPage={5}
                            searchPlaceholder={translations.search + '...'}
                        />
                    ) : (
                        <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noExpenses}</p>
                    )}

                    <AddEditOrgExpenseModal
                        isOpen={isOrgExpenseModalOpen}
                        onClose={() => { setIsOrgExpenseModalOpen(false); setCurrentOrgExpense(null); }}
                        expense={currentOrgExpense}
                        onSave={(type, amount, description, recordMonth, recordYear) => {
                            if (currentOrgExpense) {
                                editOrganizationExpense(currentOrgExpense.id, { type, amount, description, month: recordMonth, year: recordYear });
                            } else {
                                addOrganizationExpense(type, amount, description, recordMonth, recordYear);
                            }
                            setIsOrgExpenseModalOpen(false);
                            setCurrentOrgExpense(null);
                        }}
                        translations={translations}
                        setMessage={setMessage}
                        selectedMonth={selectedMonth}
                        selectedYear={selectedYear}
                    />
                </div>
            );
        };

        // Expose newly defined components globally
        window.App.DailySummaryTable = DailySummaryTable;
        window.App.MonthlySummaryTable = MonthlySummaryTable;
        window.App.DailyEmployeeSummary = DailyEmployeeSummary;
        window.App.DailyBranchesSummary = DailyBranchesSummary;
        window.App.MonthlyBranchesIncome = MonthlyBranchesIncome;
        window.App.EmployeeFinancials = EmployeeFinancials;
        window.App.AddEditExpenseModal = AddEditExpenseModal;
        window.App.AddEditBonusModal = AddEditBonusModal;
        window.App.OrganizationExpensesDashboard = OrganizationExpensesDashboard;
        window.App.AddEditOrgExpenseModal = AddEditOrgExpenseModal;


        // Manager Dashboard Component - IMPLEMENTATION (Corrected to avoid redeclaration)
        const ManagerDashboard = () => {
            const { translations, payments, branches, users, getBranchName, getPaymentMethodDetails, getEmployeeName } = useAppContext();
            const currentLocalDate = new Date();
            const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
            const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            // Filter payments for the selected month/year
            const filteredPayments = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            );

            // Calculate total income for the selected month/year
            const totalMonthlyIncome = filteredPayments.reduce((acc, p) => acc + p.amount, 0);

            // Group payments by branch for the table
            const groupedByBranch = filteredPayments.reduce((acc, payment) => {
                const branch = branches.find(b => b.id === payment.branchId);
                const branchName = branch ? branch.name : 'N/A';
                if (!acc[branchName]) {
                    acc[branchName] = {
                        branchName: branchName,
                        totalIncome: 0,
                        methods: {}
                    };
                }
                acc[branchName].totalIncome += payment.amount;
                acc[branchName].methods[payment.paymentMethod] = (acc[branchName].methods[payment.paymentMethod] || 0) + payment.amount;
                return acc;
            }, {});

            const branchIncomeData = Object.values(groupedByBranch);

            // Get all unique payment methods for dynamic columns
            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const branchIncomeColumns = [
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'totalIncome', render: (item) => `SAR ${item.totalIncome.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                totalIncome: (a, b, direction) => direction === 'asc' ? a.totalIncome - b.totalIncome : b.totalIncome - a.totalIncome
            };

            return (
                <div className="manager-dashboard space-y-6">
                    <h2 className="text-3xl font-bold text-gray-800">{translations.manager} Dashboard</h2>

                    {/* Month/Year Selection */}
                    <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center justify-center">
                        <h3 className="text-xl font-semibold text-gray-800">{translations.selectMonthYear}:</h3>
                        <select
                            value={selectedMonth}
                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                            className="p-2 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <select
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                            className="p-2 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    {/* Summary Card */}
                    <div className="grid grid-cols-1 md:grid-cols-1 gap-6">
                        <div className="bg-blue-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-blue-800 mb-2">{translations.totalOrganizationIncome} ({months[selectedMonth]} {selectedYear})</h3>
                            <p className="text-3xl font-bold text-blue-700">SAR {totalMonthlyIncome.toFixed(2)}</p>
                        </div>
                    </div>

                    {/* Monthly Branches Income Table */}
                    <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                        <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.monthlyBranchesIncome}</h3>
                        <PaginatedTable
                            data={branchIncomeData}
                            columns={branchIncomeColumns}
                            translations={translations}
                            initialItemsPerPage={5}
                            searchPlaceholder={translations.search + ' ' + translations.branchName + '...'}
                            customSort={customSort}
                        />
                    </div>

                    {/* You can add more manager-specific reports or functionalities here */}
                </div>
            );
        };

        // Partner Dashboard Component - IMPLEMENTATION (Corrected to avoid redeclaration)
        const PartnerDashboard = () => {
            const { translations, payments, organizationExpenses, users, branches, getBranchName } = useAppContext();
            const currentLocalDate = new Date();
            const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
            const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            // Filter payments for total income
            const totalIncome = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            ).reduce((acc, p) => acc + p.amount, 0);

            // Filter organization expenses
            const filteredOrgExpenses = organizationExpenses.filter(e =>
                e.month === selectedMonth && e.year === selectedYear
            );
            const totalOrgExpenses = filteredOrgExpenses.reduce((acc, e) => acc + e.amount, 0);

            // Calculate net result
            const netOrganizationResult = totalIncome - totalOrgExpenses;

            // Prepare data for Org Expenses table
            const orgExpenseColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item, index) => index + 1, sortable: false },
                { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
                { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
            ];

            return (
                <div className="partner-dashboard space-y-6">
                    <h2 className="text-3xl font-bold text-gray-800">{translations.partner} Dashboard</h2>

                    {/* Month/Year Selection */}
                    <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center justify-center">
                        <h3 className="text-xl font-semibold text-gray-800">{translations.selectMonthYear}:</h3>
                        <select
                            value={selectedMonth}
                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                            className="p-2 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <select
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                            className="p-2 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-green-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-green-800 mb-2">{translations.totalOrganizationIncome}</h3>
                            <p className="text-3xl font-bold text-green-700">SAR {totalIncome.toFixed(2)}</p>
                        </div>
                        <div className="bg-red-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-red-800 mb-2">{translations.totalOrganizationExpenses}</h3>
                            <p className="text-3xl font-bold text-red-700">SAR {totalOrgExpenses.toFixed(2)}</p>
                        </div>
                        <div className={`p-6 rounded-lg shadow-inner text-center ${netOrganizationResult >= 0 ? 'bg-blue-50 text-blue-800' : 'bg-orange-50 text-orange-800'}`}>
                            <h3 className="text-xl font-semibold mb-2">{translations.netOrganizationResult}</h3>
                            <p className="text-3xl font-bold">SAR {netOrganizationResult.toFixed(2)}</p>
                        </div>
                    </div>

                    {/* Organization Expenses Table */}
                    <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                        <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.organizationExpenses}</h3>
                        <PaginatedTable
                            data={filteredOrgExpenses}
                            columns={orgExpenseColumns}
                            translations={translations}
                            initialItemsPerPage={5}
                            searchPlaceholder={translations.search + '...'}
                        />
                    </div>

                    {/* You can add more partner-specific reports or functionalities here */}
                </div>
            );
        };


        // Admin Dashboard Component
        const AdminDashboard = ({ adminPage, setAdminPage }) => {
          const {
            users, branches, payments, paymentMethods, expenses, bonuses, organizationExpenses,
            addBranch, deleteBranch, editBranch,
            addUser, deleteUser, editUser, adminResetUserPassword,
            // addPayment, // Not used directly in AdminDashboard except through utility functions for excel export
            editPayment, // Used for batch update
            // deletePayment, // Used for batch delete
            addPaymentMethod, editPaymentMethod, deletePaymentMethod,
            addExpense, editExpense, deleteExpense,
            addBonus, editBonus, deleteBonus,
            addOrganizationExpense, editOrganizationExpense, deleteOrganizationExpense,
            translations, appId, userId, setMessage, db,
            getBranchName, getPaymentMethodDetails, getUserDetails, getEmployeeName
          } = useAppContext();

          const [isBranchModalOpen, setIsBranchModalOpen] = useState(false);
          const [editingBranch, setEditingBranch] = useState(null);
          const [isUserModalOpen, setIsUserModalOpen] = useState(false);
          const [editingUser, setEditingUser] = useState(null);
          const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
          const [editingPayment, setEditingPayment] = useState(null);
          const [isPaymentMethodModalOpen, setIsPaymentMethodModalOpen] = useState(false);
          const [editingPaymentMethod, setEditingPaymentMethod] = useState(null);
          const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
          const [currentExpense, setCurrentExpense] = useState(null);
          const [isBonusModalOpen, setIsBonusModalOpen] = useState(false);
          const [currentBonus, setCurrentBonus] = useState(null);
          const [isOrgExpenseModalOpen, setIsOrgExpenseModalOpen] = useState(false);
          const [currentOrgExpense, setCurrentOrgExpense] = useState(null);


          const [paymentFilters, setPaymentFilters] = useState({});
          const [dailySummaryDate, setDailySummaryDate] = useState(new Date().toISOString().split('T')[0]);
          const [monthlySummaryMonth, setMonthlySummaryMonth] = useState(new Date().getMonth());
          const [monthlySummaryYear, setMonthlySummaryYear] = useState(new Date().getFullYear());
          const [dailyEmployeeSummaryDate, setDailyEmployeeSummaryDate] = useState(new Date().toISOString().split('T')[0]);

          // State for Employee Financials month/year filter
          const [financialsMonth, setFinancialsMonth] = useState(new Date().getMonth());
          const [financialsYear, setFinancialsYear] = useState(new Date().getFullYear());

          // State for Organization Expenses month/year filter
          const [orgExpensesMonth, setOrgExpensesMonth] = useState(new Date().getMonth());
          const [orgExpensesYear, setOrgExpensesYear] = useState(new Date().getFullYear());

          // Admin-defined table settings
          const [adminRecordsPerPage, setAdminRecordsPerPage] = useState(15);
          const [adminTableTheme, setAdminTableTheme] = useState('default');

          // State for selected payment IDs for batch operations (keep existing)
          const [selectedPaymentIds, setSelectedPaymentIds] = useState([]);

          // NEW: State for selected user IDs for batch operations
          const [selectedUserIds, setSelectedUserIds] = useState([]);
          // NEW: State for upload file and errors
          const [uploadErrors, setUploadErrors] = useState([]);
          const fileInputRef = useRef(null); // Ref for file input element


          const handleFilterChange = (filterKey, value) => {
              setPaymentFilters(prev => ({ ...prev, [filterKey]: value }));
          };

          const clearPaymentFilters = () => {
              setPaymentFilters({});
          };

          const getEmployeeNameOnly = (id) => { // Renamed to avoid conflict with useAppContext's getEmployeeName
            const user = users.find(u => u.id === id);
            return user ? (translations.language === 'ar' && user.nameAr ? user.nameAr : user.name) : 'N/A';
          };

          // Columns for payments table in Admin dashboard
          const adminPaymentColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.timestamp, key: 'timestamp', render: (item) => item.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }) || 'N/A' },
            { header: translations.branch, key: 'branchId', render: (item) => getBranchName(item.branchId) },
            { header: translations.employee, key: 'employeeId', render: (item) => getUserDetails(item.employeeId) },
            { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.method, key: 'paymentMethod', render: (item) => getPaymentMethodDetails(item.paymentMethod) },
            { header: translations.addedBy, key: 'addedBy', render: (item) => getUserDetails(item.addedBy) },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (item) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingPayment(item); setIsPaymentModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                </div>
              )
            },
          ];

          // Columns for branches table
          const branchColumns = [
            { header: translations.name, key: 'name' },
            { header: translations.location, key: 'location' },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (branch) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingBranch(branch); setIsBranchModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                  <button
                    onClick={() => { if (confirm(translations.confirmDeleteBranch)) deleteBranch(branch.id); }}
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                  >
                    {translations.delete}
                  </button>
                </div>
              )
            },
          ];

          // Columns for users table - MODIFIED FOR MULTI-SELECT
          const userColumns = [
            {
                header: ( // Checkbox header for "Select All"
                    <input
                        type="checkbox"
                        onChange={handleSelectAllUsers}
                        checked={selectedUserIds.length === users.length && users.length > 0}
                    />
                ),
                key: 'select',
                sortable: false,
                render: (user) => (
                    <input
                        type="checkbox"
                        className="user-select-checkbox" // Added class for easy selection
                        checked={selectedUserIds.includes(user.id)}
                        onChange={() => toggleUserSelection(user.id)}
                    />
                )
            },
            { header: translations.name, key: 'name', render: (user) => `${user.name} / ${user.nameAr || user.name}` },
            { header: translations.employeeNo, key: 'employeeNumber' },
            { header: translations.emailPlaceholder, key: 'email' },
            { header: translations.role, key: 'role', render: (user) => translations[user.role] || user.role },
            { header: translations.branch, key: 'branchId', render: (user) => getBranchName(user.branchId) },
            { header: translations.target, key: 'targetAmount', render: (user) => `SAR ${user.targetAmount?.toFixed(2) || '0.00'}` },
            { header: "Image", key: "imageUrl", sortable: false, render: (user) => (user.imageUrl ? <img src={user.imageUrl} alt={user.name} className="h-10 w-10 rounded-full object-cover" /> : <div className="h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-xs">No Img</div>) },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (user) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingUser(user); setIsUserModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                  <button
                    onClick={() => { if (confirm(translations.confirmDeleteUser)) deleteUser(user.id); }}
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                  >
                    {translations.delete}
                  </button>
                </div>
              )
            },
          ];

          // NEW: Multi-select Toggle Function
          const toggleUserSelection = (userId) => {
            setSelectedUserIds(prevSelected =>
              prevSelected.includes(userId)
                ? prevSelected.filter(id => id !== userId)
                : [...prevSelected, userId]
            );
          };

          // NEW: Handle "Select All" for users
          const handleSelectAllUsers = (e) => {
            if (e.target.checked) {
              setSelectedUserIds(users.map(user => user.id));
            } else {
              setSelectedUserIds([]);
            }
          };

          // NEW: Function to delete selected users
          const handleDeleteSelectedUsers = async () => {
            if (selectedUserIds.length === 0) {
              setMessage(translations.noUsersSelectedForDeletion || "No users selected for deletion.");
              return;
            }

            if (confirm(translations.confirmDeleteSelectedUsers || `Are you sure you want to delete ${selectedUserIds.length} selected users?`)) {
              try {
                // Assuming deleteUser is an async action in useAppContext
                for (const userId of selectedUserIds) {
                  await deleteUser(userId);
                }
                setMessage(`${selectedUserIds.length} ${translations.usersDeletedSuccessfully || 'users deleted successfully!'}`);
                setSelectedUserIds([]); // Clear selection after deletion
              } catch (error) {
                console.error("Error deleting selected users:", error);
                setMessage(translations.errorDeletingUsers || "Error deleting users. Please try again.");
              }
            }
          };


          // Columns for payment methods table
          const paymentMethodColumns = [
              { header: translations.name, key: 'name', render: (method) => `${method.name} / ${method.nameAr || method.name}` },
              { header: translations.icon, key: 'icon', render: (method) => <span style={{ fontSize: '1.5rem', color: method.color }}>{method.icon}</span>, sortable: false },
              { header: translations.color, key: 'color', render: (method) => <span className={`inline-block w-6 h-6 rounded-full`} style={{ backgroundColor: method.color }}></span>, sortable: false },
              {
                header: translations.actions,
                key: 'actions',
                sortable: false,
                render: (method) => (
                  <div className="flex space-x-2">
                    <button
                      onClick={() => { setEditingPaymentMethod(method); setIsPaymentMethodModalOpen(true); }}
                      className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                    >
                      {translations.edit}
                    </button>
                    <button
                      onClick={() => { if (confirm(translations.confirmDeletePaymentMethod)) deletePaymentMethod(method.id); }}
                      className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                    >
                      {translations.delete}
                    </button>
                  </div>
                )
              },
          ];

          // Helper for consistent timestamp conversion for Excel export
          const convertTimestampForExcel = (firebaseTimestamp) => {
              if (!firebaseTimestamp) return '';
              if (typeof firebaseTimestamp.toDate === 'function') {
                  return firebaseTimestamp.toDate().toLocaleString(); // Use toLocaleString for readability in Excel
              }
              if (firebaseTimestamp instanceof Date) {
                  return firebaseTimestamp.toLocaleString();
              }
              return firebaseTimestamp; // Return as is if not a known timestamp type
          };

          // Function to download all data as JSON (backup)
          const downloadAllDataAsJSON = async () => {
              try {
                  const dataToExport = {
                      branches: branches.map(b => ({
                          ...b,
                          createdAt: b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate().toISOString() : (b.createdAt instanceof Date ? b.createdAt.toISOString() : b.createdAt)
                      })),
                      users: users.map(u => ({
                          ...u,
                          createdAt: u.createdAt && typeof u.createdAt.toDate === 'function' ? u.createdAt.toDate().toISOString() : (u.createdAt instanceof Date ? u.createdAt.toISOString() : u.createdAt)
                      })),
                      payments: payments.map(p => ({
                          ...p,
                          timestamp: p.timestamp && typeof p.timestamp.toDate === 'function' ? p.timestamp.toDate().toISOString() : (p.timestamp instanceof Date ? p.timestamp.toISOString() : p.timestamp)
                      })),
                      paymentMethods: paymentMethods.map(pm => ({
                          ...pm,
                          createdAt: pm.createdAt && typeof pm.createdAt.toDate === 'function' ? pm.createdAt.toDate().toISOString() : (pm.createdAt instanceof Date ? pm.createdAt.toISOString() : pm.createdAt)
                      })),
                      expenses: expenses.map(ex => ({
                          ...ex,
                          timestamp: ex.timestamp && typeof ex.timestamp.toDate === 'function' ? ex.timestamp.toDate().toISOString() : (ex.timestamp instanceof Date ? ex.timestamp.toISOString() : ex.timestamp)
                      })),
                      bonuses: bonuses.map(bo => ({
                          ...bo,
                          timestamp: bo.timestamp && typeof bo.timestamp.toDate === 'function' ? bo.timestamp.toDate().toISOString() : (bo.timestamp instanceof Date ? bo.timestamp.toISOString() : bo.timestamp)
                      })),
                      organizationExpenses: organizationExpenses.map(oex => ({
                          ...oex,
                          timestamp: oex.timestamp && typeof oex.timestamp.toDate === 'function' ? oex.timestamp.toDate().toISOString() : (oex.timestamp instanceof Date ? oex.timestamp.toISOString() : oex.timestamp)
                      })),
                  };
                  const jsonString = JSON.stringify(dataToExport, null, 2);
                  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                  const now = new Date();
                  const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                  const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
                  const fileName = `shop_app_backup_${dateStr}_${timeStr}.json`;
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.setAttribute('download', fileName);
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  setMessage(translations.allDataBackedUpSuccessfully);
              } catch (error) {
                  console.error("Error backing up data:", error);
                  setMessage("Error backing up data.");
              }
          };

          // Function to download all data as Excel (multiple workbooks)
          const downloadAllDataAsExcel = () => {
              try {
                  const wb = XLSX.utils.book_new(); // Create a new workbook

                  // 1. Branches Sheet
                  const branchesData = branches.map((b, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: b.id,
                      Name: translations.language === 'ar' && b.nameAr ? b.nameAr : b.name,
                      Location: b.location,
                      'Created At': convertTimestampForExcel(b.createdAt),
                  }));
                  const wsBranches = XLSX.utils.json_to_sheet(branchesData);
                  XLSX.utils.book_append_sheet(wb, wsBranches, translations.branchManagement);

                  // 2. Users Sheet
                  const usersData = users.map((u, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: u.id,
                      Name: u.name,
                      'Name (AR)': u.nameAr || '',
                      'Employee Number': u.employeeNumber,
                      Email: u.email,
                      Role: translations[u.role] || u.role,
                      Branch: getBranchName(u.branchId),
                      'Target Amount (SAR)': u.targetAmount || 0,
                      'Created At': convertTimestampForExcel(u.createdAt),
                  }));
                  const wsUsers = XLSX.utils.json_to_sheet(usersData);
                  XLSX.utils.book_append_sheet(wb, wsUsers, translations.userManagement);

                  // 3. Payments Sheet
                  const paymentsData = payments.map((p, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: p.id,
                      Timestamp: convertTimestampForExcel(p.timestamp),
                      Branch: getBranchName(p.branchId),
                      Employee: getUserDetails(p.employeeId), // This already includes name and employee number
                      Amount: p.amount,
                      'Payment Method': getPaymentMethodDetails(p.paymentMethod),
                      'Added By': getUserDetails(p.addedBy),
                  }));
                  const wsPayments = XLSX.utils.json_to_sheet(paymentsData);
                  XLSX.utils.book_append_sheet(wb, wsPayments, translations.realtimePayments);

                  // 4. Payment Methods Sheet
                  const paymentMethodsData = paymentMethods.map((pm, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: pm.id,
                      Name: pm.name,
                      'Name (AR)': pm.nameAr || '',
                      Icon: pm.icon,
                      Color: pm.color,
                      'Created At': convertTimestampForExcel(pm.createdAt),
                  }));
                  const wsPaymentMethods = XLSX.utils.json_to_sheet(paymentMethodsData);
                  XLSX.utils.book_append_sheet(wb, wsPaymentMethods, translations.paymentMethodsManagement);

                  // 5. Expenses Sheet
                  const expensesData = expenses.map((ex, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: ex.id,
                      Timestamp: convertTimestampForExcel(ex.timestamp),
                      Employee: getUserDetails(ex.employeeId),
                      Amount: ex.amount,
                      Description: ex.description,
                      Type: ex.type,
                      // These fields are not in the Expense model, so commenting out or ensuring they don't exist
                      // Branch: getBranchName(ex.branchId),
                      // 'Added By': getUserDetails(ex.addedBy),
                  }));
                  const wsExpenses = XLSX.utils.json_to_sheet(expensesData);
                  XLSX.utils.book_append_sheet(wb, wsExpenses, translations.expenses || 'Expenses'); // Fallback if translation missing

                  // 6. Bonuses Sheet
                  const bonusesData = bonuses.map((bo, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: bo.id,
                      Timestamp: convertTimestampForExcel(bo.timestamp),
                      Employee: getUserDetails(bo.employeeId),
                      Amount: bo.amount,
                      Description: bo.description,
                      // These fields are not in the Bonus model, so commenting out or ensuring they don't exist
                      // Branch: getBranchName(bo.branchId),
                      // 'Added By': getUserDetails(bo.addedBy),
                  }));
                  const wsBonuses = XLSX.utils.json_to_sheet(bonusesData);
                  XLSX.utils.book_append_sheet(wb, wsBonuses, translations.bonuses || 'Bonuses'); // Fallback if translation missing

                  // 7. Organization Expenses Sheet
                  const organizationExpensesData = organizationExpenses.map((oex, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: oex.id,
                      Timestamp: convertTimestampForExcel(oex.timestamp),
                      Amount: oex.amount,
                      Description: oex.description,
                      Type: oex.type, // Should be type, not category
                      // 'Added By': getUserDetails(oex.addedBy), // Org expenses don't typically have an addedBy user
                  }));
                  const wsOrgExpenses = XLSX.utils.json_to_sheet(organizationExpensesData);
                  XLSX.utils.book_append_sheet(wb, wsOrgExpenses, translations.organizationExpenses);

                  // Write the workbook
                  const now = new Date();
                  const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                  const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
                  const fileName = `${translations.allDataBackup || 'ShopApp_All_Data'}_${dateStr}_${timeStr}.xlsx`; // Use a translated filename
                  XLSX.writeFile(wb, fileName);

                  setMessage(translations.allDataBackedUpSuccessfully); // Reuse this message
              } catch (error) {
                  console.error("Error backing up data to Excel:", error);
                  setMessage("Error backing up data to Excel.");
              }
          };

          // NEW: Function to download filtered payments as a single Excel sheet
          const downloadFilteredPaymentsAsExcel = () => {
              try {
                  const wb = XLSX.utils.book_new(); // Create a new workbook

                  // Apply filters to payments data
                  const filteredPayments = payments.filter(payment => {
                      let match = true;
                      if (paymentFilters.branchId && paymentFilters.branchId !== 'all') {
                          match = match && payment.branchId === paymentFilters.branchId;
                      }
                      if (paymentFilters.employeeId && paymentFilters.employeeId !== 'all') {
                          match = match && payment.employeeId === paymentFilters.employeeId;
                      }
                      if (paymentFilters.paymentMethod && paymentFilters.paymentMethod !== 'all') {
                          match = match && payment.paymentMethod === paymentFilters.paymentMethod;
                      }
                      // Add date range filtering if needed, similar to other dashboards
                      if (paymentFilters.fromDate && payment.timestamp) {
                          const paymentDate = new Date(payment.timestamp.toDate ? payment.timestamp.toDate() : payment.timestamp);
                          const fromDate = new Date(paymentFilters.fromDate);
                          match = match && paymentDate >= fromDate;
                      }
                      if (paymentFilters.toDate && payment.timestamp) {
                          const paymentDate = new Date(payment.timestamp.toDate ? payment.timestamp.toDate() : payment.timestamp);
                          const toDate = new Date(paymentFilters.toDate);
                          // Set to end of day for inclusive range
                          toDate.setHours(23, 59, 59, 999);
                          match = match && paymentDate <= toDate;
                      }
                      return match;
                  });

                  // Prepare data for the Excel sheet, similar to the payments sheet in downloadAllDataAsExcel
                  const paymentsDataForExcel = filteredPayments.map((p, index) => ({ // Added index for serial number
                      'Serial No.': index + 1, // Serial number
                      ID: p.id,
                      Timestamp: convertTimestampForExcel(p.timestamp),
                      Branch: getBranchName(p.branchId),
                      Employee: getUserDetails(p.employeeId),
                      Amount: p.amount,
                      'Payment Method': getPaymentMethodDetails(p.paymentMethod),
                      'Added By': getUserDetails(p.addedBy),
                  }));

                  const wsPayments = XLSX.utils.json_to_sheet(paymentsDataForExcel);
                  XLSX.utils.book_append_sheet(wb, wsPayments, translations.realtimePayments || 'Filtered Payments'); // Sheet name

                  const now = new Date();
                  const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                  const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
                  const fileName = `${translations.filteredPaymentsExport || 'Filtered_Payments'}_${dateStr}_${timeStr}.xlsx`;
                  XLSX.writeFile(wb, fileName);

                  setMessage(translations.paymentsDataDownloadedSuccessfully || 'Filtered payments data downloaded successfully!');
              } catch (error) {
                  console.error("Error backing up filtered payments data to Excel:", error);
                  setMessage("Error backing up filtered payments data to Excel.");
              }
          };


          // NEW: Function to download a sample user Excel template
          const downloadSampleUserExcel = () => {
              try {
                  const wb = XLSX.utils.book_new();
                  const headers = [
                      translations.name,
                      translations.nameAr, // Assuming you want both for import
                      translations.employeeNo,
                      translations.emailPlaceholder, // "Email"
                      translations.role, // e.g., 'admin', 'employee', 'manager'
                      translations.branch, // Branch Name (will need to map to ID on upload)
                      translations.target, // Target Amount
                      "password", // Actual keyword for password (not translated)
                      "Image URL" // Optional
                  ];

                  const ws = XLSX.utils.aoa_to_sheet([headers]); // Create sheet from array of arrays

                  // Add a sample row with hints/example data
                  XLSX.utils.sheet_add_aoa(ws, [
                      ['John Doe', 'جون دو', 'EMP001', 'john.doe@example.com', 'employee', 'Main Branch', 5000, 'SecurePassword123', 'https://example.com/john.jpg'],
                      ['Jane Smith', 'جين سميث', 'EMP002', 'jane.smith@example.com', 'manager', 'Downtown', 10000, 'AnotherSecurePass', '']
                  ], { origin: -1 }); // -1 means append after last row

                  // Optional: Add some basic column width
                  ws['!cols'] = [
                      { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 25 },
                      { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 30 }
                  ];

                  XLSX.utils.book_append_sheet(wb, ws, translations.userTemplate || 'User Import Template');

                  const fileName = translations.userTemplateFileName || 'user_import_template.xlsx';
                  XLSX.writeFile(wb, fileName);
                  setMessage(translations.userTemplateDownloaded || 'User import template downloaded successfully!');
              } catch (error) {
                  console.error("Error downloading sample user Excel:", error);
                  setMessage(translations.errorDownloadingTemplate || "Error downloading user template.");
              }
          };

          // NEW: Function to handle user Excel upload
          const handleUserExcelUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                setMessage(translations.invalidExcelFile || 'Please upload a valid Excel file (.xlsx or .xls).');
                return;
            }

            setUploadErrors([]); // Clear previous errors
            setMessage(translations.processingUpload || 'Processing upload...');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Get data as array of arrays

                if (jsonData.length <= 1) { // Only header row or empty
                    setMessage(translations.emptyExcelFile || 'The uploaded Excel file is empty or contains only headers.');
                    return;
                }

                const headers = jsonData[0].map(h => h.trim()); // Get headers from the first row
                const usersToProcess = [];
                const currentEmails = new Set(users.map(u => u.email.toLowerCase()));
                const currentEmployeeNumbers = new Set(users.map(u => u.employeeNumber?.toLowerCase()).filter(Boolean)); // Filter out undefined/null

                const emailCol = headers.indexOf(translations.emailPlaceholder);
                const employeeNoCol = headers.indexOf(translations.employeeNo);
                const nameCol = headers.indexOf(translations.name);
                const nameArCol = headers.indexOf(translations.nameAr);
                const roleCol = headers.indexOf(translations.role);
                const branchCol = headers.indexOf(translations.branch);
                const targetCol = headers.indexOf(translations.target);
                const passwordCol = headers.indexOf("password"); // Use the exact string "password" as the column header
                const imageUrlCol = headers.indexOf("Image URL"); // Assuming this exact header

                const newUploadErrors = [];
                let successfullyAddedCount = 0;
                let failedAddCount = 0;

                // Fetch all branches to map names to IDs
                const branchNameToIdMap = {};
                branches.forEach(b => {
                    branchNameToIdMap[b.name.toLowerCase()] = b.id;
                    if (b.nameAr) {
                        branchNameToIdMap[b.nameAr.toLowerCase()] = b.id;
                    }
                });


                for (let i = 1; i < jsonData.length; i++) { // Start from second row (skip headers)
                    const row = jsonData[i];
                    const rowNumber = i + 1;
                    const errorsInRow = [];

                    const name = row[nameCol] || '';
                    const nameAr = row[nameArCol] || '';
                    const employeeNumber = (row[employeeNoCol] || '').toString().trim();
                    const email = (row[emailCol] || '').toLowerCase().trim();
                    const role = (row[roleCol] || '').toLowerCase().trim();
                    const branchName = (row[branchCol] || '').trim();
                    const targetAmount = parseFloat(row[targetCol]) || 0;
                    const password = row[passwordCol] || '';
                    const imageUrl = row[imageUrlCol] || '';

                    // --- Data Validation ---
                    if (!name) errorsInRow.push(translations.nameRequired);
                    if (!employeeNumber) errorsInRow.push(translations.employeeNoRequired);
                    if (!email) {
                        errorsInRow.push(translations.emailRequired);
                    } else if (!/\S+@\S+\.\S+/.test(email)) {
                        errorsInRow.push(translations.invalidEmailFormat);
                    } else if (currentEmails.has(email)) {
                        errorsInRow.push(translations.emailAlreadyExists);
                    } else {
                        currentEmails.add(email); // Add to local set for current batch validation
                    }

                    if (!employeeNumber) {
                        errorsInRow.push(translations.employeeNoRequired);
                    } else if (currentEmployeeNumbers.has(employeeNumber.toLowerCase())) {
                        errorsInRow.push(translations.employeeNoAlreadyExists);
                    } else {
                        currentEmployeeNumbers.add(employeeNumber.toLowerCase()); // Add to local set for current batch validation
                    }

                    // Basic role validation (adjust based on your actual roles)
                    const validRoles = ['admin', 'employee', 'supervisor', 'manager', 'partner']; // Ensure these match your system
                    if (!role || !validRoles.includes(role)) {
                        errorsInRow.push(`${translations.invalidRole} (${validRoles.join(', ')})`);
                    }

                    // Branch validation
                    const branchId = branchNameToIdMap[branchName.toLowerCase()];
                    if (!branchId && role !== 'admin') { // Admins might not have a branchId
                        errorsInRow.push(translations.invalidBranchName);
                    }

                    if (isNaN(targetAmount) || targetAmount < 0) {
                        errorsInRow.push(translations.invalidTargetAmount);
                    }

                    // Password validation (simple check, strong validation should be on server)
                    // Only require password for NEW users or if explicitly provided for existing
                    // Note: No "editingUser" context here as this is a bulk import function.
                    // Assuming all imported users are new or being re-created with a temp password.
                    if (!password) { // Password required for new users
                        errorsInRow.push(translations.passwordRequiredForNewUser);
                    } else if (password.length < 6) { // Minimum length
                        errorsInRow.push(translations.passwordTooShort);
                    }


                    if (errorsInRow.length > 0) {
                        newUploadErrors.push(`Row ${rowNumber}: ${errorsInRow.join('; ')}`);
                    } else {
                        usersToProcess.push({
                            name,
                            nameAr,
                            employeeNumber,
                            email,
                            role,
                            branchId: branchId || '', // Pass branchId or empty string
                            targetAmount,
                            password, // Pass for server-side hashing
                            imageUrl
                        });
                    }
                }

                setUploadErrors(newUploadErrors);

                if (newUploadErrors.length > 0) {
                    setMessage(`${translations.uploadCompletedWithErrors || 'Upload completed with errors.'} ${newUploadErrors.length} rows had issues.`);
                } else {
                    setMessage(translations.importingUsers || 'Importing users...');
                    for (const userData of usersToProcess) {
                        try {
                            // Call your existing addUser function from useAppContext
                            // This addUser function from the context will call firebase.addDoc
                            await addUser(
                                userData.name,
                                userData.email,
                                userData.role,
                                userData.branchId,
                                userData.targetAmount,
                                userData.employeeNumber,
                                userData.nameAr,
                                userData.imageUrl,
                                // userData.password is not directly used by the current `addUser` signature,
                                // it's intended for a real Firebase Auth flow. For this simulated app,
                                // the password would be handled by `adminResetUserPassword` if we were
                                // to extend the import to trigger simulated password setups.
                                // For now, the user roles define fixed passwords.
                                // If the Excel import needs to set initial *simulated* passwords,
                                // the `addUser` function in the main context would need modification
                                // to accept and store `simulatedPassword` for new users.
                                // For simplicity and avoiding auth complexities in a client-side only app,
                                // we'll rely on the existing role-based password logic for login.
                            );
                            successfullyAddedCount++;
                        } catch (addError) {
                            console.error("Error adding user from Excel:", userData.email, addError);
                            newUploadErrors.push(`Failed to add ${userData.email} (Row ${usersToProcess.indexOf(userData) + 2}): ${addError.message || 'Unknown error'}`);
                            failedAddCount++;
                        }
                    }

                    setUploadErrors(prevErrors => [...prevErrors, ...newUploadErrors]);

                    if (successfullyAddedCount > 0) {
                        setMessage(`${translations.usersImportedSuccessfully || 'Users imported successfully!'}: ${successfullyAddedCount} ${translations.newUsersAdded || 'new users added'}.`);
                    } else if (newUploadErrors.length === 0 && usersToProcess.length > 0) {
                        setMessage(translations.noNewUsersProcessed || 'No new users were processed from the file. It might contain only existing data.');
                    } else if (newUploadErrors.length === 0 && usersToProcess.length === 0) {
                        setMessage("No new user data found in the Excel file to process.");
                    }
                    else {
                        setMessage(`Upload finished with ${failedAddCount} failures and ${successfullyAddedCount} successes.`);
                    }

                    // Reset file input value to allow uploading the same file again if needed
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }

            } catch (error) {
                console.error("Error reading Excel file:", error);
                setMessage(translations.errorReadingExcelFile || "Error reading Excel file. Please ensure it's valid.");
                setUploadErrors([`${translations.generalError}: ${error.message || 'Unknown error'}`]);
            }
          };

          // NEW FUNCTION: Generate PDF for all employees' calculations
          const generateAllEmployeesCalculationsPdf = async () => {
            const doc = new jspdf.jsPDF();
            const monthName = months[monthlySummaryMonth];
            const fileName = `${translations.allEmployeesReportPdf}_${monthName}_${monthlySummaryYear}.pdf`;

            // Report Title
            doc.setFontSize(22);
            doc.text(translations.reportTitle, doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });

            doc.setFontSize(12);
            doc.text(`${translations.reportFor}: ${monthName}, ${monthlySummaryYear}`, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
            doc.text(`${translations.generatedOn}: ${new Date().toLocaleString()}`, doc.internal.pageSize.getWidth() / 2, 37, { align: 'center' });

            let y = 50;

            const allEmployeesData = [];
            const employees = users.filter(u => u.role === 'employee');

            if (employees.length === 0) {
                doc.addPage();
                doc.setFontSize(14);
                doc.text(translations.noDataForReport, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() / 2, { align: 'center' });
                doc.save(fileName);
                setMessage(translations.noDataForReport);
                return;
            }

            for (const employee of employees) {
                const employeePayments = payments.filter(p =>
                    p.employeeId === employee.id &&
                    p.timestamp &&
                    p.timestamp.getMonth() === monthlySummaryMonth &&
                    p.timestamp.getFullYear() === monthlySummaryYear
                );
                const employeeExpenses = expenses.filter(e =>
                    e.employeeId === employee.id &&
                    e.timestamp &&
                    e.timestamp.getMonth() === monthlySummaryMonth &&
                    e.timestamp.getFullYear() === monthlySummaryYear
                );
                const employeeBonuses = bonuses.filter(b =>
                    b.employeeId === employee.id &&
                    b.timestamp &&
                    b.timestamp.getMonth() === monthlySummaryMonth &&
                    b.timestamp.getFullYear() === monthlySummaryYear
                );

                const totalEarned = employeePayments.reduce((acc, p) => acc + p.amount, 0);
                const totalExpenses = employeeExpenses.reduce((acc, e) => acc + e.amount, 0);
                const totalBonuses = employeeBonuses.reduce((acc, b) => acc + b.amount, 0);
                const netIncome = totalEarned + totalBonuses - totalExpenses;

                allEmployeesData.push({
                    name: getEmployeeName(employee.id),
                    employeeNumber: employee.employeeNumber,
                    branch: getBranchName(employee.branchId),
                    target: employee.targetAmount,
                    totalPayments: totalEarned,
                    totalExpenses: totalExpenses,
                    totalBonuses: totalBonuses,
                    netIncome: netIncome
                });
            }

            const tableHeaders = [
                translations.employeeName,
                translations.employeeNumber,
                translations.branch,
                translations.target,
                translations.totalPayments,
                translations.totalExpensesSummary,
                translations.totalBonusesSummary,
                translations.netIncomeSummary
            ];

            const tableBody = allEmployeesData.map(emp => [
                emp.name,
                emp.employeeNumber,
                emp.branch,
                `SAR ${emp.target.toFixed(2)}`,
                `SAR ${emp.totalPayments.toFixed(2)}`,
                `SAR ${emp.totalExpenses.toFixed(2)}`,
                `SAR ${emp.totalBonuses.toFixed(2)}`,
                `SAR ${emp.netIncome.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: y,
                head: [tableHeaders],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [48, 113, 169], textColor: 255, fontStyle: 'bold' },
                styles: { font: 'Inter', fontSize: 9, cellPadding: 2 },
                margin: { left: 10, right: 10 },
                didDrawPage: function (data) {
                    let str = "Page " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save(fileName);
            setMessage(`${translations.allEmployeesReportPdf} generated successfully!`);
          };


          const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
          ];

          const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


          return (
            <div className="admin-dashboard">
              <nav className="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-wrap justify-center md:justify-start gap-3">
                <button
                  onClick={() => setAdminPage('analytics')}
                  className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'analytics' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  {translations.analyticsOverview}
                </button>
                <button
                  onClick={() => setAdminPage('payments')}
                  className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'payments' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  {translations.realtimePayments}
                </button>
                <button
                    onClick={() => setAdminPage('branches')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'branches' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.branchManagement}
                </button>
                <button
                    onClick={() => setAdminPage('users')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'users' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.userManagement}
                </button>
                <button
                    onClick={() => setAdminPage('paymentMethods')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'paymentMethods' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.paymentMethodsManagement}
                </button>
                <button
                    onClick={() => setAdminPage('employeeFinancials')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'employeeFinancials' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.employeeFinancials}
                </button>
                <button
                    onClick={() => setAdminPage('organizationExpenses')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'organizationExpenses' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.organizationExpenses}
                </button>
                <button
                  onClick={downloadAllDataAsJSON}
                  className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                >
                  {translations.downloadAllDataJSON || 'Download All Data (JSON)'}
                </button>
                <button
                  onClick={downloadAllDataAsExcel}
                  className="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-300 shadow-md"
                >
                  {translations.downloadAllDataExcel || 'Download All Data (Excel)'}
                </button>
                {/* NEW: Download All Employees Calculations PDF Button */}
                <button
                  onClick={generateAllEmployeesCalculationsPdf}
                  className="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md"
                >
                  {translations.downloadAllEmployeesCalculations}
                </button>
              </nav>

              {/* Admin Table Settings */}
              <div className="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-wrap gap-4 items-center">
                <label htmlFor="recordsPerPage" className="text-gray-700 font-semibold">
                    {translations.recordsPerPage}
                </label>
                <select
                    id="recordsPerPage"
                    value={adminRecordsPerPage}
                    onChange={(e) => setAdminRecordsPerPage(Number(e.target.value))}
                    className="p-2 border rounded-md"
                >
                    {[5, 10, 15, 20, 50].map(option => (
                        <option key={option} value={option}>{option}</option>
                    ))}
                </select>

                <label htmlFor="tableTheme" className="text-gray-700 font-semibold">
                    {translations.selectTheme}
                </label>
                <select
                    id="tableTheme"
                    value={adminTableTheme}
                    onChange={(e) => setAdminTableTheme(e.target.value)}
                    className="p-2 border rounded-md"
                >
                    <option value="default">{translations.defaultTheme}</option>
                    <option value="striped">{translations.stripedTheme}</option>
                    <option value="bordered">{translations.borderedTheme}</option>
                    <option value="compact">{translations.compactTheme}</option>
                </select>
              </div>


              {adminPage === 'analytics' && (
                <div className="space-y-6">
                  {/* Date Filter for Analytics */}
                  <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center">
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByDay}:</h3>
                      <input
                          type="date"
                          value={dailySummaryDate}
                          onChange={(e) => {
                              setDailySummaryDate(e.target.value);
                              setDailyEmployeeSummaryDate(e.target.value);
                          }}
                          className="p-2 border rounded-md"
                      />
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByMonth}:</h3>
                      <select
                          value={monthlySummaryMonth}
                          onChange={(e) => setMonthlySummaryMonth(parseInt(e.target.value))}
                          className="p-2 border rounded-md"
                      >
                          {months.map((monthName, index) => (
                              <option key={index} value={index}>{monthName}</option>
                          ))}
                      </select>
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByYear}:</h3>
                      <select
                          value={monthlySummaryYear}
                          onChange={(e) => setMonthlySummaryYear(parseInt(e.target.value))}
                          className="p-2 border rounded-md"
                      >
                          {years.map(year => (
                              <option key={year} value={year}>{year}</option>
                          ))}
                      </select>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Daily Employee Summary */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.dailyEmployeeSummary}</h3>
                      <DailyEmployeeSummary
                            payments={payments}
                            users={users}
                            translations={translations}
                            getEmployeeName={getEmployeeNameOnly}
                            selectedDate={dailyEmployeeSummaryDate}
                            recordsPerPageSetting={adminRecordsPerPage}
                            tableTheme={adminTableTheme}
                          />
                    </div>
                    {/* Daily Branches Summary */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.dailyBranchesSummary}</h3>
                      <DailyBranchesSummary
                            payments={payments}
                            branches={branches}
                            paymentMethods={paymentMethods}
                            translations={translations}
                            getBranchName={getBranchName}
                            getPaymentMethodDetails={getPaymentMethodDetails}
                            selectedDate={dailySummaryDate}
                            recordsPerPageSetting={adminRecordsPerPage}
                            tableTheme={adminTableTheme}
                          />
                    </div>
                    {/* Monthly Payments Summary (Renamed to Monthly Employees Income) */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.monthlyPaymentsSummary}</h3>
                      <MonthlySummaryTable
                            payments={payments}
                            users={users}
                            branches={branches}
                            paymentMethods={paymentMethods}
                            translations={translations}
                            getEmployeeName={getEmployeeNameOnly}
                            getBranchName={getBranchName}
                            getPaymentMethodDetails={getPaymentMethodDetails}
                            selectedMonth={monthlySummaryMonth}
                            selectedYear={monthlySummaryYear}
                            recordsPerPageSetting={adminRecordsPerPage}
                            tableTheme={adminTableTheme}
                          />
                    </div>
                    {/* Monthly Branches Income */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.monthlyBranchesIncome}</h3>
                      <MonthlyBranchesIncome
                            payments={payments}
                            branches={branches}
                            paymentMethods={paymentMethods}
                            translations={translations}
                            getBranchName={getBranchName}
                            getPaymentMethodDetails={getPaymentMethodDetails}
                            selectedMonth={monthlySummaryMonth}
                            selectedYear={monthlySummaryYear}
                            recordsPerPageSetting={adminRecordsPerPage}
                            tableTheme={adminTableTheme}
                          />
                    </div>
                  </div>
                </div>
              )}

              {adminPage === 'payments' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.realtimePayments}</h3>
                  <PaginatedTable
                    data={payments}
                    columns={adminPaymentColumns}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    downloadXLSX={downloadFilteredPaymentsAsExcel}
                    translations={translations}
                    getUserDetails={getUserDetails}
                    getBranchName={getBranchName}
                    getPaymentMethodDetails={getPaymentMethodDetails}
                    showFilters={true}
                    branches={branches}
                    users={users}
                    paymentMethods={paymentMethods}
                    onFilterChange={handleFilterChange}
                    currentFilters={paymentFilters}
                    recordsPerPageSetting={adminRecordsPerPage}
                    tableTheme={adminTableTheme}
                    showMultiSelect={true}
                    selectedItems={selectedPaymentIds}
                    onMultiSelectChange={setSelectedPaymentIds}
                    onDeleteSelected={async (ids) => {
                        const confirmed = window.confirm(translations.confirmDeletePaymentMethod); // This translation is for method, but close enough for now
                        if (confirmed) {
                            // Since deletePayment is not passed into AdminDashboard directly,
                            // we need to access it from useAppContext.
                            const { deletePayment } = useAppContext();
                            if (typeof deletePayment === 'function') {
                                for (const id of ids) {
                                    await deletePayment(id);
                                }
                                setMessage(`${ids.length} payments deleted successfully!`);
                                setSelectedPaymentIds([]);
                            } else {
                                setMessage("Delete payment function not available.");
                                console.error("deletePayment function is not defined in useAppContext.");
                            }
                        }
                    }}
                    onApplyPaymentMethodToSelected={async (ids, newMethod) => {
                        if (window.confirm(`Are you sure you want to change payment method for ${ids.length} payments to ${getPaymentMethodDetails(newMethod)}?`)) {
                            for (const id of ids) {
                                await editPayment(id, { paymentMethod: newMethod });
                            }
                            setMessage(`Payment method updated for ${ids.length} payments!`);
                            setSelectedPaymentIds([]);
                        }
                    }}
                  />

                    <Modal
                        title={`${translations.editPaymentModalTitle} ${editingPayment?.paymentNumber || ''})`}
                        isOpen={isPaymentModalOpen}
                        onClose={() => { setIsPaymentModalOpen(false); setEditingPayment(null); }}
                    >
                        {editingPayment && (
                            <EditPaymentForm
                                payment={editingPayment}
                                onSave={(updated) => {
                                    editPayment(editingPayment.id, updated);
                                    setIsPaymentModalOpen(false);
                                    setEditingPayment(null);
                                }}
                                onCancel={() => { setIsPaymentModalOpen(false); setEditingPayment(null); }}
                                users={users}
                                branches={branches}
                                paymentMethods={paymentMethods}
                                translations={translations}
                                getUserDetails={getUserDetails}
                                getPaymentMethodDetails={getPaymentMethodDetails}
                            />
                        )}
                    </Modal>
                </div>
              )}

              {adminPage === 'branches' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-semibold text-gray-800">{translations.branchManagement}</h3>
                    <button
                        onClick={() => { setEditingBranch(null); setIsBranchModalOpen(true); }}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                    >
                        {translations.addBranch}
                    </button>
                  </div>
                  <PaginatedTable
                        data={branches}
                        columns={branchColumns}
                        searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                        translations={translations}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                  />

                  <Modal
                        title={editingBranch ? translations.editBranchModalTitle : translations.addBranchModalTitle}
                        isOpen={isBranchModalOpen}
                        onClose={() => { setIsBranchModalOpen(false); setEditingBranch(null); }}
                  >
                    <BranchForm
                          branch={editingBranch}
                          onSave={(name, location) => {
                            if (editingBranch) {
                              editBranch(editingBranch.id, name, location);
                            } else {
                              addBranch(name, location);
                            }
                            setIsBranchModalOpen(false);
                            setEditingBranch(null);
                          }}
                          onCancel={() => { setIsBranchModalOpen(false); setEditingBranch(null); }}
                          translations={translations}
                        />
                  </Modal>
                </div>
              )}

              {adminPage === 'users' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <div className="flex justify-between items-center mb-4 flex-wrap gap-3">
                    <h3 className="text-2xl font-semibold text-gray-800">{translations.userManagement}</h3>
                    <div className="flex gap-3">
                        <button
                            onClick={downloadSampleUserExcel}
                            className="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 shadow-md"
                        >
                            {translations.downloadUserTemplate || 'Download Sample Excel'}
                        </button>
                        <label className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md cursor-pointer">
                            {translations.uploadExcel}
                            <input
                                type="file"
                                ref={fileInputRef}
                                className="hidden"
                                accept=".xlsx, .xls"
                                onChange={handleUserExcelUpload}
                            />
                        </label>
                        <button
                            onClick={() => { setEditingUser(null); setIsUserModalOpen(true); }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                        >
                            {translations.addUser}
                        </button>
                    </div>
                  </div>
                  {uploadErrors.length > 0 && (
                      <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                          <strong className="font-bold">{translations.uploadErrorsDetected || "Upload Errors Detected!"}</strong>
                          <ul className="mt-2 list-disc list-inside">
                              {uploadErrors.map((error, index) => (
                                  <li key={index}>{error}</li>
                              ))}
                          </ul>
                      </div>
                  )}
                  {selectedUserIds.length > 0 && (
                      <button
                          onClick={handleDeleteSelectedUsers}
                          className="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md"
                      >
                          {translations.deleteSelected} ({selectedUserIds.length})
                      </button>
                  )}
                  <PaginatedTable
                        data={users}
                        columns={userColumns}
                        searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                        translations={translations}
                        getBranchName={getBranchName}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                        showMultiSelect={true}
                        selectedItems={selectedUserIds}
                        onMultiSelectChange={setSelectedUserIds}
                  />

                  <Modal
                        title={editingUser ? translations.editUserModalTitle : translations.addUserModalTitle}
                        isOpen={isUserModalOpen}
                        onClose={() => { setIsUserModalOpen(false); setEditingUser(null); }}
                  >
                    <UserForm
                          user={editingUser}
                          onSave={(updatedUser) => {
                            if (editingUser) {
                              editUser(editingUser.id, updatedUser);
                            } else {
                              try {
                                  addUser(updatedUser.name, updatedUser.email, updatedUser.role, updatedUser.branchId, updatedUser.targetAmount, updatedUser.employeeNumber, updatedUser.nameAr, updatedUser.imageUrl);
                                  setIsUserModalOpen(false);
                                  setEditingUser(null);
                              } catch (error) {
                                  console.error("User form add error:", error);
                              }
                            }
                          }}
                          onCancel={() => { setIsUserModalOpen(false); setEditingUser(null); }}
                          branches={branches}
                          translations={translations}
                          setMessage={setMessage}
                          adminResetUserPassword={adminResetUserPassword}
                        />
                  </Modal>
                </div>
              )}

              {adminPage === 'paymentMethods' && (
                  <div className="bg-white p-6 rounded-lg shadow-lg">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-semibold text-gray-800">{translations.paymentMethodsManagement}</h3>
                          <button
                              onClick={() => { setEditingPaymentMethod(null); setIsPaymentMethodModalOpen(true); }}
                              className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                          >
                              {translations.addPaymentMethod}
                          </button>
                      </div>
                      <PaginatedTable
                              data={paymentMethods}
                              columns={paymentMethodColumns}
                              searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                              translations={translations}
                              recordsPerPageSetting={adminRecordsPerPage}
                              tableTheme={adminTableTheme}
                          />

                      <Modal
                              title={editingPaymentMethod ? translations.editPaymentMethodModalTitle : translations.addPaymentMethodModalTitle}
                              isOpen={isPaymentMethodModalOpen}
                              onClose={() => { setIsPaymentMethodModalOpen(false); setEditingPaymentMethod(null); }}
                          >
                          <PaymentMethodForm
                                  method={editingPaymentMethod}
                                  onSave={(name, nameAr, icon, color) => {
                                      if (editingPaymentMethod) {
                                          editPaymentMethod(editingPaymentMethod.id, { name, nameAr, icon, color });
                                      } else {
                                          addPaymentMethod(name, nameAr, icon, color);
                                      }
                                      setIsPaymentMethodModalOpen(false);
                                      setEditingPaymentMethod(null);
                                  }}
                                  onCancel={() => { setIsPaymentMethodModalOpen(false); setEditingPaymentMethod(null); }}
                                  translations={translations}
                                  setMessage={setMessage}
                              />
                          </Modal>
                  </div>
              )}

              {adminPage === 'employeeFinancials' && (
                      <EmployeeFinancials
                          users={users.filter(u => u.role === 'employee')}
                          expenses={expenses}
                          bonuses={bonuses}
                          addExpense={addExpense}
                          editExpense={editExpense}
                          deleteExpense={deleteExpense}
                          addBonus={addBonus}
                          editBonus={editBonus}
                          deleteBonus={deleteBonus}
                          translations={translations}
                          setMessage={setMessage}
                          selectedMonth={financialsMonth}
                          selectedYear={financialsYear}
                          setFinancialsMonth={setFinancialsMonth}
                          setFinancialsYear={setFinancialsYear}
                          appId={appId}
                          // Passed directly to EmployeeFinancials component, no longer Admin-defined here
                          // recordsPerPageSetting={adminRecordsPerPage}
                          // tableTheme={adminTableTheme}
                      />
              )}

              {adminPage === 'organizationExpenses' && (
                      <OrganizationExpensesDashboard
                          payments={payments}
                          organizationExpenses={organizationExpenses}
                          addOrganizationExpense={addOrganizationExpense}
                          editOrganizationExpense={editOrganizationExpense}
                          deleteOrganizationExpense={deleteOrganizationExpense}
                          translations={translations}
                          setMessage={setMessage}
                          appId={appId}
                          // Passed directly to OrganizationExpensesDashboard component, no longer Admin-defined here
                          // recordsPerPageSetting={adminRecordsPerPage}
                          // tableTheme={adminTableTheme}
                      />
              )}
            </div>
          );
        };

        // Expose AdminDashboard globally
        window.App.AdminDashboard = AdminDashboard;

    </script>
</body>
</html>

