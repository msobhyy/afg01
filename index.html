
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure the app takes full height */
        #root {
            min-height: 100vh;
        }
        /* Custom styles for pagination buttons */
        .pagination-button {
            @apply px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md;
        }
        .pagination-button.active {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .pagination-button.inactive {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .pagination-button:disabled {
            @apply opacity-50 cursor-not-allowed;
        }
        /* Styles for larger payment method icons */
        .payment-method-icon {
            color: #FF6F61; /* Coral for vibrant contrast */
            background-color: #F0F0F0; /* Light gray background */
            font-size: 2.5rem;
            line-height: 1;
            margin-right: 1rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Include SheetJS (xlsx) for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions globally for the Babel script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            updatePassword,
            getFirestore,
            collection,
            query,
            onSnapshot,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            getDocs,
            where
        };
    </script>

    <script type="text/babel">
        // Destructure React hooks and components from the global React object
        const { useState, useEffect, createContext, useContext, useRef } = React;

        // Create a context for App data and simulated auth
        const AppContext = createContext(null);

        // Custom hook to use the AppContext
        const useAppContext = () => useContext(AppContext);

        // Translations Object
        const translations = {
          en: {
            appName: 'Shop App',
            welcome: 'Welcome,',
            userId: 'User ID:',
            logout: 'Logout',
            loginWelcome: 'Welcome! Please Log In',
            emailPlaceholder: 'Email or Employee ID',
            passwordPlaceholder: 'Password (any for demo)',
            loginButton: 'Login',
            loginError: 'Invalid email/employee ID or password.',
            admin: 'Admin',
            supervisor: 'Supervisor',
            employeeRole: 'Employee',
            partner: 'Partner', // New role
            branch: 'Branch',
            mainBranch: 'Main Branch',
            downtownStore: 'Downtown Store',
            allEmployees: 'All Employees',
            duplicateEntrySkipped: 'Skipping duplicate entry.',
            dailyBranchesSummary: 'Daily Branches Summary',
            monthlyBranchesIncome: 'Monthly Branches Income',
            organizationExpenses: 'Organization Expenses',
            totalOrganizationIncome: 'Total Organization Income',
            totalOrganizationExpenses: 'Total Organization Expenses',
            netOrganizationResult: 'Net Organization Result',
            managementTeamSalary: 'Management Team Salary',
            tools: 'Tools',
            equipment: 'Equipment',
            insurance: 'Insurance',
            violations: 'Violations',
            bankLoans: 'Bank Loans',
            internet: 'Internet',
            maintenance: 'Maintenance',
            newInstallations: 'New Installations',
            financing: 'Financing',
            profitForPartners: 'Profit for Partners',
            date: 'Date',
            employee: 'Employee',
            branchName: 'Branch Name',
            totalEarned: 'Total Earned',
            cash: 'Cash',
            mada: 'Mada Pay',
            methods: 'Methods',
            total: 'Total',
            monthlyPaymentsSummary: 'Monthly Payments Summary',
            month: 'Month',
            year: 'Year',
            noDailyPaymentData: 'No daily payment data available.',
            noMonthlyPaymentData: 'No monthly payment data available.',
            branchManagement: 'Branch Management',
            addBranch: 'Add New Branch',
            name: 'Name',
            location: 'Location',
            actions: 'Actions',
            edit: 'Edit',
            delete: 'Delete',
            userManagement: 'User Management',
            addUser: 'Add New User',
            role: 'Role',
            target: 'Target',
            employeeNo: 'Employee No.',
            realtimePayments: 'Real-time Payments',
            serialNo: 'Serial No.',
            amount: 'Amount',
            method: 'Method',
            timestamp: 'Timestamp',
            addedBy: 'Added By',
            addBranchModalTitle: 'Add New Branch',
            branchNamePlaceholder: 'e.g., Downtown Store',
            branchLocationPlaceholder: 'e.g., 123 Main St, City',
            cancel: 'Cancel',
            saveChanges: 'Save Changes',
            editBranchModalTitle: 'Edit Branch',
            addUserModalTitle: 'Add New User',
            userNamePlaceholder: 'e.g., Jane Doe',
            userNameArPlaceholder: 'e.g., جنى محمد',
            userEmailPlaceholder: 'e.g., jane.doe@example.com',
            selectRole: 'Select Role',
            selectBranch: 'Select Branch',
            targetAmountSar: 'Target Amount (SAR)',
            employeeNumber: 'Employee Number',
            imageUrl: 'Image URL',
            editUserModalTitle: 'Edit User',
            editPaymentModalTitle: 'Edit Payment (Serial No:',
            paymentAmountSar: 'Amount (SAR)',
            paymentMethod: 'Payment Method',
            cash: 'Cash',
            visa: 'Visa',
            bankTransfer: 'Bank Transfer',
            masterCard: 'MasterCard',
            applePay: 'Apple Pay',
            madaPay: 'Mada Pay',
            supervisorDashboard: 'Supervisor Dashboard',
            addEmployeePayment: 'Add Employee Payment',
            selectEmployee: '1. Select Employee',
            noEmployeesInBranch: 'No employees in this branch.',
            selectPaymentMethod: '2. Select Payment Method for',
            enterAmount: '3. Enter Amount for',
            enterAmountPlaceholder: 'Enter amount',
            add: 'Add',
            recentPaymentsInBranch: 'Recent Payments in Your Branch',
            time: 'Time',
            employeeDashboard: 'Employee Dashboard',
            yourBranch: 'Your Branch',
            yourTarget: 'Your Target',
            remainingToTarget: 'Remaining to Target',
            yourPaymentsHistory: 'Your Payments History',
            yourExpensesHistory: 'Your Expenses History',
            yourBonusesHistory: 'Your Bonuses History',
            pleaseEnterBranchNameAndLocation: 'Please enter branch name and location.',
            branchAddedSuccessfully: 'Branch added successfully!',
            branchUpdatedSuccessfully: 'Branch updated successfully!',
            confirmDeleteBranch: 'Are you sure you want to delete this branch and all associated data?',
            branchDeletedSuccessfully: 'Branch deleted successfully!',
            pleaseFillAllUserFields: 'Please fill all user fields.',
            pleaseSelectBranchForSupervisorEmployee: 'Please select a branch for supervisor/employee.',
            userAddedSuccessfully: 'User added successfully!',
            userUpdatedSuccessfully: 'User updated successfully!',
            confirmDeleteUser: 'Are you sure you want to delete this user and all associated payments?',
            userDeletedSuccessfully: 'User deleted successfully!',
            pleaseFillAllPaymentFields: 'Please fill all payment fields correctly.',
            paymentUpdatedSuccessfully: 'Payment updated successfully!',
            noPaymentsToDownload: 'No payments to download.',
            paymentsDataDownloadedSuccessfully: 'Payments data downloaded successfully!',
            allDataBackedUpSuccessfully: 'All data backed up as JSON successfully!',
            pleaseEnterValidAmount: 'Please enter a valid amount.',
            amountEntryCancelled: 'Amount entry cancelled.',
            paymentAddedSuccessfully: 'Payment added successfully!',
            errorEmployeeOrPaymentMethodMissing: 'Error: Employee or payment method missing. Please restart the process.',
            downloadPaymentsXLSX: 'Download Payments (XLSX)',
            downloadAllDataXLSX: 'Download All Data (JSON Backup)',
            last5PaymentsFor: 'Last 5 Payments for',
            via: 'via',
            search: 'Search',
            sort: 'Sort by',
            newestToOldest: 'Newest to Oldest',
            oldestToNewest: 'Oldest to Newest',
            itemsPerPage: 'Items per page:',
            previous: 'Previous',
            next: 'Next',
            downloadFilteredXLSX: 'Download Filtered (XLSX)',
            all: 'All',
            selectBranchFilter: 'Select Branch',
            selectEmployeeFilter: 'Select Employee',
            selectPaymentMethodFilter: 'Select Payment Method',
            filter: 'Filter',
            clearFilters: 'Clear Filters',
            backToDashboard: 'Back to Dashboard',
            paymentMethodsManagement: 'Payment Methods Management',
            addPaymentMethod: 'Add New Payment Method',
            icon: 'Icon',
            color: 'Color',
            addPaymentMethodModalTitle: 'Add New Payment Method',
            editPaymentMethodModalTitle: 'Edit Payment Method',
            methodNamePlaceholder: 'e.g., Cash',
            methodNameArPlaceholder: 'e.g., نقدًا',
            methodIconPlaceholder: 'e.g., 💰',
            methodColorPlaceholder: 'e.g., #FF6F61',
            confirmDeletePaymentMethod: 'Are you sure you want to delete this payment method?',
            paymentMethodAddedSuccessfully: 'Payment method added successfully!',
            paymentMethodUpdatedSuccessfully: 'Payment method updated successfully!',
            paymentMethodDeletedSuccessfully: 'Payment method deleted successfully!',
            pleaseEnterMethodName: 'Please enter method name.',
            fromDate: 'From Date',
            toDate: 'To Date',
            filterByYear: 'Filter by Year',
            filterByMonth: 'Filter by Month',
            filterByDay: 'Filter by Day',
            selectYear: 'Select Year',
            selectMonth: 'Select Month',
            selectDay: 'Select Day',
            jan: 'January', feb: 'February', mar: 'March', apr: 'April', may: 'May', jun: 'June',
            jul: 'July', aug: 'August', sep: 'September', oct: 'October', nov: 'November', dec: 'December',
            changePassword: 'Change Password',
            enterNewPassword: 'Enter New Password',
            confirmNewPassword: 'Confirm New Password',
            passwordMismatch: 'Passwords do not match.',
            passwordChangedSuccessfully: 'Password changed successfully (for demo).',
            passwordChangeError: 'Error changing password.',
            employeeFinancials: 'Employee Financials',
            addExpense: 'Add Expense',
            editExpense: 'Edit Expense',
            deleteExpense: 'Delete Expense',
            addBonus: 'Add Bonus',
            editBonus: 'Edit Bonus',
            deleteBonus: 'Delete Bonus',
            selectEmployeeForFinancials: 'Select Employee',
            expenseType: 'Expense Type',
            expenseAmount: 'Expense Amount (SAR)',
            description: 'Description',
            bonusAmount: 'Bonus Amount (SAR)',
            rental: 'Rental',
            electricity: 'Electricity',
            bill: 'Bill',
            tickets: 'Tickets',
            internet: 'Internet',
            consumables: 'Consumables',
            penalties: 'Penalties',
            loans: 'Loans',
            totalExpenses: 'Total Expenses',
            totalBonuses: 'Total Bonuses',
            netIncome: 'Net Income',
            noExpenses: 'No expenses for this employee.',
            noBonuses: 'No bonuses for this employee.',
            pleaseSelectEmployee: 'Please select an employee.',
            pleaseEnterAllFields: 'Please fill all fields.',
            expenseAddedSuccessfully: 'Expense added successfully!',
            expenseUpdatedSuccessfully: 'Expense updated successfully!',
            expenseDeletedSuccessfully: 'Expense deleted successfully!',
            bonusAddedSuccessfully: 'Bonus added successfully!',
            bonusUpdatedSuccessfully: 'Bonus updated successfully!',
            bonusDeletedSuccessfully: 'Bonus deleted successfully!',
            downloadSampleExcel: 'Download Sample Excel',
            uploadExcel: 'Upload Excel',
            chooseExcelFile: 'Choose Excel File',
            excelUploadSuccess: 'Excel file uploaded and data processed successfully!',
            excelUploadError: 'Error processing Excel file.',
            invalidExcelFormat: 'Invalid Excel format. Please ensure correct columns: employeeNumber, type, amount, description, month, year.',
            selectMonthYear: 'Select Month/Year',
            noDataForSelectedPeriod: 'No data available for the selected month and year.',
            currentBalance: 'Current Balance',
            register: 'Register',
            forgotPassword: 'Forgot Password?',
            registerAdminTask: 'Registration request sent to admin. Please contact them for account activation.',
            forgotPasswordAdminTask: 'Password reset request sent to admin. Please contact them for assistance.',
            manageUsersBranchesPayments: 'Manage Users, Branches & Payments', // New grouped translation
            selectTheme: 'Select Table Theme',
            defaultTheme: 'Default',
            stripedTheme: 'Striped',
            borderedTheme: 'Bordered',
            compactTheme: 'Compact',
            recordsPerPage: 'Records per page:',
            deleteSelected: 'Delete Selected',
            applyPaymentMethod: 'Apply Payment Method',
            selectPaymentMethodForSelected: 'Select payment method for selected payments',
            approved: 'Approved',
          },
          ar: {
            appName: 'تطبيق المتجر',
            welcome: 'أهلاً بك،',
            userId: 'معرف المستخدم:',
            logout: 'تسجيل الخروج',
            loginWelcome: 'أهلاً بك! الرجاء تسجيل الدخول',
            emailPlaceholder: 'البريد الإلكتروني أو رقم الموظف',
            passwordPlaceholder: 'كلمة المرور (أي شيء للعرض)',
            loginButton: 'تسجيل الدخول',
            loginError: 'بريد إلكتروني/رقم موظف أو كلمة مرور غير صحيحة.',
            admin: 'المشرف',
            supervisor: 'المشرف الفرعي',
            employeeRole: 'الموظف',
            partner: 'الشريك', // New role
            branch: 'الفرع',
            mainBranch: 'الفرع الرئيسي',
            downtownStore: 'متجر وسط المدينة',
            allEmployees: 'جميع الموظفين',
            duplicateEntrySkipped: 'تم تخطي الإدخال المكرر.',
            dailyBranchesSummary: 'ملخص الفروع اليومي',
            monthlyBranchesIncome: 'إيرادات الفروع الشهرية',
            organizationExpenses: 'مصروفات المنظمة',
            totalOrganizationIncome: 'إجمالي إيرادات المنظمة',
            totalOrganizationExpenses: 'إجمالي مصروفات المنظمة',
            netOrganizationResult: 'صافي نتيجة المنظمة',
            managementTeamSalary: 'رواتب فريق الإدارة',
            tools: 'أدوات',
            equipment: 'معدات',
            insurance: 'تأمين',
            violations: 'مخالفات',
            bankLoans: 'قروض بنكية',
            internet: 'إنترنت',
            maintenance: 'صيانة',
            newInstallations: 'تجهيزات جديدة',
            financing: 'تمويل',
            profitForPartners: 'أرباح الشركاء',
            date: 'التاريخ',
            employee: 'الموظف',
            branchName: 'اسم الفرع',
            totalEarned: 'إجمالي المكتسب',
            cash: 'نقداً',
            mada: 'مدى باي',
            methods: 'الطرق',
            total: 'الإجمالي',
            monthlyPaymentsSummary: 'ملخص المدفوعات الشهرية',
            month: 'الشهر',
            year: 'السنة',
            noDailyPaymentData: 'لا توجد بيانات دفع يومية متاحة.',
            noMonthlyPaymentData: 'لا توجد بيانات دفع شهرية متاحة.',
            branchManagement: 'إدارة الفروع',
            addBranch: 'إضافة فرع جديد',
            name: 'الاسم',
            location: 'الموقع',
            actions: 'الإجراءات',
            edit: 'تعديل',
            delete: 'حذف',
            userManagement: 'إدارة المستخدمين',
            addUser: 'إضافة مستخدم جديد',
            role: 'الدور',
            target: 'الهدف',
            employeeNo: 'رقم الموظف',
            realtimePayments: 'المدفوعات في الوقت الفعلي',
            serialNo: 'الرقم التسلسلي',
            amount: 'المبلغ',
            method: 'طريقة الدفع',
            timestamp: 'التاريخ والوقت',
            addedBy: 'أضيفت بواسطة',
            addBranchModalTitle: 'إضافة فرع جديد',
            branchNamePlaceholder: 'مثال: متجر وسط المدينة',
            branchLocationPlaceholder: 'مثال: شارع الملك فهد، الرياض',
            cancel: 'إلغاء',
            saveChanges: 'حفظ التغييرات',
            editBranchModalTitle: 'تعديل الفرع',
            addUserModalTitle: 'إضافة مستخدم جديد',
            userNamePlaceholder: 'مثال: سارة محمد',
            userNameArPlaceholder: 'مثال: سارة محمد',
            userEmailPlaceholder: 'مثال: sara.mohamed@example.com',
            selectRole: 'اختر الدور',
            selectBranch: 'اختر الفرع',
            targetAmountSar: 'المبلغ المستهدف (ريال سعودي)',
            employeeNumber: 'رقم الموظف',
            imageUrl: 'رابط الصورة',
            editUserModalTitle: 'تعديل المستخدم',
            editPaymentModalTitle: 'تعديل الدفع (الرقم التسلسلي:',
            paymentAmountSar: 'المبلغ (ريال سعودي)',
            paymentMethod: 'طريقة الدفع',
            cash: 'نقداً',
            visa: 'فيزا',
            bankTransfer: 'تحويل بنكي',
            masterCard: 'ماستركارد',
            applePay: 'آبل باي',
            madaPay: 'مدى باي',
            supervisorDashboard: 'لوحة تحكم المشرف',
            addEmployeePayment: 'إضافة دفعة للموظف',
            selectEmployee: '1. اختر الموظف',
            noEmployeesInBranch: 'لا يوجد موظفون في هذا الفرع.',
            selectPaymentMethod: '2. اختر طريقة الدفع لـ',
            enterAmount: '3. أدخل المبلغ لـ',
            enterAmountPlaceholder: 'أدخل المبلغ',
            add: 'إضافة',
            recentPaymentsInBranch: 'المدفوعات الأخيرة في فرعك',
            time: 'الوقت',
            employeeDashboard: 'لوحة تحكم الموظف',
            yourBranch: 'فرعك',
            yourTarget: 'هدفك',
            remainingToTarget: 'المتبقي للهدف',
            yourPaymentsHistory: 'سجل مدفوعاتك',
            yourExpensesHistory: 'سجل مصروفاتك',
            yourBonusesHistory: 'سجل مكافآتك',
            pleaseEnterBranchNameAndLocation: 'الرجاء إدخال اسم الفرع والموقع.',
            branchAddedSuccessfully: 'تمت إضافة الفرع بنجاح!',
            branchUpdatedSuccessfully: 'تم تحديث الفرع بنجاح!',
            confirmDeleteBranch: 'هل أنت متأكد من رغبتك في حذف هذا الفرع وجميع البيانات المرتبطة به؟',
            branchDeletedSuccessfully: 'تم حذف الفرع بنجاح!',
            pleaseFillAllUserFields: 'الرجاء ملء جميع حقول المستخدم.',
            pleaseSelectBranchForSupervisorEmployee: 'الرجاء اختيار فرع للمشرف/الموظف.',
            userAddedSuccessfully: 'تمت إضافة المستخدم بنجاح!',
            userUpdatedSuccessfully: 'تم تحديث المستخدم بنجاح!',
            confirmDeleteUser: 'هل أنت متأكد من رغبتك في حذف هذا المستخدم وجميع المدفوعات المرتبطة به؟',
            userDeletedSuccessfully: 'تم حذف المستخدم بنجاح!',
            pleaseFillAllPaymentFields: 'الرجاء ملء جميع حقول الدفع بشكل صحيح.',
            paymentUpdatedSuccessfully: 'تم تحديث الدفع بنجاح!',
            noPaymentsToDownload: 'لا توجد مدفوعات لتنزيلها.',
            paymentsDataDownloadedSuccessfully: 'تم تنزيل بيانات المدفوعات بنجاح!',
            allDataBackedUpSuccessfully: 'تم عمل نسخة احتياطية لجميع البيانات بتنسيق JSON بنجاح!',
            pleaseEnterValidAmount: 'الرجاء إدخال مبلغ صالح.',
            amountEntryCancelled: 'تم إلغاء إدخال المبلغ.',
            paymentAddedSuccessfully: 'تمت إضافة الدفع بنجاح!',
            errorEmployeeOrPaymentMethodMissing: 'خطأ: الموظف أو طريقة الدفع مفقودة. الرجاء إعادة العملية.',
            downloadPaymentsXLSX: 'تنزيل المدفوعات (XLSX)',
            downloadAllDataXLSX: 'تنزيل جميع البيانات (نسخة احتياطية JSON)',
            last5PaymentsFor: 'آخر 5 مدفوعات لـ',
            via: 'عبر',
            search: 'بحث',
            sort: 'ترتيب حسب',
            newestToOldest: 'الأحدث للأقدم',
            oldestToNewest: 'الأقدم للأحدث',
            itemsPerPage: 'العناصر لكل صفحة:',
            previous: 'السابق',
            next: 'التالي',
            downloadFilteredXLSX: 'تنزيل المصفاة (XLSX)',
            all: 'الكل',
            selectBranchFilter: 'اختر الفرع',
            selectEmployeeFilter: 'اختر الموظف',
            selectPaymentMethodFilter: 'اختر طريقة الدفع',
            filter: 'تصفية',
            clearFilters: 'مسح الفلاتر',
            backToDashboard: 'العودة للوحة التحكم',
            paymentMethodsManagement: 'إدارة طرق الدفع',
            addPaymentMethod: 'إضافة طريقة دفع جديدة',
            icon: 'أيقونة',
            color: 'اللون',
            addPaymentMethodModalTitle: 'إضافة طريقة دفع جديدة',
            editPaymentMethodModalTitle: 'تعديل طريقة الدفع',
            methodNamePlaceholder: 'مثال: نقداً',
            methodNameArPlaceholder: 'مثال: نقدًا',
            methodIconPlaceholder: 'مثال: 💰',
            methodColorPlaceholder: 'مثال: #FF6F61',
            confirmDeletePaymentMethod: 'هل أنت متأكد من رغبتك في حذف طريقة الدفع هذه؟',
            paymentMethodAddedSuccessfully: 'تمت إضافة طريقة الدفع بنجاح!',
            paymentMethodUpdatedSuccessfully: 'تم تحديث طريقة الدفع بنجاح!',
            paymentMethodDeletedSuccessfully: 'تم حذف طريقة الدفع بنجاح!',
            pleaseEnterMethodName: 'الرجاء إدخال اسم طريقة الدفع.',
            fromDate: 'من تاريخ',
            toDate: 'إلى تاريخ',
            filterByYear: 'تصفية حسب السنة',
            filterByMonth: 'تصفية حسب الشهر',
            filterByDay: 'تصفية حسب اليوم',
            selectYear: 'اختر السنة',
            selectMonth: 'اختر الشهر',
            selectDay: 'اختر اليوم',
            jan: 'يناير', feb: 'فبراير', mar: 'مارس', apr: 'أبريل', may: 'مايو', jun: 'يونيو',
            jul: 'يوليو', aug: 'أغسطس', sep: 'سبتمبر', oct: 'أكتوبر', nov: 'نوفمبر', dec: 'ديسمبر',
            changePassword: 'تغيير كلمة المرور',
            enterNewPassword: 'أدخل كلمة مرور جديدة',
            confirmNewPassword: 'تأكيد كلمة المرور الجديدة',
            passwordMismatch: 'كلمتا المرور غير متطابقتين.',
            passwordChangedSuccessfully: 'تم تغيير كلمة المرور بنجاح (للعرض التوضيحي).',
            passwordChangeError: 'خطأ في تغيير كلمة المرور.',
            employeeFinancials: 'الماليات للموظفين',
            addExpense: 'إضافة مصروف',
            editExpense: 'تعديل مصروف',
            deleteExpense: 'حذف مصروف',
            addBonus: 'إضافة مكافأة',
            editBonus: 'تعديل مكافأة',
            deleteBonus: 'حذف مكافأة',
            selectEmployeeForFinancials: 'اختر الموظف',
            expenseType: 'نوع المصروف',
            expenseAmount: 'مبلغ المصروف (ريال سعودي)',
            description: 'الوصف',
            bonusAmount: 'مبلغ المكافأة (ريال سعودي)',
            rental: 'إيجار',
            electricity: 'كهرباء',
            bill: 'فواتير',
            tickets: 'تذاكر',
            internet: 'إنترنت',
            consumables: 'مواد استهلاكية',
            penalties: 'غرامات',
            loans: 'قروض',
            totalExpenses: 'إجمالي المصروفات',
            totalBonuses: 'إجمالي المكافآت',
            netIncome: 'صافي الدخل',
            noExpenses: 'لا توجد مصروفات لهذا الموظف.',
            noBonuses: 'لا توجد مكافآت لهذا الموظف.',
            pleaseSelectEmployee: 'الرجاء اختيار موظف.',
            pleaseEnterAllFields: 'الرجاء ملء جميع الحقول.',
            expenseAddedSuccessfully: 'تمت إضافة المصروف بنجاح!',
            expenseUpdatedSuccessfully: 'تم تحديث المصروف بنجاح!',
            expenseDeletedSuccessfully: 'تم حذف المصروف بنجاح!',
            bonusAddedSuccessfully: 'تمت إضافة المكافأة بنجاح!',
            bonusUpdatedSuccessfully: 'تم تحديث المكافأة بنجاح!',
            bonusDeletedSuccessfully: 'تم حذف المكافأة بنجاح!',
            downloadSampleExcel: 'تنزيل ملف إكسل (نموذج)',
            uploadExcel: 'رفع ملف إكسل',
            chooseExcelFile: 'اختر ملف إكسل',
            excelUploadSuccess: 'تم تحميل ملف إكسل ومعالجة البيانات بنجاح!',
            excelUploadError: 'حدث خطأ أثناء معالجة ملف إكسل.',
            invalidExcelFormat: 'تنسيق إكسل غير صالح. يرجى التأكد من الأعمدة الصحيحة: employeeNumber, type, amount, description, month, year.',
            selectMonthYear: 'اختر الشهر/السنة',
            noDataForSelectedPeriod: 'لا توجد بيانات للفترة المحددة.',
            currentBalance: 'الرصيد الحالي',
            register: 'تسجيل',
            forgotPassword: 'هل نسيت كلمة المرور؟',
            registerAdminTask: 'تم إرسال طلب التسجيل إلى المشرف. يرجى الاتصال بهم لتفعيل الحساب.',
            forgotPasswordAdminTask: 'تم إرسال طلب إعادة تعيين كلمة المرور إلى المشرف. يرجى الاتصال بهم للمساعدة.',
            manageUsersBranchesPayments: 'إدارة المستخدمين والفروع والمدفوعات', // New grouped translation
            selectTheme: 'اختر مظهر الجدول',
            defaultTheme: 'افتراضي',
            stripedTheme: 'مخطط',
            borderedTheme: 'بحدود',
            compactTheme: 'مضغوط',
            recordsPerPage: 'السجلات لكل صفحة:',
            deleteSelected: 'حذف المحدد',
            applyPaymentMethod: 'تطبيق طريقة الدفع',
            selectPaymentMethodForSelected: 'اختر طريقة الدفع للمدفوعات المحددة',
            approved: 'تمت الموافقة',
          },
        };


        // Main App component
        const App = () => {
          const [isLoggedIn, setIsLoggedIn] = useState(false);
          const [currentUser, setCurrentUser] = useState(null);
          const [users, setUsers] = useState([]);
          const [branches, setBranches] = useState([]);
          const [payments, setPayments] = useState([]);
          const [paymentMethods, setPaymentMethods] = useState([]);
          const [expenses, setExpenses] = useState([]); // New state for expenses
          const [bonuses, setBonuses] = useState([]); // New state for bonuses
          const [organizationExpenses, setOrganizationExpenses] = useState([]); // New state for organization expenses
          const [loginError, setLoginError] = useState('');
          const [language, setLanguage] = useState('ar');
          const [loading, setLoading] = useState(true);
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [appId, setAppId] = useState('');
          const [userId, setUserId] = useState(null);
          const [message, setMessage] = useState('');

          useEffect(() => {
            const initFirebase = async () => {
                let configToUse = null;
                try {
                    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                        configToUse = JSON.parse(__firebase_config);
                        console.log("Using Firebase config from Canvas environment.");
                    }
                } catch (parseError) {
                    console.warn("Could not parse __firebase_config from Canvas environment. Falling back to hardcoded config.", parseError);
                }

                if (!configToUse) {
                    configToUse = {
                        apiKey: "AIzaSyDazyxOVaF0gJPw9z3KOctXOr8hernzfCg",
                        authDomain: "afg-3006-01.firebaseapp.com",
                        projectId: "afg-3006-01",
                        storageBucket: "afg-3006-01.firebasestorage.app",
                        messagingSenderId: "734860701348",
                        appId: "1:734860701348:web:b68312f0748d3970c00031",
                        measurementId: "G-CJ95TXTD9D"
                    };
                    console.log("Using hardcoded Firebase config.");
                }

                try {
                    const currentAppId = typeof __app_id !== 'undefined' ? __app_id : configToUse.projectId;
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    if (!configToUse) {
                        console.error("Firebase config is still null after all attempts. Cannot initialize.");
                        setLoading(false);
                        return;
                    }

                    const app = firebase.initializeApp(configToUse);
                    const firestoreDb = firebase.getFirestore(app);
                    const firebaseAuth = firebase.getAuth(app);

                    setDb(firestoreDb);
                    setAuth(firebaseAuth);
                    setAppId(currentAppId);

                    console.log("Firebase initialized successfully!");

                    if (initialAuthToken) {
                        await firebase.signInWithCustomToken(firebaseAuth, initialAuthToken);
                    } else {
                        await firebase.signInAnonymously(firebaseAuth);
                    }

                    firebase.onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            setUserId(user.uid);
                            console.log("User authenticated:", user.uid);
                        } else {
                            firebase.signInAnonymously(firebaseAuth).then(anonUser => {
                                setUserId(anonUser.user.uid);
                                console.log("Signed in anonymously:", anonUser.user.uid);
                            }).catch(anonError => {
                                console.error("Error signing in anonymously:", anonError);
                            });
                        }
                        setLoading(false);
                    });

                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    setLoginError("Failed to initialize app. Please try again later. Check console for details.");
                    setLoading(false);
                }
            };

            initFirebase();
          }, []);

          useEffect(() => {
            if (!db || !userId || !appId) return; // Wait for db, userId, and appId to be ready

            const publicDataPath = `artifacts/${appId}/public/data`;
            console.log("Listening to Firestore path:", publicDataPath);

            const unsubscribeBranches = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/branches`)), (snapshot) => {
                const fetchedBranches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setBranches(fetchedBranches);
            }, (error) => console.error("Error fetching branches:", error));

            const unsubscribeUsers = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/users`)), (snapshot) => {
                const fetchedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setUsers(fetchedUsers);
                if (currentUser && fetchedUsers.some(u => u.id === currentUser.id)) {
                    setCurrentUser(fetchedUsers.find(u => u.id === currentUser.id));
                }
            }, (error) => console.error("Error fetching users:", error));

            const unsubscribePayments = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/payments`)), (snapshot) => {
                const fetchedPayments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // If month/year are stored as separate fields, parse them too if needed for logic
                    month: doc.data().month,
                    year: doc.data().year,
                }));
                fetchedPayments.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                setPayments(fetchedPayments);
            }, (error) => console.error("Error fetching payments:", error));

            const unsubscribePaymentMethods = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/paymentMethods`)), (snapshot) => {
                const fetchedPaymentMethods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setPaymentMethods(fetchedPaymentMethods);
            }, (error) => console.error("Error fetching payment methods:", error));

            // Listen for expenses
            const unsubscribeExpenses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/expenses`)), (snapshot) => {
                const fetchedExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // Ensure month/year are properly parsed as numbers
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setExpenses(fetchedExpenses);
            }, (error) => console.error("Error fetching expenses:", error));

            // Listen for bonuses
            const unsubscribeBonuses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/bonuses`)), (snapshot) => {
                const fetchedBonuses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Ensure timestamp is converted to Date object if it's a Firestore Timestamp
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    // Ensure month/year are properly parsed as numbers
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setBonuses(fetchedBonuses);
            }, (error) => console.error("Error fetching bonuses:", error));

            // Listen for organization expenses
            const unsubscribeOrganizationExpenses = firebase.onSnapshot(firebase.query(firebase.collection(db, `${publicDataPath}/organizationExpenses`)), (snapshot) => {
                const fetchedOrgExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    timestamp: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()) : null,
                    month: typeof doc.data().month === 'number' ? doc.data().month : parseInt(doc.data().month),
                    year: typeof doc.data().year === 'number' ? doc.data().year : parseInt(doc.data().year),
                }));
                setOrganizationExpenses(fetchedOrgExpenses);
            }, (error) => console.error("Error fetching organization expenses:", error));


            return () => {
                unsubscribeBranches();
                unsubscribeUsers();
                unsubscribePayments();
                unsubscribePaymentMethods();
                unsubscribeExpenses();
                unsubscribeBonuses();
                unsubscribeOrganizationExpenses();
            };
          }, [db, userId, appId, currentUser]);

          const handleLogin = (identifier, password) => {
            let user = users.find(u => u.email === identifier);

            if (!user) {
                user = users.find(u => u.employeeNumber === identifier);
            }

            // For demo purposes, any password works if user is found.
            // In a real app, you'd verify the password securely.
            if (user) {
              setIsLoggedIn(true);
              setCurrentUser(user);
              setLoginError('');
            } else {
              setLoginError(translations[language].loginError);
            }
          };

          const handleLogout = async () => {
            if (auth) {
                try {
                    await auth.signOut();
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    await firebase.signInAnonymously(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
          };

          const changeUserPassword = async (userId, newPassword) => {
              // This is a simulated password change for the demo.
              // In a real application, you would use Firebase Authentication's updatePassword
              // method, which requires the user to be recently authenticated.
              // For a true admin-initiated password reset, you'd typically use Firebase Admin SDK
              // on a backend server or a password reset email flow.
              try {
                  const userDocRef = firebase.doc(db, `artifacts/${appId}/public/data/users`, userId);
                  await firebase.updateDoc(userDocRef, {
                      simulatedPassword: newPassword, // Store a "simulated" password field
                      updatedAt: firebase.serverTimestamp(),
                  });
                  setMessage(translations.passwordChangedSuccessfully);
                  return true;
              } catch (error) {
                  console.error("Error changing simulated password:", error);
                  setMessage(translations.passwordChangeError);
                  return false;
              }
          };

          const addBranch = async (name, location) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/branches`), {
                name,
                location,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations.branchAddedSuccessfully);
            }
            catch (e) {
              console.error("Error adding document: ", e);
              setMessage("Error adding branch.");
            }
          };

          const deleteBranch = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/branches`, id));
              const usersToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/users`), firebase.where("branchId", "==", id));
              const usersSnapshot = await firebase.getDocs(usersToDeleteQuery);
              usersSnapshot.forEach(async (userDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, userDoc.id));
              });
              const paymentsToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("branchId", "==", id));
              const paymentsSnapshot = await firebase.getDocs(paymentsToDeleteQuery);
              paymentsSnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              setMessage(translations.branchDeletedSuccessfully);
            } catch (e) {
              console.error("Error removing document: ", e);
              setMessage("Error deleting branch.");
            }
          };

          const editBranch = async (id, updatedName, updatedLocation) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/branches`, id), {
                name: updatedName,
                location: updatedLocation,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.branchUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating document: ", e);
              setMessage("Error updating branch.");
            }
          };

          const addUser = async (name, email, role, branchId, targetAmount, employeeNumber, nameAr, imageUrl) => {
            try {
              const newEmployeeNumber = employeeNumber || (
                role === 'admin' ? `ADM${String(users.length + 1).padStart(3, '0')}` :
                role === 'supervisor' ? `SUP${String(users.length + 1).padStart(3, '0')}` :
                `EMP${String(users.length + 1).padStart(3, '0')}`
              );

              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/users`), {
                name,
                nameAr: nameAr || name,
                email,
                role,
                branchId: branchId || '',
                targetAmount: role === 'employee' ? parseFloat(targetAmount) : 0,
                employeeNumber: newEmployeeNumber,
                imageUrl: imageUrl || `https://placehold.co/100x100/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${name.substring(0,2).toUpperCase()}`,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations.userAddedSuccessfully);
            } catch (e) {
              console.error("Error adding user: ", e);
              setMessage("Error adding user.");
            }
          };

          const deleteUser = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, id));
              const paymentsToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("employeeId", "==", id));
              const paymentsSnapshot = await firebase.getDocs(paymentsToDeleteQuery);
              paymentsSnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              const paymentsAddedByQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/payments`), firebase.where("addedBy", "==", id));
              const paymentsAddedBySnapshot = await firebase.getDocs(paymentsAddedByQuery);
              paymentsAddedBySnapshot.forEach(async (paymentDoc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, paymentDoc.id));
              });
              // Delete associated expenses and bonuses
              const expensesToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/expenses`), firebase.where("employeeId", "==", id));
              const expensesSnapshot = await firebase.getDocs(expensesToDeleteQuery);
              expensesSnapshot.forEach(async (doc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, doc.id));
              });
              const bonusesToDeleteQuery = firebase.query(firebase.collection(db, `artifacts/${appId}/public/data/bonuses`), firebase.where("employeeId", "==", id));
              const bonusesSnapshot = await firebase.getDocs(bonusesToDeleteQuery);
              bonusesSnapshot.forEach(async (doc) => {
                  await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, doc.id));
              });

              setMessage(translations.userDeletedSuccessfully);
            } catch (e) {
              console.error("Error removing user: ", e);
              setMessage("Error deleting user.");
            }
          };

          const editUser = async (id, updatedUser) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/users`, id), {
                ...updatedUser,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.userUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating user: ", e);
              setMessage("Error updating user.");
            }
          };

          const addPayment = async (branchId, employeeId, amount, paymentMethod, addedBy) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/payments`), {
                paymentNumber: payments.length + 1,
                branchId,
                employeeId,
                amount: parseFloat(amount),
                paymentMethod,
                timestamp: firebase.serverTimestamp(),
                addedBy,
              });
              setMessage(translations.paymentAddedSuccessfully);
            } catch (e) {
              console.error("Error adding payment: ", e);
              setMessage("Error adding payment.");
            }
          };

          const editPayment = async (id, updatedPayment) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/payments`, id), {
                ...updatedPayment,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.paymentUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating payment: ", e);
              setMessage("Error updating payment.");
            }
          };

          const addPaymentMethod = async (name, nameAr, icon, color) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/paymentMethods`), {
                name,
                nameAr: nameAr || name,
                icon,
                color,
                createdAt: firebase.serverTimestamp(),
              });
              setMessage(translations.paymentMethodAddedSuccessfully);
            } catch (e) {
              console.error("Error adding payment method: ", e);
              setMessage("Error adding payment method.");
            }
          };

          const editPaymentMethod = async (id, updatedMethod) => {
            try {
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/paymentMethods`, id), {
                ...updatedMethod,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.paymentMethodUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating payment method: ", e);
              setMessage("Error updating payment method.");
            }
          };

          const deletePaymentMethod = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/paymentMethods`, id));
              setMessage(translations.paymentMethodDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting payment method: ", e);
              setMessage("Error deleting payment method.");
            }
          };

          // Firestore operations for Expenses
          const addExpense = async (employeeId, type, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/expenses`), {
                employeeId,
                type,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1), // Use specific date for month/year filtering
                month: month, // Store month (0-indexed)
                year: year, // Store full year
              });
              setMessage(translations.expenseAddedSuccessfully);
            } catch (e) {
              console.error("Error adding expense: ", e);
              setMessage("Error adding expense.");
            }
          };

          const editExpense = async (id, updatedExpense) => {
            try {
              // Ensure timestamp is updated correctly if month/year changes
              const updatedTimestamp = new Date(updatedExpense.year, updatedExpense.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, id), {
                ...updatedExpense,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.expenseUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating expense: ", e);
              setMessage("Error updating expense.");
            }
          };

          const deleteExpense = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/expenses`, id));
              setMessage(translations.expenseDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting expense: ", e);
              setMessage("Error deleting expense.");
            }
          };

          // Firestore operations for Bonuses
          const addBonus = async (employeeId, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/bonuses`), {
                employeeId,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1), // Use specific date for month/year filtering
                month: month, // Store month (0-indexed)
                year: year, // Store full year
              });
              setMessage(translations.bonusAddedSuccessfully);
            } catch (e) {
              console.error("Error adding bonus: ", e);
              setMessage("Error adding bonus.");
            }
          };

          const editBonus = async (id, updatedBonus) => {
            try {
                // Ensure timestamp is updated correctly if month/year changes
                const updatedTimestamp = new Date(updatedBonus.year, updatedBonus.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, id), {
                ...updatedBonus,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.bonusUpdatedSuccessfully);
            } catch (e) {
              console.error("Error updating bonus: ", e);
              setMessage("Error updating bonus.");
            }
          };

          const deleteBonus = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/bonuses`, id));
              setMessage(translations.bonusDeletedSuccessfully);
            } catch (e) {
              console.error("Error deleting bonus: ", e);
              setMessage("Error deleting bonus.");
            }
          };

          // Firestore operations for Organization Expenses
          const addOrganizationExpense = async (type, amount, description, month, year) => {
            try {
              await firebase.addDoc(firebase.collection(db, `artifacts/${appId}/public/data/organizationExpenses`), {
                type,
                amount: parseFloat(amount),
                description,
                timestamp: new Date(year, month, 1),
                month: month,
                year: year,
              });
              setMessage(translations.expenseAddedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error adding organization expense: ", e);
              setMessage("Error adding organization expense."); // Re-using translation
            }
          };

          const editOrganizationExpense = async (id, updatedExpense) => {
            try {
                const updatedTimestamp = new Date(updatedExpense.year, updatedExpense.month, 1);
              await firebase.updateDoc(firebase.doc(db, `artifacts/${appId}/public/data/organizationExpenses`, id), {
                ...updatedExpense,
                timestamp: updatedTimestamp,
                updatedAt: firebase.serverTimestamp(),
              });
              setMessage(translations.expenseUpdatedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error updating organization expense: ", e);
              setMessage("Error updating organization expense."); // Re-using translation
            }
          };

          const deleteOrganizationExpense = async (id) => {
            try {
              await firebase.deleteDoc(firebase.doc(db, `artifacts/${appId}/public/data/organizationExpenses`, id));
              setMessage(translations.expenseDeletedSuccessfully); // Re-using translation
            } catch (e) {
              console.error("Error deleting organization expense: ", e);
              setMessage("Error deleting organization expense."); // Re-using translation
            }
          };


          if (loading) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 text-white text-2xl">
                Loading Application...
              </div>
            );
          }

          return (
            <AppContext.Provider value={{
              isLoggedIn,
              currentUser,
              users,
              branches,
              payments,
              paymentMethods,
              expenses,
              bonuses,
              organizationExpenses, // Provide organization expenses
              handleLogin,
              handleLogout,
              changeUserPassword,
              addBranch,
              deleteBranch,
              editBranch,
              addUser,
              deleteUser,
              editUser,
              addPayment,
              editPayment,
              addPaymentMethod,
              editPaymentMethod,
              deletePaymentMethod,
              addExpense,
              editExpense,
              deleteExpense,
              addBonus,
              editBonus,
              deleteBonus,
              addOrganizationExpense, // New org expense functions
              editOrganizationExpense,
              deleteOrganizationExpense,
              setLoginError,
              loginError,
              setUsers,
              setCurrentUser,
              language,
              setLanguage,
              translations: translations[language],
              appId,
              userId,
              message,
              setMessage,
              getBranchName: (id) => {
                const branch = branches.find(b => b.id === id);
                return branch ? branch.name : 'N/A';
              },
              getPaymentMethodDetails: (methodName) => {
                const method = paymentMethods.find(pm => pm.name === methodName);
                return method ? (translations[language].language === 'ar' && method.nameAr ? method.nameAr : method.name) : methodName;
              },
              db, // Pass db for Excel upload Firestore operations
            }}>
              <div className="min-h-screen bg-gray-100 font-inter" dir={language === 'ar' ? 'rtl' : 'ltr'}>
                {isLoggedIn ? <MainLayout /> : <Login />}
              </div>
            </AppContext.Provider>
          );
        };

        // Login Component
        const Login = () => {
          const { handleLogin, loginError, translations, setMessage } = useAppContext();
          const [identifier, setIdentifier] = useState('');
          const [password, setPassword] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            handleLogin(identifier, password);
          };

          const handleRegisterClick = () => {
              setMessage(translations.registerAdminTask);
          };

          const handleForgotPasswordClick = () => {
              setMessage(translations.forgotPasswordAdminTask);
          };

          return (
            <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-400 to-purple-600 p-4">
              <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <h2 className="text-3xl font-bold mb-6 text-gray-800">{translations.loginWelcome}</h2>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div>
                    <input
                      type="text"
                      placeholder={translations.emailPlaceholder}
                      value={identifier}
                      onChange={(e) => setIdentifier(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                      required
                    />
                  </div>
                  <div>
                    <input
                      type="password"
                      placeholder={translations.passwordPlaceholder}
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                      required
                    />
                  </div>
                  {loginError && (
                    <div className="text-red-600 text-sm mt-2">{loginError}</div>
                  )}
                  <button
                    type="submit"
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 transform hover:scale-105 shadow-lg"
                  >
                    {translations.loginButton}
                  </button>
                </form>
                <div className="mt-4 flex justify-between text-sm">
                    <button
                        onClick={handleRegisterClick}
                        className="text-blue-600 hover:underline font-semibold"
                        type="button"
                    >
                        {translations.register}
                    </button>
                    <button
                        onClick={handleForgotPasswordClick}
                        className="text-blue-600 hover:underline font-semibold"
                        type="button"
                    >
                        {translations.forgotPassword}
                    </button>
                </div>
              </div>
            </div>
          );
        };

        // Main Layout component that routes based on user role
        const MainLayout = () => {
          const { currentUser, handleLogout, language, setLanguage, translations, userId, message } = useAppContext();
          const [adminPage, setAdminPage] = useState('analytics');

          if (!currentUser) {
            return <Login />;
          }

          const renderDashboard = () => {
            switch (currentUser.role) {
              case 'admin':
                return <AdminDashboard adminPage={adminPage} setAdminPage={setAdminPage} />;
              case 'supervisor':
                return <SupervisorDashboard />;
              case 'employee':
                return <EmployeeDashboard />;
              case 'partner': // New Partner Dashboard
                return <PartnerDashboard />;
              default:
                return <Login />;
            }
          };

          return (
            <div className="flex flex-col min-h-screen bg-gray-100">
              <header className="bg-white shadow-md p-4 flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">{translations.appName}</h1>
                <div className="flex items-center space-x-4">
                  <span className="text-gray-600">
                    {translations.welcome} <span className="font-semibold">{currentUser.name}</span> ({currentUser.role === 'admin' ? translations.admin : currentUser.role === 'supervisor' ? translations.supervisor : currentUser.role === 'partner' ? translations.partner : translations.employeeRole})
                  </span>
                  <span className="text-sm text-gray-500">{userId}</span>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => setLanguage('en')}
                      className={`px-3 py-1 rounded-md text-sm font-semibold ${language === 'en' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                      EN
                    </button>
                    <button
                      onClick={() => setLanguage('ar')}
                      className={`px-3 py-1 rounded-md text-sm font-semibold ${language === 'ar' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                    >
                      AR
                    </button>
                  </div>
                  <button
                    onClick={handleLogout}
                    className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-300 shadow-md"
                  >
                    {translations.logout}
                  </button>
                </div>
              </header>
              <main className="flex-grow p-6">
                {message && (
                  <div className={`mb-4 p-3 rounded-lg text-center ${message.includes('successfully') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                  </div>
                )}
                {renderDashboard()}
              </main>
            </div>
          );
        };

        // Utility function to export data to XLSX (tab-separated for Excel compatibility)
        const exportToXLSX = (data, columns, fileNamePrefix, translations, getUserDetails, getBranchName, getPaymentMethodDetails) => {
          if (data.length === 0) {
            alert(translations.noPaymentsToDownload);
            return;
          }

          const headers = columns.map(col => col.header);
          const xlsxRows = [];
          xlsxRows.push(headers.join('\t'));

          data.forEach(item => {
            const row = columns.map(col => {
              let value = '';
              if (col.render) {
                if (col.key === 'employeeId' && getUserDetails) {
                  const user = users.find(u => u.id === item.employeeId);
                  value = user ? `${user.name} (${user.employeeNumber})` : 'N/A';
                } else if (col.key === 'addedBy' && getUserDetails) {
                  const user = users.find(u => u.id === item.addedBy);
                  value = user ? `${user.name} (${user.employeeNumber})` : 'N/A';
                } else if (col.key === 'branchId' && getBranchName) {
                  value = getBranchName(item.branchId);
                } else if (col.key === 'timestamp') {
                  value = item.timestamp?.toLocaleString() || '';
                } else if (col.key === 'amount' || col.key === 'totalAmount' || col.key === 'targetAmount' || col.key === 'expenseAmount' || col.key === 'bonusAmount' || col.key === 'totalExpenses' || col.key === 'totalBonuses' || col.key === 'netIncome') {
                  value = item[col.key]?.toFixed(2) || '0.00';
                } else if (col.key === 'name') {
                  value = `${item.name} / ${item.nameAr || item.name}`;
                } else if (col.key === 'paymentMethod' && getPaymentMethodDetails) {
                  value = getPaymentMethodDetails(item.paymentMethod);
                } else if (col.key === 'methods') {
                    value = Object.entries(item.methods || {})
                        .map(([method, amount]) => `${getPaymentMethodDetails(method)}: ${amount.toFixed(2)}`)
                        .join(', ');
                } else if (col.key === 'imageUrl') {
                    value = item.imageUrl || '';
                } else if (col.key === 'type' && translations[item.type]) { // For expense types
                    value = translations[item.type];
                }
                else {
                    value = col.render(item);
                }
              } else {
                value = item[col.key];
              }
              return `"${String(value).replace(/"/g, '""')}"`;
            });
            xlsxRows.push(row.join('\t'));
          });

          const xlsxString = "\uFEFF" + xlsxRows.join('\n');
          const blob = new Blob([xlsxString], { type: 'application/vnd.ms-excel;charset=utf-8;' });
          const now = new Date();
          const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
          const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
          const fileName = `${fileNamePrefix}_${dateStr}_${timeStr}.xls`;

          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          alert(translations.paymentsDataDownloadedSuccessfully);
        };

        // Table component for reusability
        const PaginatedTable = ({
          data,
          columns,
          itemsPerPageOptions = [5, 10, 15, 20, 50],
          initialItemsPerPage = 15,
          searchPlaceholder,
          downloadXLSX,
          translations,
          getUserDetails,
          getBranchName,
          getPaymentMethodDetails,
          showFilters = false,
          branches = [],
          users = [],
          paymentMethods = [],
          onFilterChange,
          currentFilters,
          clearFilters,
          customSort = null,
          showMultiSelect = false, // New prop for multi-selection
          onMultiSelectChange = () => {}, // Callback for selected items
          selectedItems = [], // Currently selected items
          tableTheme = 'default', // New prop for table theme
          recordsPerPageSetting = 15, // New prop for admin-defined records per page
          onRecordsPerPageChange = () => {}, // Callback for changing records per page
          onDeleteSelected = () => {}, // Callback for deleting selected items
          onApplyPaymentMethodToSelected = () => {}, // Callback for applying payment method to selected
        }) => {
          const [searchTerm, setSearchTerm] = useState('');
          const [sortKey, setSortKey] = useState(null);
          const [sortDirection, setSortDirection] = useState('desc');
          const [currentPage, setCurrentPage] = useState(1);
          const [itemsPerPage, setItemsPerPage] = useState(recordsPerPageSetting); // Use admin setting
          const [showPaymentMethodDropdown, setShowPaymentMethodDropdown] = useState(false);
          const [selectedPaymentMethodForBatch, setSelectedPaymentMethodForBatch] = useState('');


          // Update itemsPerPage when recordsPerPageSetting changes from admin controls
          useEffect(() => {
            setItemsPerPage(recordsPerPageSetting);
            setCurrentPage(1); // Reset page when items per page changes
          }, [recordsPerPageSetting]);


          const filteredData = data.filter(item => {
            const matchesSearch = Object.values(item).some(value =>
              String(value).toLowerCase().includes(searchTerm.toLowerCase())
            );

            const filters = currentFilters || {};

            const matchesBranch = showFilters && filters.branchId ? item.branchId === filters.branchId : true;
            const matchesEmployee = showFilters && filters.employeeId ? item.employeeId === filters.employeeId : true;
            const matchesPaymentMethod = showFilters && filters.paymentMethod ? item.paymentMethod === filters.paymentMethod : true;

            const itemDate = item.timestamp ? new Date(item.timestamp) : null;
            let matchesDateRange = true;
            let matchesYear = true;
            let matchesMonth = true;
            let matchesDay = true;

            if (showFilters && itemDate) {
                if (filters.startDate) {
                    const start = new Date(filters.startDate);
                    start.setHours(0, 0, 0, 0);
                    matchesDateRange = matchesDateRange && (itemDate >= start);
                }
                if (filters.endDate) {
                    const end = new Date(filters.endDate);
                    end.setHours(23, 59, 59, 999);
                    matchesDateRange = matchesDateRange && (itemDate <= end);
                }
                if (filters.filterYear) {
                    matchesYear = itemDate.getFullYear() === parseInt(filters.filterYear);
                }
                if (filters.filterMonth !== undefined && filters.filterMonth !== null && filters.filterMonth !== '') {
                    matchesMonth = itemDate.getMonth() === parseInt(filters.filterMonth);
                }
                if (filters.filterDay) {
                    matchesDay = itemDate.getDate() === parseInt(filters.filterDay);
                }
            }


            return matchesSearch && matchesBranch && matchesEmployee && matchesPaymentMethod && matchesDateRange && matchesYear && matchesMonth && matchesDay;
          });

          const sortedData = [...filteredData].sort((a, b) => {
            if (!sortKey) return 0;

            if (customSort && customSort[sortKey]) {
                return customSort[sortKey](a, b, sortDirection);
            }

            let valA = a[sortKey];
            let valB = b[sortKey];

            if (sortKey === 'timestamp' && a.timestamp && b.timestamp) {
              valA = a.timestamp.getTime();
              valB = b.timestamp.getTime();
            } else if (typeof valA === 'string' && typeof valB === 'string') {
              valA = valA.toLowerCase();
              valB = valB.toLowerCase();
            }

            if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
          });

          const totalPages = Math.ceil(sortedData.length / itemsPerPage);
          const currentData = sortedData.slice(
            (currentPage - 1) * itemsPerPage,
            currentPage * itemsPerPage
          );

          const handleSort = (key) => {
            if (sortKey === key) {
              setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
            } else {
              setSortKey(key);
              setSortDirection('asc');
            }
          };

          const handlePageChange = (page) => {
            if (page > 0 && page <= totalPages) {
              setCurrentPage(page);
            }
          };

          const getSortIndicator = (key) => {
            if (sortKey === key) {
              return sortDirection === 'asc' ? ' ▲' : ' ▼';
            }
            return '';
          };

          const handleAllCheckboxChange = (e) => {
            if (e.target.checked) {
              onMultiSelectChange(currentData.map(item => item.id));
            } else {
              onMultiSelectChange([]);
            }
          };

          const handleItemCheckboxChange = (e, itemId) => {
            if (e.target.checked) {
              onMultiSelectChange([...selectedItems, itemId]);
            } else {
              onMultiSelectChange(selectedItems.filter(id => id !== itemId));
            }
          };

          const isAllSelected = currentData.length > 0 && currentData.every(item => selectedItems.includes(item.id));

          const getTableClasses = () => {
            let classes = "min-w-full bg-white";
            switch (tableTheme) {
                case 'striped':
                    classes += " [&>tbody>tr:nth-child(odd)]:bg-gray-50";
                    break;
                case 'bordered':
                    classes += " border border-gray-300 [&>th]:border-r [&>td]:border-r";
                    break;
                case 'compact':
                    classes += " [&>th]:py-2 [&>td]:py-2 text-sm";
                    break;
                default:
                    // default styling
                    break;
            }
            return classes;
          };


          const renderFilterControls = () => {
              if (!showFilters) return null;

              const getYears = () => {
                const years = new Set();
                data.forEach(item => {
                    if (item.timestamp) {
                        years.add(new Date(item.timestamp).getFullYear());
                    }
                });
                return [...years].sort((a, b) => b - a);
              };

              const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
              ];
              const days = Array.from({length: 31}, (_, i) => i + 1);

              return (
                  <div className="flex flex-wrap items-center space-x-2 mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.branchId || ''}
                          onChange={(e) => onFilterChange('branchId', e.target.value)}
                      >
                          <option value="">{translations.selectBranchFilter}</option>
                          {branches.map(branch => (
                              <option key={branch.id} value={branch.id}>{branch.name}</option>
                          ))}
                      </select>

                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.employeeId || ''}
                          onChange={(e) => onFilterChange('employeeId', e.target.value)}
                      >
                          <option value="">{translations.selectEmployeeFilter}</option>
                          {users.filter(u => u.role === 'employee').map(employee => (
                              <option key={employee.id} value={employee.id}>{employee.name}</option>
                          ))}
                      </select>

                      <select
                          className="p-2 border rounded-md"
                          value={currentFilters.paymentMethod || ''}
                          onChange={(e) => onFilterChange('paymentMethod', e.target.value)}
                      >
                          <option value="">{translations.selectPaymentMethodFilter}</option>
                          {paymentMethods.map(method => (
                              <option key={method.id} value={method.name}>{translations.language === 'ar' && method.nameAr ? method.nameAr : method.name}</option>
                          ))}
                      </select>

                      <div className="flex flex-wrap space-x-2 mt-2 md:mt-0">
                        <input
                            type="date"
                            className="p-2 border rounded-md"
                            value={currentFilters.startDate || ''}
                            onChange={(e) => onFilterChange('startDate', e.target.value)}
                            title={translations.fromDate}
                        />
                        <input
                            type="date"
                            className="p-2 border rounded-md"
                            value={currentFilters.endDate || ''}
                            onChange={(e) => onFilterChange('endDate', e.target.value)}
                            title={translations.toDate}
                        />
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterYear || ''}
                            onChange={(e) => onFilterChange('filterYear', e.target.value)}
                        >
                            <option value="">{translations.selectYear}</option>
                            {getYears().map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterMonth || ''}
                            onChange={(e) => onFilterChange('filterMonth', e.target.value)}
                        >
                            <option value="">{translations.selectMonth}</option>
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <select
                            className="p-2 border rounded-md"
                            value={currentFilters.filterDay || ''}
                            onChange={(e) => onFilterChange('filterDay', e.target.value)}
                        >
                            <option value="">{translations.selectDay}</option>
                            {days.map(day => (
                                <option key={day} value={day}>{day}</option>
                            ))}
                        </select>
                      </div>

                      <button
                          onClick={clearFilters}
                          className="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition duration-300 shadow-md"
                      >
                          {translations.clearFilters}
                      </button>
                  </div>
              );
          };


          return (
            <div className="bg-white rounded-lg shadow-lg p-6">
              <div className="flex flex-wrap justify-between items-center mb-4">
                <input
                  type="text"
                  placeholder={searchPlaceholder || translations.search + '...'}
                  value={searchTerm}
                  onChange={(e) => { setSearchTerm(e.target.value); setCurrentPage(1); }}
                  className="p-2 border border-gray-300 rounded-lg w-full md:w-auto mb-2 md:mb-0 focus:ring-blue-500 focus:border-blue-500"
                />
                <div className="flex items-center space-x-2">
                  <label htmlFor="itemsPerPage" className="text-gray-700">{translations.itemsPerPage}</label>
                  <select
                    id="itemsPerPage"
                    value={itemsPerPage}
                    onChange={(e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); onRecordsPerPageChange(Number(e.target.value)); }}
                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  >
                    {itemsPerPageOptions.map(option => (
                      <option key={option} value={option}>{option}</option>
                    ))}
                  </select>
                  {downloadXLSX && (
                    <button
                      onClick={downloadXLSX}
                      className="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600 transition duration-300 shadow-md"
                    >
                      {translations.downloadPaymentsXLSX}
                    </button>
                  )}
                </div>
              </div>

              {renderFilterControls()}

              {showMultiSelect && (
                <div className="mb-4 flex items-center space-x-4">
                  <button
                    onClick={() => onDeleteSelected(selectedItems)}
                    disabled={selectedItems.length === 0}
                    className="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {translations.deleteSelected} ({selectedItems.length})
                  </button>
                  <button
                    onClick={() => setShowPaymentMethodDropdown(!showPaymentMethodDropdown)}
                    disabled={selectedItems.length === 0}
                    className="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {translations.applyPaymentMethod}
                  </button>
                  {showPaymentMethodDropdown && (
                    <select
                      value={selectedPaymentMethodForBatch}
                      onChange={(e) => {
                        setSelectedPaymentMethodForBatch(e.target.value);
                        onApplyPaymentMethodToSelected(selectedItems, e.target.value);
                        setShowPaymentMethodDropdown(false); // Hide after selection
                        setSelectedItems([]); // Clear selection
                      }}
                      className="p-2 border rounded-md"
                    >
                      <option value="">{translations.selectPaymentMethodForSelected}</option>
                      {paymentMethods.map(method => (
                        <option key={method.id} value={method.name}>{getPaymentMethodDetails(method.name)}</option>
                      ))}
                    </select>
                  )}
                </div>
              )}

              <div className="text-gray-700 text-sm mb-2">
                {translations.total}: {filteredData.length} {translations.recordsPerPage}
              </div>

              <div className="overflow-x-auto">
                <table className={getTableClasses()}>
                  <thead>
                    <tr>
                      {showMultiSelect && (
                        <th className="px-6 py-3 border-b-2 border-gray-300 bg-gray-200 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                          <input
                            type="checkbox"
                            checked={isAllSelected}
                            onChange={handleAllCheckboxChange}
                            className="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out"
                          />
                        </th>
                      )}
                      {columns.map(col => (
                        <th
                          key={col.key}
                          onClick={col.sortable !== false ? () => handleSort(col.key) : undefined}
                          className={`px-6 py-3 border-b-2 border-gray-300 bg-gray-200 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider ${col.sortable !== false ? 'cursor-pointer hover:bg-gray-300' : ''}`}
                        >
                          {col.header} {getSortIndicator(col.key)}
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {currentData.length > 0 ? (
                      currentData.map((item, rowIndex) => (
                        <tr key={item.id || rowIndex} className="hover:bg-gray-50 border-b border-gray-200">
                          {showMultiSelect && (
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                              <input
                                type="checkbox"
                                checked={selectedItems.includes(item.id)}
                                onChange={(e) => handleItemCheckboxChange(e, item.id)}
                                className="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out"
                              />
                            </td>
                          )}
                          {columns.map(col => (
                            <td key={col.key} className="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                              {col.key === 'serialNo' ? (
                                (currentPage - 1) * itemsPerPage + rowIndex + 1
                              ) : col.render ? (
                                col.render(item)
                              ) : (
                                item[col.key]
                              )}
                            </td>
                          ))}
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan={columns.length + (showMultiSelect ? 1 : 0)} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                          {translations.noDailyPaymentData}
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              {/* Pagination Controls */}
              <div className="flex justify-between items-center mt-4">
                <button
                  onClick={() => handlePageChange(currentPage - 1)}
                  disabled={currentPage === 1}
                  className={`pagination-button ${currentPage === 1 ? 'inactive' : 'active'}`}
                >
                  {translations.previous}
                </button>
                <span className="text-gray-700">
                  Page {currentPage} of {totalPages}
                </span>
                <button
                  onClick={() => handlePageChange(currentPage + 1)}
                  disabled={currentPage === totalPages}
                  className={`pagination-button ${currentPage === totalPages ? 'inactive' : 'active'}`}
                >
                  {translations.next}
                </button>
              </div>
            </div>
          );
        };

        // Modals for Add/Edit Branch, User, Payment Method
        const Modal = ({ title, isOpen, onClose, children }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
                    <div className="relative p-8 bg-white rounded-lg shadow-xl max-w-md w-full m-4">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800">{title}</h3>
                        {children}
                        <button
                            onClick={onClose}
                            className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl"
                        >
                            &times;
                        </button>
                    </div>
                </div>
            );
        };

        // Admin Dashboard Component
        const AdminDashboard = ({ adminPage, setAdminPage }) => {
          const {
            users, branches, payments, paymentMethods, expenses, bonuses, organizationExpenses,
            addBranch, deleteBranch, editBranch,
            addUser, deleteUser, editUser, changeUserPassword,
            addPayment, editPayment,
            addPaymentMethod, editPaymentMethod, deletePaymentMethod,
            addExpense, editExpense, deleteExpense,
            addBonus, editBonus, deleteBonus,
            addOrganizationExpense, editOrganizationExpense, deleteOrganizationExpense,
            translations, appId, userId, setMessage, db
          } = useAppContext();

          const [isBranchModalOpen, setIsBranchModalOpen] = useState(false);
          const [editingBranch, setEditingBranch] = useState(null);
          const [isUserModalOpen, setIsUserModalOpen] = useState(false);
          const [editingUser, setEditingUser] = useState(null);
          const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
          const [editingPayment, setEditingPayment] = useState(null);
          const [isPaymentMethodModalOpen, setIsPaymentMethodModalOpen] = useState(false);
          const [editingPaymentMethod, setEditingPaymentMethod] = useState(null);
          const [isExpenseModalOpen, setIsExpenseModalOpen] = useState(false);
          const [currentExpense, setCurrentExpense] = useState(null);
          const [isBonusModalOpen, setIsBonusModalOpen] = useState(false);
          const [currentBonus, setCurrentBonus] = useState(null);
          const [isOrgExpenseModalOpen, setIsOrgExpenseModalOpen] = useState(false);
          const [currentOrgExpense, setCurrentOrgExpense] = useState(null);


          const [paymentFilters, setPaymentFilters] = useState({});
          const [dailySummaryDate, setDailySummaryDate] = useState(new Date().toISOString().split('T')[0]);
          const [monthlySummaryMonth, setMonthlySummaryMonth] = useState(new Date().getMonth());
          const [monthlySummaryYear, setMonthlySummaryYear] = useState(new Date().getFullYear());
          const [dailyEmployeeSummaryDate, setDailyEmployeeSummaryDate] = useState(new Date().toISOString().split('T')[0]);

          // State for Employee Financials month/year filter
          const [financialsMonth, setFinancialsMonth] = useState(new Date().getMonth());
          const [financialsYear, setFinancialsYear] = useState(new Date().getFullYear());

          // State for Organization Expenses month/year filter
          const [orgExpensesMonth, setOrgExpensesMonth] = useState(new Date().getMonth());
          const [orgExpensesYear, setOrgExpensesYear] = useState(new Date().getFullYear());

          // Admin-defined table settings
          const [adminRecordsPerPage, setAdminRecordsPerPage] = useState(15);
          const [adminTableTheme, setAdminTableTheme] = useState('default');


          const handleFilterChange = (filterKey, value) => {
              setPaymentFilters(prev => ({ ...prev, [filterKey]: value }));
          };

          const clearPaymentFilters = () => {
              setPaymentFilters({});
          };

          // Utility function to get user's name by ID
          const getUserDetails = (id) => {
            const user = users.find(u => u.id === id);
            return user ? `${user.name} (${user.employeeNumber})` : 'N/A';
          };

          const getEmployeeName = (id) => {
            const user = users.find(u => u.id === id);
            return user ? (translations.language === 'ar' && user.nameAr ? user.nameAr : user.name) : 'N/A';
          };

          // Utility function to get branch name by ID
          const getBranchName = (id) => {
            const branch = branches.find(b => b.id === id);
            return branch ? branch.name : 'N/A';
          };

          // Utility function to get payment method name by ID
          const getPaymentMethodDetails = (methodName) => {
              const method = paymentMethods.find(pm => pm.name === methodName);
              return method ? (translations.language === 'ar' && method.nameAr ? method.nameAr : method.name) : methodName;
          };

          // Columns for payments table in Admin dashboard
          const adminPaymentColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.timestamp, key: 'timestamp', render: (item) => item.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' }) || 'N/A' },
            { header: translations.branch, key: 'branchId', render: (item) => getBranchName(item.branchId) },
            { header: translations.employee, key: 'employeeId', render: (item) => getUserDetails(item.employeeId) },
            { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.method, key: 'paymentMethod', render: (item) => getPaymentMethodDetails(item.paymentMethod) },
            { header: translations.addedBy, key: 'addedBy', render: (item) => getUserDetails(item.addedBy) },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (item) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingPayment(item); setIsPaymentModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                </div>
              )
            },
          ];

          // Columns for branches table
          const branchColumns = [
            { header: translations.name, key: 'name' },
            { header: translations.location, key: 'location' },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (branch) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingBranch(branch); setIsBranchModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                  <button
                    onClick={() => { if (confirm(translations.confirmDeleteBranch)) deleteBranch(branch.id); }}
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                  >
                    {translations.delete}
                  </button>
                </div>
              )
            },
          ];

          // Columns for users table
          const userColumns = [
            { header: translations.name, key: 'name', render: (user) => `${user.name} / ${user.nameAr || user.name}` },
            { header: translations.employeeNo, key: 'employeeNumber' },
            { header: translations.emailPlaceholder, key: 'email' },
            { header: translations.role, key: 'role', render: (user) => translations[user.role] || user.role },
            { header: translations.branch, key: 'branchId', render: (user) => getBranchName(user.branchId) },
            { header: translations.target, key: 'targetAmount', render: (user) => `SAR ${user.targetAmount?.toFixed(2) || '0.00'}` },
            { header: "Image", key: "imageUrl", sortable: false, render: (user) => (user.imageUrl ? <img src={user.imageUrl} alt={user.name} className="h-10 w-10 rounded-full object-cover" /> : <div className="h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 text-xs">No Img</div>) },
            {
              header: translations.actions,
              key: 'actions',
              sortable: false,
              render: (user) => (
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditingUser(user); setIsUserModalOpen(true); }}
                    className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                  >
                    {translations.edit}
                  </button>
                  <button
                    onClick={() => { if (confirm(translations.confirmDeleteUser)) deleteUser(user.id); }}
                    className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                  >
                    {translations.delete}
                  </button>
                </div>
              )
            },
          ];

          // Columns for payment methods table
          const paymentMethodColumns = [
              { header: translations.name, key: 'name', render: (method) => `${method.name} / ${method.nameAr || method.name}` },
              { header: translations.icon, key: 'icon', render: (method) => <span style={{ fontSize: '1.5rem', color: method.color }}>{method.icon}</span>, sortable: false },
              { header: translations.color, key: 'color', render: (method) => <span className={`inline-block w-6 h-6 rounded-full`} style={{ backgroundColor: method.color }}></span>, sortable: false },
              {
                header: translations.actions,
                key: 'actions',
                sortable: false,
                render: (method) => (
                  <div className="flex space-x-2">
                    <button
                      onClick={() => { setEditingPaymentMethod(method); setIsPaymentMethodModalOpen(true); }}
                      className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition duration-300"
                    >
                      {translations.edit}
                    </button>
                    <button
                      onClick={() => { if (confirm(translations.confirmDeletePaymentMethod)) deletePaymentMethod(method.id); }}
                      className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition duration-300"
                    >
                      {translations.delete}
                    </button>
                  </div>
                )
              },
          ];

          // Function to download all data as JSON (backup)
          const downloadAllDataAsJSON = async () => {
              try {
                  const dataToExport = {
                      branches: branches.map(b => ({ ...b, createdAt: b.createdAt?.toDate().toISOString() })),
                      users: users.map(u => ({ ...u, createdAt: u.createdAt?.toDate().toISOString() })),
                      payments: payments.map(p => ({ ...p, timestamp: p.timestamp?.toISOString() })),
                      paymentMethods: paymentMethods.map(pm => ({ ...pm, createdAt: pm.createdAt?.toDate().toISOString() })),
                      expenses: expenses.map(ex => ({ ...ex, timestamp: ex.timestamp?.toDate().toISOString() })),
                      bonuses: bonuses.map(bo => ({ ...bo, timestamp: bo.timestamp?.toDate().toISOString() })),
                      organizationExpenses: organizationExpenses.map(oex => ({ ...oex, timestamp: oex.timestamp?.toDate().toISOString() })),
                  };
                  const jsonString = JSON.stringify(dataToExport, null, 2);
                  const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                  const now = new Date();
                  const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                  const timeStr = now.toTimeString().split(' ')[0].substring(0, 5).replace(/:/g, '');
                  const fileName = `shop_app_backup_${dateStr}_${timeStr}.json`;
                  const link = document.createElement('a');
                  link.href = URL.createObjectURL(blob);
                  link.setAttribute('download', fileName);
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
                  setMessage(translations.allDataBackedUpSuccessfully);
              } catch (error) {
                  console.error("Error backing up data:", error);
                  setMessage("Error backing up data.");
              }
          };

          const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
          ];

          const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


          return (
            <div className="admin-dashboard">
              <nav className="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-wrap justify-center md:justify-start gap-3">
                <button
                  onClick={() => setAdminPage('analytics')}
                  className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'analytics' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  {translations.analyticsOverview}
                </button>
                <button
                  onClick={() => setAdminPage('payments')}
                  className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'payments' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  {translations.realtimePayments}
                </button>
                {/* Grouped Management Button */}
                <div className="relative group">
                    <button
                        className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md
                            ${['branches', 'users', 'paymentMethods'].includes(adminPage) ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
                        `}
                    >
                        {translations.manageUsersBranchesPayments}
                    </button>
                    <div className="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden group-hover:block">
                        <button
                            onClick={() => setAdminPage('branches')}
                            className="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                        >
                            {translations.branchManagement}
                        </button>
                        <button
                            onClick={() => setAdminPage('users')}
                            className="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                        >
                            {translations.userManagement}
                        </button>
                        <button
                            onClick={() => setAdminPage('paymentMethods')}
                            className="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100"
                        >
                            {translations.paymentMethodsManagement}
                        </button>
                    </div>
                </div>
                <button
                    onClick={() => setAdminPage('employeeFinancials')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'employeeFinancials' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.employeeFinancials}
                </button>
                <button
                    onClick={() => setAdminPage('organizationExpenses')}
                    className={`px-4 py-2 rounded-lg font-semibold transition duration-300 shadow-md ${adminPage === 'organizationExpenses' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {translations.organizationExpenses}
                </button>
                <button
                  onClick={downloadAllDataAsJSON}
                  className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                >
                  {translations.downloadAllDataXLSX}
                </button>
              </nav>

              {/* Admin Table Settings */}
              <div className="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-wrap gap-4 items-center">
                <label htmlFor="recordsPerPage" className="text-gray-700 font-semibold">
                    {translations.recordsPerPage}
                </label>
                <select
                    id="recordsPerPage"
                    value={adminRecordsPerPage}
                    onChange={(e) => setAdminRecordsPerPage(Number(e.target.value))}
                    className="p-2 border rounded-md"
                >
                    {[5, 10, 15, 20, 50].map(option => (
                        <option key={option} value={option}>{option}</option>
                    ))}
                </select>

                <label htmlFor="tableTheme" className="text-gray-700 font-semibold">
                    {translations.selectTheme}
                </label>
                <select
                    id="tableTheme"
                    value={adminTableTheme}
                    onChange={(e) => setAdminTableTheme(e.target.value)}
                    className="p-2 border rounded-md"
                >
                    <option value="default">{translations.defaultTheme}</option>
                    <option value="striped">{translations.stripedTheme}</option>
                    <option value="bordered">{translations.borderedTheme}</option>
                    <option value="compact">{translations.compactTheme}</option>
                </select>
              </div>


              {adminPage === 'analytics' && (
                <div className="space-y-6">
                  {/* Date Filter for Analytics */}
                  <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center">
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByDay}:</h3>
                      <input
                          type="date"
                          value={dailySummaryDate}
                          onChange={(e) => {
                              setDailySummaryDate(e.target.value);
                              setDailyEmployeeSummaryDate(e.target.value);
                          }}
                          className="p-2 border rounded-md"
                      />
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByMonth}:</h3>
                      <select
                          value={monthlySummaryMonth}
                          onChange={(e) => setMonthlySummaryMonth(parseInt(e.target.value))}
                          className="p-2 border rounded-md"
                      >
                          {months.map((monthName, index) => (
                              <option key={index} value={index}>{monthName}</option>
                          ))}
                      </select>
                      <h3 className="text-xl font-semibold text-gray-800">{translations.filterByYear}:</h3>
                      <select
                          value={monthlySummaryYear}
                          onChange={(e) => setMonthlySummaryYear(parseInt(e.target.value))}
                          className="p-2 border rounded-md"
                      >
                          {years.map(year => (
                              <option key={year} value={year}>{year}</option>
                          ))}
                      </select>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Daily Employee Summary */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.dailyEmployeeSummary}</h3>
                      <DailyEmployeeSummary
                        payments={payments}
                        users={users}
                        translations={translations}
                        getEmployeeName={getEmployeeName}
                        selectedDate={dailyEmployeeSummaryDate}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                      />
                    </div>
                    {/* Daily Branches Summary */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.dailyBranchesSummary}</h3>
                      <DailyBranchesSummary
                        payments={payments}
                        branches={branches}
                        paymentMethods={paymentMethods}
                        translations={translations}
                        getBranchName={getBranchName}
                        getPaymentMethodDetails={getPaymentMethodDetails}
                        selectedDate={dailySummaryDate}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                      />
                    </div>
                    {/* Monthly Payments Summary (Renamed to Monthly Employees Income) */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.monthlyPaymentsSummary}</h3>
                      <MonthlySummaryTable
                        payments={payments}
                        users={users}
                        branches={branches}
                        paymentMethods={paymentMethods}
                        translations={translations}
                        getEmployeeName={getEmployeeName}
                        getBranchName={getBranchName}
                        getPaymentMethodDetails={getPaymentMethodDetails}
                        selectedMonth={monthlySummaryMonth}
                        selectedYear={monthlySummaryYear}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                      />
                    </div>
                    {/* Monthly Branches Income */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                      <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.monthlyBranchesIncome}</h3>
                      <MonthlyBranchesIncome
                        payments={payments}
                        branches={branches}
                        paymentMethods={paymentMethods}
                        translations={translations}
                        getBranchName={getBranchName}
                        getPaymentMethodDetails={getPaymentMethodDetails}
                        selectedMonth={monthlySummaryMonth}
                        selectedYear={monthlySummaryYear}
                        recordsPerPageSetting={adminRecordsPerPage}
                        tableTheme={adminTableTheme}
                      />
                    </div>
                  </div>
                </div>
              )}

              {adminPage === 'payments' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.realtimePayments}</h3>
                  <PaginatedTable
                    data={payments}
                    columns={adminPaymentColumns}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    downloadXLSX={() => exportToXLSX(payments, adminPaymentColumns.filter(col => col.key !== 'actions'), 'All_Payments', translations, getUserDetails, getBranchName, getPaymentMethodDetails)}
                    translations={translations}
                    getUserDetails={getUserDetails}
                    getBranchName={getBranchName}
                    getPaymentMethodDetails={getPaymentMethodDetails}
                    showFilters={true}
                    branches={branches}
                    users={users}
                    paymentMethods={paymentMethods}
                    onFilterChange={handleFilterChange}
                    currentFilters={paymentFilters}
                    recordsPerPageSetting={adminRecordsPerPage}
                    tableTheme={adminTableTheme}
                    showMultiSelect={true} // Enable multi-select for this table
                    onDeleteSelected={async (ids) => {
                        if (confirm(`Are you sure you want to delete ${ids.length} payments?`)) {
                            for (const id of ids) {
                                await deletePayment(id);
                            }
                            setMessage(`${ids.length} payments deleted successfully!`);
                            // Clear selection after deletion
                            // This is handled by the PaginatedTable component itself now
                        }
                    }}
                    onApplyPaymentMethodToSelected={async (ids, newMethod) => {
                        if (confirm(`Are you sure you want to change payment method for ${ids.length} payments to ${newMethod}?`)) {
                            for (const id of ids) {
                                await editPayment(id, { paymentMethod: newMethod });
                            }
                            setMessage(`Payment method updated for ${ids.length} payments!`);
                        }
                    }}
                  />

                    <Modal
                        title={`${translations.editPaymentModalTitle} ${editingPayment?.paymentNumber})`}
                        isOpen={isPaymentModalOpen}
                        onClose={() => { setIsPaymentModalOpen(false); setEditingPayment(null); }}
                    >
                        {editingPayment && (
                            <EditPaymentForm
                                payment={editingPayment}
                                onSave={(updated) => {
                                    editPayment(editingPayment.id, updated);
                                    setIsPaymentModalOpen(false);
                                    setEditingPayment(null);
                                }}
                                onCancel={() => { setIsPaymentModalOpen(false); setEditingPayment(null); }}
                                users={users}
                                branches={branches}
                                paymentMethods={paymentMethods}
                                translations={translations}
                                getUserDetails={getUserDetails}
                                getPaymentMethodDetails={getPaymentMethodDetails}
                            />
                        )}
                    </Modal>
                </div>
              )}

              {adminPage === 'branches' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-semibold text-gray-800">{translations.branchManagement}</h3>
                    <button
                      onClick={() => { setEditingBranch(null); setIsBranchModalOpen(true); }}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                    >
                      {translations.addBranch}
                    </button>
                  </div>
                  <PaginatedTable
                    data={branches}
                    columns={branchColumns}
                    searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                    translations={translations}
                    recordsPerPageSetting={adminRecordsPerPage}
                    tableTheme={adminTableTheme}
                  />

                  <Modal
                    title={editingBranch ? translations.editBranchModalTitle : translations.addBranchModalTitle}
                    isOpen={isBranchModalOpen}
                    onClose={() => { setIsBranchModalOpen(false); setEditingBranch(null); }}
                  >
                    <BranchForm
                      branch={editingBranch}
                      onSave={(name, location) => {
                        if (editingBranch) {
                          editBranch(editingBranch.id, name, location);
                        } else {
                          addBranch(name, location);
                        }
                        setIsBranchModalOpen(false);
                        setEditingBranch(null);
                      }}
                      onCancel={() => { setIsBranchModalOpen(false); setEditingBranch(null); }}
                      translations={translations}
                    />
                  </Modal>
                </div>
              )}

              {adminPage === 'users' && (
                <div className="bg-white p-6 rounded-lg shadow-lg">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-semibold text-gray-800">{translations.userManagement}</h3>
                    <button
                      onClick={() => { setEditingUser(null); setIsUserModalOpen(true); }}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                    >
                      {translations.addUser}
                    </button>
                  </div>
                  <PaginatedTable
                    data={users}
                    columns={userColumns}
                    searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                    translations={translations}
                    getBranchName={getBranchName}
                    recordsPerPageSetting={adminRecordsPerPage}
                    tableTheme={adminTableTheme}
                  />

                  <Modal
                    title={editingUser ? translations.editUserModalTitle : translations.addUserModalTitle}
                    isOpen={isUserModalOpen}
                    onClose={() => { setIsUserModalOpen(false); setEditingUser(null); }}
                  >
                    <UserForm
                      user={editingUser}
                      onSave={(updatedUser) => {
                        if (editingUser) {
                          editUser(editingUser.id, updatedUser);
                        } else {
                          addUser(updatedUser.name, updatedUser.email, updatedUser.role, updatedUser.branchId, updatedUser.targetAmount, updatedUser.employeeNumber, updatedUser.nameAr, updatedUser.imageUrl);
                        }
                        setIsUserModalOpen(false);
                        setEditingUser(null);
                      }}
                      onCancel={() => { setIsUserModalOpen(false); setEditingUser(null); }}
                      branches={branches}
                      translations={translations}
                      setMessage={setMessage}
                      changeUserPassword={changeUserPassword}
                    />
                  </Modal>
                </div>
              )}

              {adminPage === 'paymentMethods' && (
                  <div className="bg-white p-6 rounded-lg shadow-lg">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-semibold text-gray-800">{translations.paymentMethodsManagement}</h3>
                          <button
                              onClick={() => { setEditingPaymentMethod(null); setIsPaymentMethodModalOpen(true); }}
                              className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                          >
                              {translations.addPaymentMethod}
                          </button>
                      </div>
                      <PaginatedTable
                          data={paymentMethods}
                          columns={paymentMethodColumns}
                          searchPlaceholder={translations.search + ' ' + translations.name + '...'}
                          translations={translations}
                          recordsPerPageSetting={adminRecordsPerPage}
                          tableTheme={adminTableTheme}
                      />

                      <Modal
                          title={editingPaymentMethod ? translations.editPaymentMethodModalTitle : translations.addPaymentMethodModalTitle}
                          isOpen={isPaymentMethodModalOpen}
                          onClose={() => { setIsPaymentMethodModalOpen(false); setEditingPaymentMethod(null); }}
                      >
                          <PaymentMethodForm
                              method={editingPaymentMethod}
                              onSave={(name, nameAr, icon, color) => {
                                  if (editingPaymentMethod) {
                                      editPaymentMethod(editingPaymentMethod.id, { name, nameAr, icon, color });
                                  } else {
                                      addPaymentMethod(name, nameAr, icon, color);
                                  }
                                  setIsPaymentMethodModalOpen(false);
                                  setEditingPaymentMethod(null);
                              }}
                              onCancel={() => { setIsPaymentMethodModalOpen(false); setEditingPaymentMethod(null); }}
                              translations={translations}
                              setMessage={setMessage}
                          />
                      </Modal>
                  </div>
              )}

              {adminPage === 'employeeFinancials' && (
                  <EmployeeFinancials
                      users={users.filter(u => u.role === 'employee')}
                      expenses={expenses}
                      bonuses={bonuses}
                      addExpense={addExpense}
                      editExpense={editExpense}
                      deleteExpense={deleteExpense}
                      addBonus={addBonus}
                      editBonus={editBonus}
                      deleteBonus={deleteBonus}
                      translations={translations}
                      setMessage={setMessage}
                      selectedMonth={financialsMonth} // Pass month/year to financial controls
                      selectedYear={financialsYear}
                      setFinancialsMonth={setFinancialsMonth} // Allow changing month/year from here
                      setFinancialsYear={setFinancialsYear}
                      appId={appId} // Pass appId for Firestore operations
                      recordsPerPageSetting={adminRecordsPerPage}
                      tableTheme={adminTableTheme}
                  />
              )}

              {adminPage === 'organizationExpenses' && (
                  <OrganizationExpensesDashboard
                      payments={payments} // Pass all payments to calculate total income
                      organizationExpenses={organizationExpenses}
                      addOrganizationExpense={addOrganizationExpense}
                      editOrganizationExpense={editOrganizationExpense}
                      deleteOrganizationExpense={deleteOrganizationExpense}
                      translations={translations}
                      setMessage={setMessage}
                      appId={appId}
                      recordsPerPageSetting={adminRecordsPerPage}
                      tableTheme={adminTableTheme}
                  />
              )}
            </div>
          );
        };

        const DailySummaryTable = ({ payments, users, branches, paymentMethods, translations, getEmployeeName, getBranchName, getPaymentMethodDetails, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const employee = users.find(u => u.id === payment.employeeId);
                const branch = branches.find(b => b.id === payment.branchId);
                const key = `${payment.employeeId}-${payment.branchId}`;

                if (!acc[key]) {
                    acc[key] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const MonthlySummaryTable = ({ payments, users, branches, paymentMethods, translations, getEmployeeName, getBranchName, getPaymentMethodDetails, selectedMonth, selectedYear, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            );

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const employee = users.find(u => u.id === payment.employeeId);
                const branch = branches.find(b => b.id === payment.branchId);
                const key = `${payment.employeeId}-${payment.branchId}`;

                if (!acc[key]) {
                    acc[key] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const DailyEmployeeSummary = ({ payments, users, translations, getEmployeeName, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                if (!acc[payment.employeeId]) {
                    acc[payment.employeeId] = {
                        employeeName: getEmployeeName(payment.employeeId),
                        totalEarned: 0,
                        cash: 0,
                        madaPay: 0,
                    };
                }
                acc[payment.employeeId].totalEarned += payment.amount;
                if (payment.paymentMethod === 'Cash') {
                    acc[payment.employeeId].cash += payment.amount;
                } else if (payment.paymentMethod === 'Mada Pay') {
                    acc[payment.employeeId].madaPay += payment.amount;
                }
                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const columns = [
                { header: translations.employee, key: 'employeeName', sortable: true },
                { header: translations.totalEarned, key: 'totalEarned', render: (item) => `SAR ${item.totalEarned.toFixed(2)}`, sortable: true },
                { header: translations.cash, key: 'cash', render: (item) => `SAR ${item.cash.toFixed(2)}`, sortable: true },
                { header: translations.mada, key: 'madaPay', render: (item) => `SAR ${item.madaPay.toFixed(2)}`, sortable: true },
            ];

            const customSort = {
                employeeName: (a, b, direction) => {
                    const nameA = a.employeeName.toLowerCase();
                    const nameB = b.employeeName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                totalEarned: (a, b, direction) => direction === 'asc' ? a.totalEarned - b.totalEarned : b.totalEarned - a.totalEarned,
                cash: (a, b, direction) => direction === 'asc' ? a.cash - b.cash : b.cash - a.cash,
                madaPay: (a, b, direction) => direction === 'asc' ? a.madaPay - b.madaPay : b.madaPay - a.madaPay,
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.employee + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const DailyBranchesSummary = ({ payments, branches, paymentMethods, translations, getBranchName, getPaymentMethodDetails, selectedDate, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p => p.timestamp && p.timestamp.toISOString().split('T')[0] === selectedDate);

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const branch = branches.find(b => b.id === payment.branchId);
                const key = payment.branchId;

                if (!acc[key]) {
                    acc[key] = {
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.branchName + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };

        const MonthlyBranchesIncome = ({ payments, branches, paymentMethods, translations, getBranchName, getPaymentMethodDetails, selectedMonth, selectedYear, recordsPerPageSetting, tableTheme }) => {
            const filteredPayments = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            );

            const groupedData = filteredPayments.reduce((acc, payment) => {
                const branch = branches.find(b => b.id === payment.branchId);
                const key = payment.branchId;

                if (!acc[key]) {
                    acc[key] = {
                        branchName: getBranchName(payment.branchId),
                        methods: {},
                        total: 0
                    };
                }

                acc[key].methods[payment.paymentMethod] = (acc[key].methods[payment.paymentMethod] || 0) + payment.amount;
                acc[key].total += payment.amount;

                return acc;
            }, {});

            const tableData = Object.values(groupedData);

            const allPaymentMethods = [...new Set(filteredPayments.map(p => p.paymentMethod))].sort();

            const columns = [
                { header: translations.branchName, key: 'branchName', sortable: true },
                ...allPaymentMethods.map(methodName => ({
                    header: getPaymentMethodDetails(methodName),
                    key: methodName,
                    render: (item) => `SAR ${item.methods[methodName]?.toFixed(2) || '0.00'}`,
                    sortable: false
                })),
                { header: translations.total, key: 'total', render: (item) => `SAR ${item.total.toFixed(2)}`, sortable: true }
            ];

            const customSort = {
                branchName: (a, b, direction) => {
                    const nameA = a.branchName.toLowerCase();
                    const nameB = b.branchName.toLowerCase();
                    if (nameA < nameB) return direction === 'asc' ? -1 : 1;
                    if (nameA > nameB) return direction === 'asc' ? 1 : -1;
                    return 0;
                },
                total: (a, b, direction) => direction === 'asc' ? a.total - b.total : b.total - a.total
            };

            return (
                <PaginatedTable
                    data={tableData}
                    columns={columns}
                    translations={translations}
                    initialItemsPerPage={5}
                    searchPlaceholder={translations.search + ' ' + translations.branchName + '...'}
                    customSort={customSort}
                    recordsPerPageSetting={recordsPerPageSetting}
                    tableTheme={tableTheme}
                />
            );
        };


        const BranchForm = ({ branch, onSave, onCancel, translations }) => {
          const [name, setName] = useState(branch?.name || '');
          const [location, setLocation] = useState(branch?.location || '');
          const { setMessage } = useAppContext();

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!name.trim() || !location.trim()) {
              setMessage(translations.pleaseEnterBranchNameAndLocation);
              return;
            }
            onSave(name, location);
          };

          return (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="branchName" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name}:
                </label>
                <input
                  type="text"
                  id="branchName"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder={translations.branchNamePlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="branchLocation" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.location}:
                </label>
                <input
                  type="text"
                  id="branchLocation"
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                  placeholder={translations.branchLocationPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={onCancel}
                  className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                  {translations.cancel}
                </button>
                <button
                  type="submit"
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                >
                  {translations.saveChanges}
                </button>
              </div>
            </form>
          );
        };

        const UserForm = ({ user, onSave, onCancel, branches, translations, setMessage, changeUserPassword }) => {
          const [name, setName] = useState(user?.name || '');
          const [nameAr, setNameAr] = useState(user?.nameAr || '');
          const [email, setEmail] = useState(user?.email || '');
          const [role, setRole] = useState(user?.role || '');
          const [branchId, setBranchId] = useState(user?.branchId || '');
          const [targetAmount, setTargetAmount] = useState(user?.targetAmount || '');
          const [employeeNumber, setEmployeeNumber] = useState(user?.employeeNumber || '');
          const [imageUrl, setImageUrl] = useState(user?.imageUrl || '');
          const [newPassword, setNewPassword] = useState('');
          const [confirmPassword, setConfirmPassword] = useState('');

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!name.trim() || !email.trim() || !role.trim()) {
              setMessage(translations.pleaseFillAllUserFields);
              return;
            }
            if ((role === 'supervisor' || role === 'employee') && !branchId) {
              setMessage(translations.pleaseSelectBranchForSupervisorEmployee);
              return;
            }

            onSave({
              name,
              nameAr,
              email,
              role,
              branchId: (role === 'admin' ? '' : branchId),
              targetAmount: (role === 'employee' ? parseFloat(targetAmount) : 0),
              employeeNumber,
              imageUrl,
            });
          };

          const handlePasswordChange = async () => {
              if (!newPassword || !confirmPassword) {
                  setMessage(translations.pleaseFillAllFields);
                  return;
              }
              if (newPassword !== confirmPassword) {
                  setMessage(translations.passwordMismatch);
                  return;
              }
              if (user && user.id) {
                  const success = await changeUserPassword(user.id, newPassword);
                  if (success) {
                      setNewPassword('');
                      setConfirmPassword('');
                  }
              }
          };


          return (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="userName" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name} ({translations.en}):
                </label>
                <input
                  type="text"
                  id="userName"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder={translations.userNamePlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="userNameAr" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.name} ({translations.ar}):
                </label>
                <input
                  type="text"
                  id="userNameAr"
                  value={nameAr}
                  onChange={(e) => setNameAr(e.target.value)}
                  placeholder={translations.userNameArPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label htmlFor="userEmail" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.emailPlaceholder}:
                </label>
                <input
                  type="email"
                  id="userEmail"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder={translations.userEmailPlaceholder}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>
              <div>
                <label htmlFor="employeeNumber" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.employeeNumber}:
                </label>
                <input
                  type="text"
                  id="employeeNumber"
                  value={employeeNumber}
                  onChange={(e) => setEmployeeNumber(e.target.value)}
                  placeholder={translations.employeeNo}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div>
                <label htmlFor="userRole" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.role}:
                </label>
                <select
                  id="userRole"
                  value={role}
                  onChange={(e) => {
                    setRole(e.target.value);
                    if (e.target.value === 'admin') {
                      setBranchId('');
                      setTargetAmount('');
                    } else if (e.target.value === 'supervisor') {
                      setTargetAmount('');
                    }
                  }}
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  required
                >
                  <option value="">{translations.selectRole}</option>
                  <option value="admin">{translations.admin}</option>
                  <option value="supervisor">{translations.supervisor}</option>
                  <option value="employee">{translations.employeeRole}</option>
                  <option value="partner">{translations.partner}</option>
                </select>
              </div>
              {(role === 'supervisor' || role === 'employee') && (
                <div>
                  <label htmlFor="userBranch" className="block text-gray-700 text-sm font-bold mb-2">
                    {translations.branch}:
                  </label>
                  <select
                    id="userBranch"
                    value={branchId}
                    onChange={(e) => setBranchId(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    required
                  >
                    <option value="">{translations.selectBranch}</option>
                    {branches.map(branch => (
                      <option key={branch.id} value={branch.id}>{branch.name}</option>
                    ))}
                  </select>
                </div>
              )}
              {role === 'employee' && (
                <div>
                  <label htmlFor="targetAmount" className="block text-gray-700 text-sm font-bold mb-2">
                    {translations.targetAmountSar}:
                  </label>
                  <input
                    type="number"
                    id="targetAmount"
                    value={targetAmount}
                    onChange={(e) => setTargetAmount(e.target.value)}
                    placeholder="0.00"
                    step="0.01"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              )}
              <div>
                <label htmlFor="imageUrl" className="block text-gray-700 text-sm font-bold mb-2">
                  {translations.imageUrl}:
                </label>
                <input
                  type="text"
                  id="imageUrl"
                  value={imageUrl}
                  onChange={(e) => setImageUrl(e.target.value)}
                  placeholder="https://example.com/image.jpg"
                  className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <div className="flex justify-end space-x-3">
                <button
                  type="button"
                  onClick={onCancel}
                  className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                >
                  {translations.cancel}
                </button>
                <button
                  type="submit"
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                >
                  {translations.saveChanges}
                </button>
              </div>

              {user && (
                  <div className="border-t border-gray-200 mt-6 pt-4 space-y-3">
                      <h4 className="text-xl font-semibold text-gray-800">{translations.changePassword}</h4>
                      <div>
                          <label htmlFor="newPassword" className="block text-gray-700 text-sm font-bold mb-2">
                              {translations.enterNewPassword}:
                          </label>
                          <input
                              type="password"
                              id="newPassword"
                              value={newPassword}
                              onChange={(e) => setNewPassword(e.target.value)}
                              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                          />
                      </div>
                      <div>
                          <label htmlFor="confirmNewPassword" className="block text-gray-700 text-sm font-bold mb-2">
                              {translations.confirmNewPassword}:
                          </label>
                          <input
                              type="password"
                              id="confirmNewPassword"
                              value={confirmPassword}
                              onChange={(e) => setConfirmPassword(e.target.value)}
                              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                          />
                      </div>
                      <button
                          type="button"
                          onClick={handlePasswordChange}
                          className="w-full bg-orange-500 text-white py-2 rounded-lg font-semibold hover:bg-orange-600 transition duration-300"
                      >
                          {translations.changePassword}
                      </button>
                  </div>
              )}
            </form>
          );
        };

        const EditPaymentForm = ({ payment, onSave, onCancel, users, branches, paymentMethods, translations, getUserDetails, getPaymentMethodDetails }) => {
            const [amount, setAmount] = useState(payment?.amount || '');
            const [paymentMethod, setPaymentMethod] = useState(payment?.paymentMethod || '');
            const [employeeId, setEmployeeId] = useState(payment?.employeeId || '');
            const [branchId, setBranchId] = useState(payment?.branchId || '');
            const { setMessage } = useAppContext();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0 || !paymentMethod || !employeeId || !branchId) {
                    setMessage(translations.pleaseFillAllPaymentFields);
                    return;
                }
                onSave({
                    amount: parseFloat(amount),
                    paymentMethod,
                    employeeId,
                    branchId,
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="paymentAmount" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.paymentAmountSar}:
                        </label>
                        <input
                            type="number"
                            id="paymentAmount"
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            placeholder="0.00"
                            step="0.01"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="paymentMethod" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.paymentMethod}:
                        </label>
                        <select
                            id="paymentMethod"
                            value={paymentMethod}
                            onChange={(e) => setPaymentMethod(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectPaymentMethod}</option>
                            {paymentMethods.map(method => (
                                <option key={method.id} value={method.name}>{getPaymentMethodDetails(method.name)}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label htmlFor="paymentEmployee" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.employee}:
                        </label>
                        <select
                            id="paymentEmployee"
                            value={employeeId}
                            onChange={(e) => setEmployeeId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectEmployee}</option>
                            {users.filter(u => u.role === 'employee').map(user => (
                                <option key={user.id} value={user.id}>{getUserDetails(user.id)}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label htmlFor="paymentBranch" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.branch}:
                        </label>
                        <select
                            id="paymentBranch"
                            value={branchId}
                            onChange={(e) => setBranchId(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        >
                            <option value="">{translations.selectBranch}</option>
                            {branches.map(branch => (
                                <option key={branch.id} value={branch.id}>{branch.name}</option>
                            ))}
                        </select>
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                        >
                            {translations.cancel}
                        </button>
                        <button
                            type="submit"
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                        >
                            {translations.saveChanges}
                        </button>
                    </div>
                </form>
            );
        };

        const PaymentMethodForm = ({ method, onSave, onCancel, translations, setMessage }) => {
            const [name, setName] = useState(method?.name || '');
            const [nameAr, setNameAr] = useState(method?.nameAr || '');
            const [icon, setIcon] = useState(method?.icon || '');
            const [color, setColor] = useState(method?.color || '#000000');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!name.trim()) {
                    setMessage(translations.pleaseEnterMethodName);
                    return;
                }
                onSave(name, nameAr, icon, color);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label htmlFor="methodName" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.name} ({translations.en}):
                        </label>
                        <input
                            type="text"
                            id="methodName"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder={translations.methodNamePlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            required
                        />
                    </div>
                    <div>
                        <label htmlFor="methodNameAr" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.name} ({translations.ar}):
                        </label>
                        <input
                            type="text"
                            id="methodNameAr"
                            value={nameAr}
                            onChange={(e) => setNameAr(e.target.value)}
                            placeholder={translations.methodNameArPlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label htmlFor="methodIcon" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.icon}: (e.g., 💰, 💳, 🏦)
                        </label>
                        <input
                            type="text"
                            id="methodIcon"
                            value={icon}
                            onChange={(e) => setIcon(e.target.value)}
                            placeholder={translations.methodIconPlaceholder}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label htmlFor="methodColor" className="block text-gray-700 text-sm font-bold mb-2">
                            {translations.color}:
                        </label>
                        <input
                            type="color"
                            id="methodColor"
                            value={color}
                            onChange={(e) => setColor(e.target.value)}
                            className="w-full h-10 p-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div className="flex justify-end space-x-3">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-300"
                        >
                            {translations.cancel}
                        </button>
                        <button
                            type="submit"
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300"
                        >
                            {translations.saveChanges}
                        </button>
                    </div>
                </form>
            );
        };


        // Supervisor Dashboard Component
        const SupervisorDashboard = () => {
          const { currentUser, users, payments, paymentMethods, addPayment, translations, setMessage } = useAppContext();
          const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
          const [selectedPaymentMethod, setSelectedPaymentMethod] = useState('');
          const [paymentAmount, setPaymentAmount] = useState('');
          const [last5Payments, setLast5Payments] = useState([]);
          const [approvedFlash, setApprovedFlash] = useState(false);
          const [isNumpadOpen, setIsNumpadOpen] = useState(false);
          const [currentNumpadValue, setCurrentNumpadValue] = useState('');
          const numpadRef = useRef(null);

          const employeesInBranch = users.filter(user => user.branchId === currentUser.branchId && user.role === 'employee');

          useEffect(() => {
              if (selectedEmployeeId) {
                  const employeePayments = payments
                      .filter(p => p.employeeId === selectedEmployeeId)
                      .sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0))
                      .slice(0, 5);
                  setLast5Payments(employeePayments);
              } else {
                  setLast5Payments([]);
              }
          }, [selectedEmployeeId, payments]);

          const handleEmployeeSelect = (employeeId) => {
              setSelectedEmployeeId(employeeId);
              setSelectedPaymentMethod(''); // Reset payment method when employee changes
              setPaymentAmount(''); // Reset amount
              setIsNumpadOpen(false); // Close numpad
          };

          const handlePaymentMethodClick = (methodName, color) => {
              setSelectedPaymentMethod(methodName);
              // Flash effect
              const btn = document.querySelector(`[data-method="${methodName}"]`);
              if (btn) {
                  btn.style.transition = 'background-color 0.1s, border-color 0.1s';
                  btn.style.borderColor = 'green'; // Dark green border
                  btn.style.borderWidth = '3px';
                  setTimeout(() => {
                      btn.style.borderColor = ''; // Reset border
                      btn.style.borderWidth = '';
                  }, 500);
              }
              setCurrentNumpadValue(''); // Reset numpad value
              setIsNumpadOpen(true);
          };

          const handleNumpadConfirm = async () => {
              const amount = parseFloat(currentNumpadValue);
              if (isNaN(amount) || amount <= 0) {
                  setMessage(translations.pleaseEnterValidAmount);
                  return;
              }
              await addPayment(currentUser.branchId, selectedEmployeeId, amount, selectedPaymentMethod, currentUser.id);
              setMessage(translations.paymentAddedSuccessfully);
              setApprovedFlash(true);
              setTimeout(() => setApprovedFlash(false), 500); // Flash for 0.5 seconds

              // Reset fields after successful payment
              setSelectedEmployeeId('');
              setSelectedPaymentMethod('');
              setPaymentAmount('');
              setCurrentNumpadValue('');
              setIsNumpadOpen(false);
          };

          const handleNumpadCancel = () => {
              setCurrentNumpadValue('');
              setIsNumpadOpen(false);
              setMessage(translations.amountEntryCancelled);
          };

          const handleNumpadInput = (value) => {
              setCurrentNumpadValue(prev => {
                  if (value === '.' && prev.includes('.')) return prev;
                  if (prev === '0' && value !== '.') return value;
                  return prev + value;
              });
          };

          const handleNumpadDelete = () => {
              setCurrentNumpadValue(prev => prev.slice(0, -1));
          };


          return (
            <div className="supervisor-dashboard space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">{translations.supervisorDashboard}</h2>

              {/* Add Employee Payment Section */}
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.addEmployeePayment}</h3>
                <div className="space-y-4">
                  {/* Employee Selection */}
                  <div>
                    <label htmlFor="selectEmployee" className="block text-gray-700 text-lg font-bold mb-2">
                      {translations.selectEmployee}
                    </label>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {employeesInBranch.length > 0 ? (
                            employeesInBranch.map(employee => (
                                <div
                                    key={employee.id}
                                    onClick={() => handleEmployeeSelect(employee.id)}
                                    className={`flex flex-col items-center p-3 rounded-lg shadow-md cursor-pointer transition duration-300
                                        ${selectedEmployeeId === employee.id ? 'ring-2 ring-blue-500 bg-blue-100' : 'bg-gray-50 hover:bg-gray-100'}
                                    `}
                                >
                                    <img
                                        src={employee.imageUrl || `https://placehold.co/100x100/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${employee.name.substring(0,2).toUpperCase()}`}
                                        alt={employee.name}
                                        className="h-16 w-16 rounded-full object-cover mb-2"
                                        onError={(e) => { e.target.onerror = null; e.target.src = `https://placehold.co/100x100/cccccc/000000?text=${employee.name.substring(0,2).toUpperCase()}`; }}
                                    />
                                    <span className="text-sm font-semibold text-gray-800 text-center">{employee.name}</span>
                                </div>
                            ))
                        ) : (
                            <p className="col-span-full text-center text-gray-500">{translations.noEmployeesInBranch}</p>
                        )}
                    </div>
                  </div>

                  {selectedEmployeeId && (
                    <>
                    {/* Last 5 Payments */}
                    <div className="bg-gray-50 p-4 rounded-lg">
                        <h4 className="text-lg font-semibold text-gray-800 mb-2">{translations.last5PaymentsFor} {users.find(u => u.id === selectedEmployeeId)?.name}:</h4>
                        {last5Payments.length > 0 ? (
                            <ul className="list-disc list-inside space-y-1 text-gray-700">
                                {last5Payments.map(p => (
                                    <li key={p.id}>
                                        SAR {p.amount?.toFixed(2)} {translations.via} {paymentMethods.find(pm => pm.name === p.paymentMethod)?.name} ({p.timestamp?.toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' })})
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-gray-500 text-sm">No recent payments.</p>
                        )}
                    </div>

                    {/* Payment Method Selection */}
                    <div>
                      <label className="block text-gray-700 text-lg font-bold mb-2">
                        {translations.selectPaymentMethod} {users.find(u => u.id === selectedEmployeeId)?.name}
                      </label>
                      <div className="flex flex-wrap gap-3">
                          {paymentMethods.map(method => (
                              <button
                                  key={method.id}
                                  type="button"
                                  data-method={method.name} // For flashing effect
                                  onClick={() => handlePaymentMethodClick(method.name, method.color)}
                                  className={`flex flex-col items-center justify-center p-4 rounded-lg shadow-md transition duration-300
                                      ${selectedPaymentMethod === method.name ? 'ring-2 ring-blue-500' : 'bg-gray-100 hover:bg-gray-200'}
                                  `}
                                  style={{ backgroundColor: selectedPaymentMethod === method.name ? method.color : '' }}
                              >
                                  <span className="payment-method-icon" style={{ color: selectedPaymentMethod === method.name ? 'white' : method.color }}>{method.icon}</span>
                                  <span className={`text-lg font-semibold ${selectedPaymentMethod === method.name ? 'text-white' : 'text-gray-800'}`}>
                                      {translations.language === 'ar' && method.nameAr ? method.nameAr : method.name}
                                  </span>
                              </button>
                          ))}
                      </div>
                    </div>
                    </>
                  )}

                  {selectedPaymentMethod && isNumpadOpen && (
                      <div className="mt-4 bg-gray-50 p-6 rounded-lg shadow-inner">
                          <h4 className="text-xl font-semibold text-gray-800 mb-4">{translations.enterAmount}</h4>
                          <input
                              type="text"
                              value={`SAR ${currentNumpadValue}`}
                              readOnly
                              className="w-full p-3 border border-gray-300 rounded-lg text-2xl font-bold text-center mb-4 bg-white"
                          />
                          <div className="grid grid-cols-3 gap-2">
                              {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                                  <button key={num} onClick={() => handleNumpadInput(String(num))} className="bg-gray-200 hover:bg-gray-300 p-4 rounded-lg text-xl font-bold">
                                      {num}
                                  </button>
                              ))}
                              <button onClick={() => handleNumpadInput('0')} className="bg-gray-200 hover:bg-gray-300 p-4 rounded-lg text-xl font-bold">0</button>
                              <button onClick={() => handleNumpadInput('.')} className="bg-gray-200 hover:bg-gray-300 p-4 rounded-lg text-xl font-bold">.</button>
                              <button onClick={handleNumpadDelete} className="bg-orange-400 hover:bg-orange-500 text-white p-4 rounded-lg text-xl font-bold">DEL</button>
                          </div>
                          <div className="flex justify-between mt-4 space-x-2">
                              <button onClick={handleNumpadCancel} className="bg-red-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-600 flex-grow">
                                  {translations.cancel}
                              </button>
                              <button onClick={handleNumpadConfirm} className="bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 flex-grow">
                                  {translations.add}
                              </button>
                          </div>
                      </div>
                  )}

                  {approvedFlash && (
                      <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                          <div className="bg-white p-8 rounded-lg shadow-2xl flex flex-col items-center">
                              <i className="fas fa-check-circle text-darkgreen-700 text-6xl mb-4 animate-bounce"></i> {/* Dark green check */}
                              <p className="text-3xl font-bold text-darkgreen-800">{translations.approved}</p>
                          </div>
                      </div>
                  )}
                </div>
              </div>
            </div>
          );
        };


        // Employee Dashboard Component
        const EmployeeDashboard = () => {
          const { currentUser, payments, expenses, bonuses, translations, getPaymentMethodDetails, getBranchName } = useAppContext();

          const currentLocalDate = new Date();
          const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
          const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());

          // Filter payments for the current employee for the selected month/year
          const employeePayments = payments.filter(p =>
            p.employeeId === currentUser.id &&
            p.timestamp &&
            p.timestamp.getMonth() === selectedMonth &&
            p.timestamp.getFullYear() === selectedYear
          );

          // Filter expenses for the current employee for the selected month/year
          const employeeExpenses = expenses.filter(e =>
            e.employeeId === currentUser.id &&
            e.timestamp &&
            e.timestamp.getMonth() === selectedMonth &&
            e.timestamp.getFullYear() === selectedYear
          );

          // Filter bonuses for the current employee for the selected month/year
          const employeeBonuses = bonuses.filter(b =>
            b.employeeId === currentUser.id &&
            b.timestamp &&
            b.timestamp.getMonth() === selectedMonth &&
            b.timestamp.getFullYear() === selectedYear
          );

          // Calculate total earned for the month
          const totalEarned = employeePayments.reduce((acc, p) => acc + p.amount, 0);

          // Calculate total expenses for the month
          const totalExpenses = employeeExpenses.reduce((acc, e) => acc + e.amount, 0);

          // Calculate total bonuses for the month
          const totalBonuses = employeeBonuses.reduce((acc, b) => acc + b.amount, 0);

          // Calculate net income
          const netIncome = totalEarned + totalBonuses - totalExpenses;

          // Columns for employee payments history table (no timestamp)
          const employeePaymentColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.method, key: 'method', render: (item) => getPaymentMethodDetails(item.paymentMethod) },
          ];

          // Columns for employee expenses history table
          const employeeExpenseColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
            { header: translations.expenseAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.description, key: 'description' },
          ];

           // Columns for employee bonuses history table
           const employeeBonusColumns = [
            { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
            { header: translations.bonusAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
            { header: translations.description, key: 'description' },
          ];


          const months = [
            translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
            translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
          ];
          const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


          return (
            <div className="employee-dashboard space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">{translations.employeeDashboard}</h2>

              {/* Month/Year Selection */}
              <div className="bg-white p-6 rounded-lg shadow-lg flex flex-wrap gap-4 items-center justify-center">
                  <h3 className="text-xl font-semibold text-gray-800">{translations.selectMonthYear}:</h3>
                  <select
                      value={selectedMonth}
                      onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                      className="p-2 border rounded-md"
                  >
                      {months.map((monthName, index) => (
                          <option key={index} value={index}>{monthName}</option>
                      ))}
                  </select>
                  <select
                      value={selectedYear}
                      onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                      className="p-2 border rounded-md"
                  >
                      {years.map(year => (
                          <option key={year} value={year}>{year}</option>
                      ))}
                  </select>
              </div>

              {/* Summary Cards */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-lg shadow-md text-center">
                  <h3 className="text-xl font-semibold text-gray-800 mb-2">{translations.yourBranch}</h3>
                  <p className="text-2xl font-bold text-blue-600">{getBranchName(currentUser.branchId) || translations.mainBranch}</p>
                </div>
                <div className="bg-purple-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-purple-800 mb-2">{translations.yourTarget}</h3>
                  <p className="text-3xl font-bold text-purple-700">SAR {currentUser.targetAmount?.toFixed(2) || '0.00'}</p>
                </div>
                <div className="bg-green-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-green-800 mb-2">{translations.totalEarned}</h3>
                  <p className="text-3xl font-bold text-green-700">SAR {totalEarned.toFixed(2)}</p>
                </div>
                <div className="bg-blue-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-blue-800 mb-2">{translations.remainingToTarget}</h3>
                  <p className="text-3xl font-bold text-blue-700">SAR {(currentUser.targetAmount - totalEarned).toFixed(2)}</p>
                </div>
                <div className="bg-red-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-red-800 mb-2">{translations.totalExpenses}</h3>
                  <p className="text-3xl font-bold text-red-700">SAR {totalExpenses.toFixed(2)}</p>
                </div>
                <div className="bg-yellow-50 p-6 rounded-lg shadow-inner text-center">
                  <h3 className="text-xl font-semibold text-yellow-800 mb-2">{translations.totalBonuses}</h3>
                  <p className="text-3xl font-bold text-yellow-700">SAR {totalBonuses.toFixed(2)}</p>
                </div>
                <div className="bg-indigo-50 p-6 rounded-lg shadow-inner text-center col-span-full md:col-span-2">
                    <h3 className="text-xl font-semibold text-indigo-800 mb-2">{translations.netIncome}</h3>
                    <p className="text-4xl font-bold text-indigo-700">SAR {netIncome.toFixed(2)}</p>
                </div>
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourPaymentsHistory}</h3>
                <PaginatedTable
                  data={employeePayments}
                  columns={employeePaymentColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  getPaymentMethodDetails={getPaymentMethodDetails}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourExpensesHistory}</h3>
                <PaginatedTable
                  data={employeeExpenses}
                  columns={employeeExpenseColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>

              <div className="p-6 bg-gray-50 rounded-lg shadow-inner">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.yourBonusesHistory}</h3>
                <PaginatedTable
                  data={employeeBonuses}
                  columns={employeeBonusColumns}
                  searchPlaceholder={translations.search + '...'}
                  translations={translations}
                  currentFilters={{}}
                  onFilterChange={() => {}}
                  clearFilters={() => {}}
                />
              </div>
            </div>
          );
        };

        const EmployeeFinancials = ({ users, expenses, bonuses, addExpense, editExpense, deleteExpense, addBonus, editBonus, deleteBonus, translations, setMessage, selectedMonth, selectedYear, setFinancialsMonth, setFinancialsYear, appId }) => {
            const { db } = useAppContext();
            const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
            const [isAddEditExpenseModalOpen, setIsAddEditExpenseModalOpen] = useState(false);
            const [currentExpense, setCurrentExpense] = useState(null);
            const [isAddEditBonusModalOpen, setIsAddEditBonusModalOpen] = useState(false);
            const [currentBonus, setCurrentBonus] = useState(null);
            const fileInputRef = useRef(null);

            const filteredExpenses = expenses.filter(e =>
                (selectedEmployeeId === '' || e.employeeId === selectedEmployeeId) &&
                (e.month === selectedMonth && e.year === selectedYear)
            );
            const filteredBonuses = bonuses.filter(b =>
                (selectedEmployeeId === '' || b.employeeId === selectedEmployeeId) &&
                (b.month === selectedMonth && b.year === selectedYear)
            );

            const expenseColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
                { header: translations.employee, key: 'employeeId', render: (item) => users.find(u => u.id === item.employeeId)?.name || 'N/A', sortable: true },
                { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
                { header: translations.expenseAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (expense) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentExpense(expense); setIsAddEditExpenseModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteExpense)) deleteExpense(expense.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const bonusColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
                { header: translations.employee, key: 'employeeId', render: (item) => users.find(u => u.id === item.employeeId)?.name || 'N/A', sortable: true },
                { header: translations.bonusAmount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (bonus) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentBonus(bonus); setIsAddEditBonusModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteBonus)) deleteBonus(bonus.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const handleSaveExpense = (employeeId, type, amount, description, recordMonth, recordYear) => {
                if (currentExpense) {
                    editExpense(currentExpense.id, { employeeId, type, amount, description, month: recordMonth, year: recordYear });
                } else {
                    addExpense(employeeId, type, amount, description, recordMonth, recordYear);
                }
                setIsAddEditExpenseModalOpen(false);
                setCurrentExpense(null);
            };

            const handleSaveBonus = (employeeId, amount, description, recordMonth, recordYear) => {
                if (currentBonus) {
                    editBonus(currentBonus.id, { employeeId, amount, description, month: recordMonth, year: recordYear });
                } else {
                    addBonus(employeeId, amount, description, recordMonth, recordYear);
                }
                setIsAddEditBonusModalOpen(false);
                setCurrentBonus(null);
            };

            const handleDownloadSampleExcel = () => {
                const sampleData = [
                    ['employeeNumber', 'type', 'amount', 'description', 'month', 'year'],
                    ['EMP001', 'rental', '1500.00', 'Office rent', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP002', 'electricity', '300.50', 'Monthly electricity bill', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP001', 'bonus', '500.00', 'Performance bonus', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP003', 'loans', '1000.00', 'Salary advance', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['EMP004', 'penalties', '50.00', 'Late submission penalty', new Date().getMonth() + 1, new Date().getFullYear()],
                ];

                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Financials");
                XLSX.writeFile(wb, "EmployeeFinancials_Sample.xlsx");
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (json.length < 2) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            const headers = json[0];
                            const expectedHeaders = ['employeeNumber', 'type', 'amount', 'description', 'month', 'year'];

                            const headerCheck = expectedHeaders.every(h => headers.includes(h));
                            if (!headerCheck) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = row[index];
                                });

                                const { employeeNumber, type, amount, description, month, year } = rowData;

                                if (!employeeNumber || !type || !amount || isNaN(parseFloat(amount)) || month === undefined || year === undefined) {
                                    console.warn(`Skipping row ${i + 1} due to missing or invalid data:`, rowData);
                                    continue;
                                }

                                const employee = users.find(u => u.employeeNumber === String(employeeNumber));
                                if (!employee) {
                                    console.warn(`Skipping row ${i + 1}: Employee with number ${employeeNumber} not found.`);
                                    continue;
                                }

                                const recordMonth = parseInt(month) - 1; // Convert to 0-indexed month
                                const recordYear = parseInt(year);

                                // Check for duplicates before adding
                                const collectionPath = `artifacts/${appId}/public/data/${type === 'bonus' ? 'bonuses' : 'expenses'}`;
                                let q;
                                if (type === 'bonus') {
                                    q = firebase.query(firebase.collection(db, collectionPath),
                                        firebase.where("employeeId", "==", employee.id),
                                        firebase.where("type", "==", type), // Although type is 'bonus' for bonuses, keep for consistency if needed later
                                        firebase.where("amount", "==", parseFloat(amount)),
                                        firebase.where("description", "==", description || null),
                                        firebase.where("month", "==", recordMonth),
                                        firebase.where("year", "==", recordYear)
                                    );
                                } else { // Expenses including loans and penalties
                                     q = firebase.query(firebase.collection(db, collectionPath),
                                        firebase.where("employeeId", "==", employee.id),
                                        firebase.where("type", "==", type),
                                        firebase.where("amount", "==", parseFloat(amount)),
                                        firebase.where("description", "==", description || null),
                                        firebase.where("month", "==", recordMonth),
                                        firebase.where("year", "==", recordYear)
                                    );
                                }

                                const existingDocs = await firebase.getDocs(q);
                                if (!existingDocs.empty) {
                                    console.warn(translations.duplicateEntrySkipped, rowData);
                                    continue;
                                }


                                if (type === 'bonus') {
                                    await addBonus(employee.id, amount, description, recordMonth, recordYear);
                                } else { // Treat everything else as an expense
                                    await addExpense(employee.id, type, amount, description, recordMonth, recordYear);
                                }
                            }
                            setMessage(translations.excelUploadSuccess);
                            if (fileInputRef.current) {
                                fileInputRef.current.value = ""; // Clear the file input
                            }
                        } catch (error) {
                            console.error("Error parsing Excel file:", error);
                            setMessage(translations.excelUploadError);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };


            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


            return (
                <div className="employee-financials bg-white p-6 rounded-lg shadow-lg">
                    <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.employeeFinancials}</h3>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <label htmlFor="selectEmployeeForFinancials" className="block text-gray-700 text-lg font-bold">
                            {translations.selectEmployeeForFinancials}
                        </label>
                        <select
                            id="selectEmployeeForFinancials"
                            value={selectedEmployeeId}
                            onChange={(e) => setSelectedEmployeeId(e.target.value)}
                            className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                        >
                            <option value="">{translations.allEmployees}</option>
                            {users.map(employee => (
                                <option key={employee.id} value={employee.id}>{employee.name}</option>
                            ))}
                        </select>

                        <label htmlFor="financialsMonth" className="block text-gray-700 text-lg font-bold">
                            {translations.month}:
                        </label>
                        <select
                            id="financialsMonth"
                            value={selectedMonth}
                            onChange={(e) => setFinancialsMonth(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <label htmlFor="financialsYear" className="block text-gray-700 text-lg font-bold">
                            {translations.year}:
                        </label>
                        <select
                            id="financialsYear"
                            value={selectedYear}
                            onChange={(e) => setFinancialsYear(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <button
                            onClick={handleDownloadSampleExcel}
                            className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                        >
                            {translations.downloadSampleExcel}
                        </button>
                        <label className="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold cursor-pointer hover:bg-teal-600 transition duration-300 shadow-md">
                            {translations.uploadExcel}
                            <input
                                type="file"
                                accept=".xlsx, .xls"
                                onChange={handleFileUpload}
                                className="hidden"
                                ref={fileInputRef}
                            />
                        </label>
                    </div>

                    {selectedEmployeeId === '' ? (
                        <p className="text-gray-600 text-center text-lg p-8 bg-gray-50 rounded-lg shadow-inner">
                            {translations.noDataForSelectedPeriod}
                        </p>
                    ) : (
                        <div className="space-y-6">
                            {/* Expenses Section */}
                            <div className="border-t border-gray-200 pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="text-xl font-semibold text-gray-800">{translations.totalExpenses}</h4>
                                    <button
                                        onClick={() => { setCurrentExpense(null); setIsAddEditExpenseModalOpen(true); }}
                                        className="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-300"
                                        disabled={selectedEmployeeId === ''}
                                    >
                                        {translations.addExpense}
                                    </button>
                                </div>
                                {filteredExpenses.length > 0 ? (
                                    <PaginatedTable
                                        data={filteredExpenses}
                                        columns={expenseColumns}
                                        translations={translations}
                                        initialItemsPerPage={5}
                                        searchPlaceholder={translations.search + '...'}
                                    />
                                ) : (
                                    <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noExpenses}</p>
                                )}
                            </div>

                            {/* Bonuses Section */}
                            <div className="border-t border-gray-200 pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="text-xl font-semibold text-gray-800">{translations.totalBonuses}</h4>
                                    <button
                                        onClick={() => { setCurrentBonus(null); setIsAddEditBonusModalOpen(true); }}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300"
                                        disabled={selectedEmployeeId === ''}
                                    >
                                        {translations.addBonus}
                                    </button>
                                </div>
                                {filteredBonuses.length > 0 ? (
                                    <PaginatedTable
                                        data={filteredBonuses}
                                        columns={bonusColumns}
                                        translations={translations}
                                        initialItemsPerPage={5}
                                        searchPlaceholder={translations.search + '...'}
                                    />
                                ) : (
                                    <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noBonuses}</p>
                                )}
                            </div>

                            <AddEditExpenseModal
                                isOpen={isAddEditExpenseModalOpen}
                                onClose={() => { setIsAddEditExpenseModalOpen(false); setCurrentExpense(null); }}
                                expense={currentExpense}
                                onSave={handleSaveExpense}
                                employeeId={selectedEmployeeId}
                                translations={translations}
                                setMessage={setMessage}
                                selectedMonth={selectedMonth}
                                selectedYear={selectedYear}
                            />
                            <AddEditBonusModal
                                isOpen={isAddEditBonusModalOpen}
                                onClose={() => { setIsAddEditBonusModalOpen(false); setCurrentBonus(null); }}
                                bonus={currentBonus}
                                onSave={handleSaveBonus}
                                employeeId={selectedEmployeeId}
                                translations={translations}
                                setMessage={setMessage}
                                selectedMonth={selectedMonth}
                                selectedYear={selectedYear}
                            />
                        </div>
                    )}
                </div>
            );
        };

        const AddEditExpenseModal = ({ isOpen, onClose, expense, onSave, employeeId, translations, setMessage, selectedMonth, selectedYear }) => {
            const [type, setType] = useState(expense?.type || '');
            const [amount, setAmount] = useState(expense?.amount || '');
            const [description, setDescription] = useState(expense?.description || '');
            const [recordMonth, setRecordMonth] = useState(expense?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(expense?.year || selectedYear);


            useEffect(() => {
                if (expense) {
                    setType(expense.type);
                    setAmount(expense.amount);
                    setDescription(expense.description);
                    setRecordMonth(expense.month);
                    setRecordYear(expense.year);
                } else {
                    setType('');
                    setAmount('');
                    setDescription('');
                    // Pre-fill with current selected month/year from admin financials filter
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [expense, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type || !amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(employeeId, type, parseFloat(amount), description, recordMonth, recordYear);
            };

            const expenseTypes = [
                'rental', 'electricity', 'bill', 'tickets', 'internet', 'consumables', 'penalties', 'loans'
            ];

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);


            return (
                <Modal
                    title={expense ? translations.editExpense : translations.addExpense}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="expenseType" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseType}:
                            </label>
                            <select
                                id="expenseType"
                                value={type}
                                onChange={(e) => setType(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">{translations.selectEmployee}</option>
                                {expenseTypes.map(expType => (
                                    <option key={expType} value={expType}>{translations[expType] || expType}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="expenseAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseAmount}:
                            </label>
                            <input
                                type="number"
                                id="expenseAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="expenseDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="expenseDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="expenseMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="expenseMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="expenseYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="expenseYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const AddEditBonusModal = ({ isOpen, onClose, bonus, onSave, employeeId, translations, setMessage, selectedMonth, selectedYear }) => {
            const [amount, setAmount] = useState(bonus?.amount || '');
            const [description, setDescription] = useState(bonus?.description || '');
            const [recordMonth, setRecordMonth] = useState(bonus?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(bonus?.year || selectedYear);

            useEffect(() => {
                if (bonus) {
                    setAmount(bonus.amount);
                    setDescription(bonus.description);
                    setRecordMonth(bonus.month);
                    setRecordYear(bonus.year);
                } else {
                    setAmount('');
                    setDescription('');
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [bonus, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(employeeId, parseFloat(amount), description, recordMonth, recordYear);
            };

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <Modal
                    title={bonus ? translations.editBonus : translations.addBonus}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="bonusAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.bonusAmount}:
                            </label>
                            <input
                                type="number"
                                id="bonusAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="bonusDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="bonusDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="bonusMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="bonusMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="bonusYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="bonusYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const OrganizationExpensesDashboard = ({ payments, organizationExpenses, addOrganizationExpense, editOrganizationExpense, deleteOrganizationExpense, translations, setMessage, appId }) => {
            const { db } = useAppContext();
            const [isOrgExpenseModalOpen, setIsOrgExpenseModalOpen] = useState(false);
            const [currentOrgExpense, setCurrentOrgExpense] = useState(null);
            const fileInputRef = useRef(null);

            const currentLocalDate = new Date();
            const [selectedMonth, setSelectedMonth] = useState(currentLocalDate.getMonth());
            const [selectedYear, setSelectedYear] = useState(currentLocalDate.getFullYear());

            const filteredOrgExpenses = organizationExpenses.filter(e =>
                e.month === selectedMonth && e.year === selectedYear
            );

            const totalOrganizationExpenses = filteredOrgExpenses.reduce((acc, e) => acc + e.amount, 0);

            const totalOrganizationIncome = payments.filter(p =>
                p.timestamp &&
                p.timestamp.getMonth() === selectedMonth &&
                p.timestamp.getFullYear() === selectedYear
            ).reduce((acc, p) => acc + p.amount, 0);

            const netOrganizationResult = totalOrganizationIncome - totalOrganizationExpenses;

            const orgExpenseColumns = [
                { header: translations.serialNo, key: 'serialNo', render: (item) => null, sortable: false },
                { header: translations.expenseType, key: 'type', render: (item) => translations[item.type] || item.type },
                { header: translations.amount, key: 'amount', render: (item) => `SAR ${item.amount?.toFixed(2)}` },
                { header: translations.description, key: 'description' },
                { header: translations.month, key: 'month' },
                { header: translations.year, key: 'year' },
                {
                    header: translations.actions,
                    key: 'actions',
                    sortable: false,
                    render: (expense) => (
                        <div className="flex space-x-2">
                            <button onClick={() => { setCurrentOrgExpense(expense); setIsOrgExpenseModalOpen(true); }} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">{translations.edit}</button>
                            <button onClick={() => { if (confirm(translations.confirmDeleteExpense)) deleteOrganizationExpense(expense.id); }} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">{translations.delete}</button>
                        </div>
                    )
                }
            ];

            const handleDownloadOrgExpenseSampleExcel = () => {
                const sampleData = [
                    ['type', 'amount', 'description', 'month', 'year'],
                    ['managementTeamSalary', '10000.00', 'Monthly salaries for management', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['tools', '500.00', 'New tools purchase', new Date().getMonth() + 1, new Date().getFullYear()],
                    ['violations', '150.00', 'Parking fine', new Date().getMonth() + 1, new Date().getFullYear()],
                ];

                const ws = XLSX.utils.aoa_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "OrgExpenses");
                XLSX.writeFile(wb, "OrgExpenses_Sample.xlsx");
            };

            const handleUploadOrgExpenseExcel = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (json.length < 2) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            const headers = json[0];
                            const expectedHeaders = ['type', 'amount', 'description', 'month', 'year'];

                            const headerCheck = expectedHeaders.every(h => headers.includes(h));
                            if (!headerCheck) {
                                setMessage(translations.invalidExcelFormat);
                                return;
                            }

                            for (let i = 1; i < json.length; i++) {
                                const row = json[i];
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    rowData[header] = row[index];
                                });

                                const { type, amount, description, month, year } = rowData;

                                if (!type || !amount || isNaN(parseFloat(amount)) || month === undefined || year === undefined) {
                                    console.warn(`Skipping row ${i + 1} due to missing or invalid data:`, rowData);
                                    continue;
                                }

                                const recordMonth = parseInt(month) - 1;
                                const recordYear = parseInt(year);

                                // Check for duplicates before adding
                                const collectionPath = `artifacts/${appId}/public/data/organizationExpenses`;
                                const q = firebase.query(firebase.collection(db, collectionPath),
                                    firebase.where("type", "==", type),
                                    firebase.where("amount", "==", parseFloat(amount)),
                                    firebase.where("description", "==", description || null),
                                    firebase.where("month", "==", recordMonth),
                                    firebase.where("year", "==", recordYear)
                                );

                                const existingDocs = await firebase.getDocs(q);
                                if (!existingDocs.empty) {
                                    console.warn(translations.duplicateEntrySkipped, rowData);
                                    continue;
                                }

                                await addOrganizationExpense(type, amount, description, recordMonth, recordYear);
                            }
                            setMessage(translations.excelUploadSuccess);
                            if (fileInputRef.current) {
                                fileInputRef.current.value = "";
                            }
                        } catch (error) {
                            console.error("Error parsing Excel file:", error);
                            setMessage(translations.excelUploadError);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <div className="organization-expenses-dashboard bg-white p-6 rounded-lg shadow-lg">
                    <h3 className="text-2xl font-semibold text-gray-800 mb-4">{translations.organizationExpenses}</h3>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <label htmlFor="orgExpensesMonth" className="block text-gray-700 text-lg font-bold">
                            {translations.month}:
                        </label>
                        <select
                            id="orgExpensesMonth"
                            value={selectedMonth}
                            onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {months.map((monthName, index) => (
                                <option key={index} value={index}>{monthName}</option>
                            ))}
                        </select>
                        <label htmlFor="orgExpensesYear" className="block text-gray-700 text-lg font-bold">
                            {translations.year}:
                        </label>
                        <select
                            id="orgExpensesYear"
                            value={selectedYear}
                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                            className="p-3 border rounded-md"
                        >
                            {years.map(year => (
                                <option key={year} value={year}>{year}</option>
                            ))}
                        </select>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div className="bg-green-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-green-800 mb-2">{translations.totalOrganizationIncome}</h3>
                            <p className="text-3xl font-bold text-green-700">SAR {totalOrganizationIncome.toFixed(2)}</p>
                        </div>
                        <div className="bg-red-50 p-6 rounded-lg shadow-inner text-center">
                            <h3 className="text-xl font-semibold text-red-800 mb-2">{translations.totalOrganizationExpenses}</h3>
                            <p className="text-3xl font-bold text-red-700">SAR {totalOrganizationExpenses.toFixed(2)}</p>
                        </div>
                        <div className={`p-6 rounded-lg shadow-inner text-center ${netOrganizationResult >= 0 ? 'bg-blue-50 text-blue-800' : 'bg-orange-50 text-orange-800'}`}>
                            <h3 className="text-xl font-semibold mb-2">{translations.netOrganizationResult}</h3>
                            <p className="text-3xl font-bold">SAR {netOrganizationResult.toFixed(2)}</p>
                        </div>
                    </div>

                    <div className="mb-6 flex flex-wrap gap-4 items-center">
                        <button
                            onClick={handleDownloadOrgExpenseSampleExcel}
                            className="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-300 shadow-md"
                        >
                            {translations.downloadSampleExcel}
                        </button>
                        <label className="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold cursor-pointer hover:bg-teal-600 transition duration-300 shadow-md">
                            {translations.uploadExcel}
                            <input
                                type="file"
                                accept=".xlsx, .xls"
                                onChange={handleUploadOrgExpenseExcel}
                                className="hidden"
                                ref={fileInputRef}
                            />
                        </label>
                        <button
                            onClick={() => { setCurrentOrgExpense(null); setIsOrgExpenseModalOpen(true); }}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md"
                        >
                            {translations.addExpense}
                        </button>
                    </div>

                    {filteredOrgExpenses.length > 0 ? (
                        <PaginatedTable
                            data={filteredOrgExpenses}
                            columns={orgExpenseColumns}
                            translations={translations}
                            initialItemsPerPage={5}
                            searchPlaceholder={translations.search + '...'}
                        />
                    ) : (
                        <p className="text-gray-600 text-center p-4 bg-gray-50 rounded-lg">{translations.noExpenses}</p>
                    )}

                    <AddEditOrgExpenseModal
                        isOpen={isOrgExpenseModalOpen}
                        onClose={() => { setIsOrgExpenseModalOpen(false); setCurrentOrgExpense(null); }}
                        expense={currentOrgExpense}
                        onSave={(type, amount, description, recordMonth, recordYear) => {
                            if (currentOrgExpense) {
                                editOrganizationExpense(currentOrgExpense.id, { type, amount, description, month: recordMonth, year: recordYear });
                            } else {
                                addOrganizationExpense(type, amount, description, recordMonth, recordYear);
                            }
                            setIsOrgExpenseModalOpen(false);
                            setCurrentOrgExpense(null);
                        }}
                        translations={translations}
                        setMessage={setMessage}
                        selectedMonth={selectedMonth}
                        selectedYear={selectedYear}
                    />
                </div>
            );
        };

        const AddEditOrgExpenseModal = ({ isOpen, onClose, expense, onSave, translations, setMessage, selectedMonth, selectedYear }) => {
            const [type, setType] = useState(expense?.type || '');
            const [amount, setAmount] = useState(expense?.amount || '');
            const [description, setDescription] = useState(expense?.description || '');
            const [recordMonth, setRecordMonth] = useState(expense?.month || selectedMonth);
            const [recordYear, setRecordYear] = useState(expense?.year || selectedYear);

            useEffect(() => {
                if (expense) {
                    setType(expense.type);
                    setAmount(expense.amount);
                    setDescription(expense.description);
                    setRecordMonth(expense.month);
                    setRecordYear(expense.year);
                } else {
                    setType('');
                    setAmount('');
                    setDescription('');
                    setRecordMonth(selectedMonth);
                    setRecordYear(selectedYear);
                }
            }, [expense, selectedMonth, selectedYear]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!type || !amount || isNaN(amount) || parseFloat(amount) <= 0 || recordMonth === undefined || recordYear === undefined) {
                    setMessage(translations.pleaseEnterAllFields);
                    return;
                }
                onSave(type, parseFloat(amount), description, recordMonth, recordYear);
            };

            const expenseTypes = [
                'managementTeamSalary', 'tools', 'equipment', 'insurance', 'violations', 'bankLoans',
                'internet', 'maintenance', 'newInstallations', 'financing', 'profitForPartners'
            ];

            const months = [
                translations.jan, translations.feb, translations.mar, translations.apr, translations.may, translations.jun,
                translations.jul, translations.aug, translations.sep, translations.oct, translations.nov, translations.dec
            ];
            const years = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);

            return (
                <Modal
                    title={expense ? translations.editExpense : translations.addExpense}
                    isOpen={isOpen}
                    onClose={onClose}
                >
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label htmlFor="orgExpenseType" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseType}:
                            </label>
                            <select
                                id="orgExpenseType"
                                value={type}
                                onChange={(e) => setType(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">{translations.selectEmployee}</option>
                                {expenseTypes.map(expType => (
                                    <option key={expType} value={expType}>{translations[expType] || expType}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="orgExpenseAmount" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.expenseAmount}:
                            </label>
                            <input
                                type="number"
                                id="orgExpenseAmount"
                                value={amount}
                                onChange={(e) => setAmount(e.target.value)}
                                placeholder="0.00"
                                step="0.01"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                required
                            />
                        </div>
                        <div>
                            <label htmlFor="orgExpenseDescription" className="block text-gray-700 text-sm font-bold mb-2">
                                {translations.description}:
                            </label>
                            <textarea
                                id="orgExpenseDescription"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder={translations.description}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            ></textarea>
                        </div>
                        <div className="flex flex-wrap gap-2 items-center">
                            <label htmlFor="orgExpenseMonth" className="block text-gray-700 text-sm font-bold">
                                {translations.month}:
                            </label>
                            <select
                                id="orgExpenseMonth"
                                value={recordMonth}
                                onChange={(e) => setRecordMonth(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {months.map((monthName, index) => (
                                    <option key={index} value={index}>{monthName}</option>
                                ))}
                            </select>
                            <label htmlFor="orgExpenseYear" className="block text-gray-700 text-sm font-bold">
                                {translations.year}:
                            </label>
                            <select
                                id="orgExpenseYear"
                                value={recordYear}
                                onChange={(e) => setRecordYear(parseInt(e.target.value))}
                                className="p-2 border rounded-md"
                                required
                            >
                                {years.map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex justify-end space-x-3">
                            <button
                                type="button"
                                onClick={onClose}
                                className="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-400"
                            >
                                {translations.cancel}
                            </button>
                            <button
                                type="submit"
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700"
                            >
                                {translations.saveChanges}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };


        // Render the App component into the root div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
